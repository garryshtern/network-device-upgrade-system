---
# Critical Gap #5: Metamako MOS Ultra-Low Latency Testing
# Business Impact: HFT trading environment - microsecond latency critical
# Risk: Production failures in latency-sensitive financial systems
dependency:
  name: galaxy
  options:
    requirements-file: ${PWD}/ansible-content/collections/requirements.yml

driver:
  name: docker

platforms:
  - name: metamako-test-instance
    image: python:3.13-slim
    pre_build_image: true
    volumes:
      - ${PWD}:/opt/network-upgrade:rw
    working_dir: /opt/network-upgrade
    command: sleep infinity
    capabilities:
      - NET_ADMIN
      - SYS_TIME
    privileged: true

provisioner:
  name: ansible
  config_options:
    defaults:
      host_key_checking: false
      stdout_callback: yaml
  inventory:
    host_vars:
      metamako-test-instance:
        # Mock Metamako device characteristics
        ansible_network_os: metamako.mos
        ansible_connection: local
        platform: "metamako"
        target_firmware_version: "2.1.3"
        current_firmware_version: "2.0.8"

        # HFT-specific critical variables
        metamako_maintain_latency: true
        metamako_max_latency_deviation_ns: 50
        metamako_latency_baseline_required: true
        metamako_time_sync_required: true
        metamako_ptp_validation: true
        metamako_clock_tolerance_us: 1

        # Performance validation thresholds (HFT requirements)
        max_acceptable_latency_ns: 500
        min_throughput_gbps: 10.0
        max_jitter_ns: 25
        max_packet_loss_ppm: 0.1

        # Mock device facts for ultra-low latency switch
        ansible_facts:
          net_hostname: "test-metamako-hft-01"
          net_model: "MetaConnect-48"
          net_serialnum: "MK2345HFT001"
          net_version: "2.0.8"
          net_image: "/boot/metamakoos-2.0.8.tar.gz"

        # Metamako-specific test variables
        metawatch_enabled: true
        metamux_enabled: true
        timing_references_available: ["ptp", "gps", "external"]
        optical_interfaces_count: 48
        device_temperature: 45.2
        optics_temperature: 52.1

        # Mock upgrade paths
        upgrade_scenarios:
          - name: "minor_version_upgrade"
            from: "2.0.8"
            to: "2.0.9"
            reboot_required: false
          - name: "major_version_upgrade"
            from: "2.0.8"
            to: "2.1.3"
            reboot_required: true
          - name: "emergency_rollback"
            from: "2.1.3"
            to: "2.0.8"
            rollback: true

verifier:
  name: ansible

scenario:
  test_sequence:
    - dependency
    - cleanup
    - destroy
    - syntax
    - create
    - prepare
    - converge
    - idempotence
    - side_effect
    - verify
    - cleanup
    - destroy
