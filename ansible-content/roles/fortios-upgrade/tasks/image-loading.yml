---
# Image Loading for FortiOS Devices
# Securely transfers firmware images from server to device
# SECURITY: Uses server-initiated PUSH transfers when possible
# NOTE: Core transfer logic refactored to common/tasks/secure-file-transfer.yml

# NOTE: Storage space validation already performed in STEP 3 of main-upgrade-workflow
# No need to re-check here - STEP 3 ensures sufficient space before calling this task

# IMPORTANT: local_firmware_path MUST point to a file following MANDATORY naming:
# Pattern: FGT_*-v{version}-build*-FORTINET.out
# Example: FGT_VM64_KVM-v7.2.5-build1517-FORTINET.out
# See: docs/firmware-naming-standards.md

- name: Execute platform-specific FortiOS firmware transfer
  ansible.builtin.include_role:
    name: common
    tasks_from: secure-file-transfer
  vars:
    transfer_handler_task: fortios-firmware-transfer.yml
    local_file_path: "{{ local_firmware_path }}"

- name: Log loading completion
  ansible.builtin.debug:
    msg:
      - "Secure FortiOS Image Loading Completed:"
      - "- Target Version: {{ fortios_upgrade_state.target_version }}"
      - "- Transfer Method: {{ transfer_result.method if transfer_result.method is defined else 'Server-Initiated PUSH' }}"
      - "- File Size: {{ file_size_mb }}MB"
      - "- Integrity: {{ transferred_file_hash if transferred_file_hash is defined else 'not_verified' }}"
      - "- Security: PUSH transfer from server (HIGH SECURITY)"
      - "- Status: Ready for Installation"
