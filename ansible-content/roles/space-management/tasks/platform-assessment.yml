---
# Platform-Agnostic Storage Assessment and Cleanup
# Consolidates logic from platform-specific assessment files
# Uses platform-specific variables for commands, parsing, and paths

- name: Get initial storage information from device
  ansible.builtin.include_tasks: get-storage-output.yml

- name: Debug actual device storage output
  ansible.builtin.debug:
    msg:
      - "=== Storage Output Debug ==="
      - "Platform: {{ platform }}"
      - "Inventory hostname: {{ inventory_hostname }}"
      - "Check mode: {{ ansible_check_mode }}"
      - "storage_output type: {{ storage_output | type_debug }}"
      - "storage_output keys: {{ storage_output.keys() | list }}"
      - "storage_output.stdout exists: {{ storage_output.stdout is defined }}"
      - "storage_output.stdout_lines exists: {{ storage_output.stdout_lines is defined }}"
      - "FULL storage_output dump: {{ storage_output | to_nice_json }}"
  when: storage_output is defined

- name: Parse storage information
  ansible.builtin.include_tasks: parse-storage-output.yml

- name: Calculate initial storage metrics
  ansible.builtin.set_fact:
    storage_info:
      total_space_gb: "{{ (parsed_storage.total_bytes / 1024 / 1024 / 1024) | round(2) }}"
      free_space_gb: "{{ (parsed_storage.free_bytes / 1024 / 1024 / 1024) | round(2) }}"
      images_found: "{{ parsed_storage.images }}"
      cleanup_candidates: "{{ parsed_storage.images }}"

- name: Check if cleanup is needed
  ansible.builtin.set_fact:
    cleanup_needed: "{{ storage_info.free_space_gb < (minimum_free_space_gb | float) }}"

- name: Storage cleanup block
  when: cleanup_needed
  block:
    - name: Get current running image (platform-specific)
      block:
        - name: Get NX-OS running image
          cisco.nxos.nxos_command:
            commands:
              - show version | include image
          register: running_image_result
          changed_when: false
          when: platform == 'nxos'

        - name: Get IOS-XE running image
          cisco.ios.ios_command:
            commands:
              - show version | include System image
          register: running_image_result
          changed_when: false
          when: platform == 'ios'

        - name: Get Metamako running image
          ansible.netcommon.cli_command:
            command: "show version | grep Image"
          register: running_image_result
          changed_when: false
          when: platform == 'metamako_mos'

        - name: Skip running image detection for FortiOS and Opengear
          ansible.builtin.set_fact:
            running_image_result:
              stdout:
                - "N/A"
          when: platform in ['fortios', 'opengear']
      when:
        - not ansible_check_mode
        - inventory_hostname != 'localhost'

    - name: Simulate running image for check mode or localhost
      ansible.builtin.set_fact:
        running_image_result:
          stdout:
            - "system image file is: bootflash:///test-image.bin"
          rc: 0
      when: ansible_check_mode or inventory_hostname == 'localhost'

    - name: Parse running image filename (platform-specific)
      ansible.builtin.set_fact:
        running_image_file: "{{ running_image_parsers[platform] }}"
      vars:
        running_image_parsers:
          nxos: "{{ running_image_result.stdout[0] | regex_search('bootflash:///(.+\\.(bin|img))', '\\1') | first }}"
          ios: "{{ running_image_result.stdout[0] | regex_search('System image file is \"bootflash:/(.+\\.bin)\"', '\\1') | first }}"
          metamako_mos: "{{ running_image_result.stdout | regex_search('Image:\\s+(.+\\.(iso|swix))', '\\1') | first }}"
          fortios: ""
          opengear: ""
      when: running_image_result.stdout[0] is defined

    - name: Identify obsolete images for cleanup
      ansible.builtin.set_fact:
        cleanup_candidates: "{{ parsed_storage.images | difference([running_image_file]) | list }}"

    - name: Remove obsolete image files (platform-specific)
      block:
        - name: Remove NX-OS obsolete images
          cisco.nxos.nxos_command:
            commands:
              - "delete bootflash:{{ item }} no-prompt"
          loop: "{{ cleanup_candidates }}"
          when:
            - platform == 'nxos'
            - preserve_current_image
            - item != running_image_file
            - cleanup_candidates | length > 0
          register: cleanup_result
          failed_when: false

        - name: Remove IOS-XE obsolete images
          cisco.ios.ios_command:
            commands:
              - "delete /force bootflash:/{{ item }}"
          loop: "{{ cleanup_candidates }}"
          when:
            - platform == 'ios'
            - preserve_current_image
            - item != running_image_file
            - cleanup_candidates | length > 0
          register: cleanup_result
          failed_when: false

        - name: Remove Metamako obsolete images
          ansible.netcommon.cli_command:
            command: "rm /data/{{ item }}"
          loop: "{{ cleanup_candidates }}"
          when:
            - platform == 'metamako_mos'
            - preserve_current_image
            - item != running_image_file
            - cleanup_candidates | length > 0
          register: cleanup_result
          failed_when: false
      when:
        - not ansible_check_mode
        - inventory_hostname != 'localhost'

    - name: Log cleanup actions
      ansible.builtin.debug:
        msg: "Removed {{ cleanup_result.results | selectattr('changed', 'equalto', true) | list | length }} obsolete image(s)"
      when: cleanup_result is defined

    - name: Re-assess storage after cleanup
      ansible.builtin.include_tasks: get-storage-output.yml

    - name: Re-parse storage information after cleanup
      ansible.builtin.include_tasks: parse-storage-output.yml

    - name: Update final storage info with post-cleanup metrics
      ansible.builtin.set_fact:
        storage_info: "{{ storage_info | combine({'free_space_gb': parsed_storage.free_bytes / 1024 / 1024 / 1024 | round(2)}) }}"
        storage_cleanup_performed: true
      when: parsed_storage is defined
