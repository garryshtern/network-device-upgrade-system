---
# FortiOS Storage Assessment

- name: Get FortiOS system status
  fortinet.fortios.fortios_facts:
    vdom: "{{ vdom | default('root') }}"
    gather_subset:
      - fact: 'system_status'
  register: fortios_status
  when: not ansible_check_mode

- name: Simulate FortiOS system status in check mode
  ansible.builtin.set_fact:
    fortios_status:
      ansible_facts:
        ansible_network_resources:
          system_status:
            disk_usage: 45
            memory_usage: 60
  when: ansible_check_mode

- name: Get disk usage information
  fortinet.fortios.fortios_configuration_fact:
    vdom: "{{ vdom | default('root') }}"
    selector: 'system_storage'
  register: fortios_storage_info
  when: not ansible_check_mode

- name: Simulate FortiOS storage info in check mode
  ansible.builtin.set_fact:
    fortios_storage_info:
      meta:
        results:
          available_space: 5120
          total_space: 10240
  when: ansible_check_mode

- name: Get firmware information
  fortinet.fortios.fortios_configuration_fact:
    vdom: "{{ vdom | default('root') }}"
    selector: 'system_firmware'
  register: fortios_firmware_info
  when: not ansible_check_mode

- name: Simulate FortiOS firmware info in check mode
  ansible.builtin.set_fact:
    fortios_firmware_info:
      meta:
        results:
          - filename: "FGT_VM64-v6.4.8-build1914-FORTINET.out"
          - filename: "FGT_VM64-v7.0.12-build0523-FORTINET.out"
  when: ansible_check_mode

- name: Parse storage and firmware information
  ansible.builtin.set_fact:
    fortios_total_mb: >
      "{{ fortios_storage_info.meta.results.total_disk | default(8192) }}"
    fortios_used_mb: >
      "{{ fortios_storage_info.meta.results.used_disk | default(2048) }}"
    fortios_free_mb: "{{ fortios_total_mb - fortios_used_mb }}"
    fortios_firmware_list: >-
      {{ fortios_firmware_info.meta.results |
        map(attribute='filename') | list }}

- name: Calculate storage metrics
  ansible.builtin.set_fact:
    storage_info: >-
      {{ storage_info | combine({

        'total_space_gb': (fortios_total_mb / 1024) | round(2),
        'free_space_gb': (fortios_free_mb / 1024) | round(2),
        'images_found': fortios_firmware_list,
        'cleanup_candidates': fortios_firmware_list
      }) }}
