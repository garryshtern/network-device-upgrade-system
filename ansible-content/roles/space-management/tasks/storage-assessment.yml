---
# Storage Assessment Tasks
# Cross-platform storage space assessment

- name: Gather device platform information
  ansible.builtin.setup:
    gather_subset: ["!all", "!min", "network"]
  when: ansible_network_os is not defined

- name: Initialize storage assessment variables
  ansible.builtin.set_fact:
    storage_info:
      platform: "{{ ansible_network_os | default('unknown') }}"
      total_space_gb: 0
      free_space_gb: 0
      used_space_gb: 0
      images_found: []
      cleanup_candidates: []

- name: Platform-specific storage assessment
  ansible.builtin.include_tasks: "{{ storage_info.platform }}-assessment.yml"
  when: storage_info.platform != 'unknown'

- name: Generic storage assessment fallback
  ansible.builtin.include_tasks: generic-assessment.yml
  when: storage_info.platform == 'unknown'

- name: Calculate storage metrics
  ansible.builtin.set_fact:
    storage_info: >-
      {{ storage_info | combine({
        'used_space_gb': storage_info.total_space_gb
          - storage_info.free_space_gb,
        'usage_percentage': ((storage_info.total_space_gb
          - storage_info.free_space_gb) / storage_info.total_space_gb * 100)
          | round(1)
      }) }}
  when: storage_info.total_space_gb > 0
