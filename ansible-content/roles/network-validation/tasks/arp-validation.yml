---
# ARP and MAC Table Validation
# Validates ARP and MAC data availability
# Uses raw baseline data from network-resources-gathering
# DESIGN: Single block pattern with platform gate
#
# DATA SOURCES (raw baseline data from network-resources-gathering):
# - ARP data: network_baseline.arp_data
# - MAC data: network_baseline.mac_data
#
# FEATURES:
# - ARP data availability validation
# - MAC data availability validation

- name: NX-OS ARP and MAC Validation (uses raw baseline data from network-resources-gathering)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
    - network_baseline is defined
  block:
    - name: Use raw ARP and MAC baseline data
      ansible.builtin.set_fact:
        arp_data_available: "{{ network_baseline.arp_data | length > 0 if network_baseline.arp_data is defined else false }}"
        mac_data_available: "{{ network_baseline.mac_data | length > 0 if network_baseline.mac_data is defined else false }}"

    - name: Display ARP-MAC validation
      ansible.builtin.debug:
        msg:
          - "=== ARP and MAC Table Validation ==="
          - "ARP Data Available: {{ arp_data_available }}"
          - "MAC Data Available: {{ mac_data_available }}"
      when: show_debug | bool
- name: Store ARP baseline (NX-OS)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
  ansible.builtin.set_fact:
    arp_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      arp_data_available: "{{ arp_data_available if arp_data_available is defined else false }}"
      mac_data_available: "{{ mac_data_available if mac_data_available is defined else false }}"

- name: Store ARP baseline for check mode
  when:
    - ansible_check_mode
  ansible.builtin.set_fact:
    arp_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      arp_data_available: false
      mac_data_available: false

- name: ARP validation summary
  ansible.builtin.debug:
    msg:
      - "=== ARP and MAC Table Validation Results ==="
      - "ARP Data Available: {{ arp_baseline.arp_data_available }}"
      - "MAC Data Available: {{ arp_baseline.mac_data_available }}"
      - "Overall Status: {{ 'DATA COLLECTED' if arp_baseline.arp_data_available or arp_baseline.mac_data_available else 'NO DATA' }}"
      - "============================================"

- name: IOS-XE ARP Validation (placeholder for future implementation)
  when:
    - platform == 'ios'
    - not ansible_check_mode
  block:
    - name: Get ARP information (IOS-XE)
      cisco.ios.ios_command:
        commands:
          - show ip arp
          - show arp summary
      register: ios_arp_info

    - name: Store IOS-XE ARP baseline (placeholder)
      ansible.builtin.set_fact:
        arp_baseline:
          timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
          total_arp_entries: 0
          platform: "ios"
          raw_output: "{{ ios_arp_info.stdout }}"

# Compare ARP and MAC data against pre-upgrade baseline (post-upgrade only)
- name: Compare ARP and MAC data (post-upgrade validation)
  when:
    - validation_phase is defined
    - validation_phase == 'post_upgrade'
    - network_baseline_pre is defined
    - network_baseline_post is defined
    - network_baseline_pre.arp_data is defined
    - network_baseline_post.arp_data is defined
  block:
    # ARP Data Comparison
    - name: Normalize ARP pre-upgrade data for comparison
      ansible.builtin.include_tasks: normalize-baseline-data.yml
      vars:
        data_to_normalize: "{{ network_baseline_pre.arp_data }}"
        fields_to_exclude: "{{ baseline_comparison_excluded_fields.arp_data }}"

    - name: Store normalized ARP pre data
      ansible.builtin.set_fact:
        arp_pre_normalized: "{{ normalized_data }}"

    - name: Normalize ARP post-upgrade data for comparison
      ansible.builtin.include_tasks: normalize-baseline-data.yml
      vars:
        data_to_normalize: "{{ network_baseline_post.arp_data }}"
        fields_to_exclude: "{{ baseline_comparison_excluded_fields.arp_data }}"

    - name: Calculate ARP deltas (added/removed)
      ansible.builtin.set_fact:
        arp_post_normalized: "{{ normalized_data }}"
        arp_added: "{{ normalized_data | difference(arp_pre_normalized) }}"
        arp_removed: "{{ arp_pre_normalized | difference(normalized_data) }}"

    - name: Report ARP comparison results
      ansible.builtin.debug:
        msg:
          - "=== ARP Data Comparison ==="
          - "Pre-upgrade entries: {{ network_baseline_pre.arp_data | length }}"
          - "Post-upgrade entries: {{ network_baseline_post.arp_data | length }}"
          - "Match: {{ arp_pre_normalized == arp_post_normalized }}"
          - "Added entries: {{ arp_added | length }}"
          - "Removed entries: {{ arp_removed | length }}"
      when: show_debug | bool

    # MAC Data Comparison
    - name: Normalize MAC pre-upgrade data for comparison
      ansible.builtin.include_tasks: normalize-baseline-data.yml
      vars:
        data_to_normalize: "{{ network_baseline_pre.mac_data }}"
        fields_to_exclude: "{{ baseline_comparison_excluded_fields.mac_data }}"

    - name: Store normalized MAC pre data
      ansible.builtin.set_fact:
        mac_pre_normalized: "{{ normalized_data }}"

    - name: Normalize MAC post-upgrade data for comparison
      ansible.builtin.include_tasks: normalize-baseline-data.yml
      vars:
        data_to_normalize: "{{ network_baseline_post.mac_data }}"
        fields_to_exclude: "{{ baseline_comparison_excluded_fields.mac_data }}"

    - name: Calculate MAC deltas (added/removed)
      ansible.builtin.set_fact:
        mac_post_normalized: "{{ normalized_data }}"
        mac_added: "{{ normalized_data | difference(mac_pre_normalized) }}"
        mac_removed: "{{ mac_pre_normalized | difference(normalized_data) }}"

    - name: Report MAC comparison results
      ansible.builtin.debug:
        msg:
          - "=== MAC Data Comparison ==="
          - "Pre-upgrade entries: {{ network_baseline_pre.mac_data | length }}"
          - "Post-upgrade entries: {{ network_baseline_post.mac_data | length }}"
          - "Match: {{ mac_pre_normalized == mac_post_normalized }}"
          - "Added entries: {{ mac_added | length }}"
          - "Removed entries: {{ mac_removed | length }}"
      when: show_debug | bool
