---
# ARP and MAC Data Validation
# Compares entire arp_data and mac_data (arp_data normalized, mac_data raw)
# Validates all ARP and MAC state before operational state validation
#
# DESIGN: Extract complete arp_data and mac_data dicts from baseline data, normalize arp_data, compare, report deltas
# DATA SOURCES:
# - ARP data: network_baseline.arp_data (normalized for comparison)
# - MAC data: network_baseline.mac_data (raw comparison)
# - Pre-upgrade baseline: network_baseline_pre
# - Post-upgrade baseline: network_baseline_post

# Post-upgrade comparison for ARP and MAC data
- name: Compare ARP and MAC data with baseline (post-upgrade only)
  when:
    - validation_phase is defined
    - validation_phase == 'post_upgrade'
    - platform == 'nxos'
    - not ansible_check_mode
    - network_baseline_pre is defined
    - network_baseline_post is defined
  block:
    - name: Normalize ARP pre-upgrade data
      ansible.builtin.include_tasks: normalize-baseline-data.yml
      vars:
        data_to_normalize: "{{ network_baseline_pre.arp_data }}"
        fields_to_exclude: "{{ baseline_comparison_excluded_fields.arp_data if baseline_comparison_excluded_fields.arp_data is defined else [] }}"

    - name: Store normalized ARP pre data
      ansible.builtin.set_fact:
        arp_pre_normalized: "{{ normalized_data }}"

    - name: Normalize ARP post-upgrade data
      ansible.builtin.include_tasks: normalize-baseline-data.yml
      vars:
        data_to_normalize: "{{ network_baseline_post.arp_data }}"
        fields_to_exclude: "{{ baseline_comparison_excluded_fields.arp_data if baseline_comparison_excluded_fields.arp_data is defined else [] }}"

    - name: Calculate ARP and MAC deltas using difference filter
      ansible.builtin.set_fact:
        arp_post_normalized: "{{ normalized_data }}"
        arp_added: "{{ normalized_data | difference(arp_pre_normalized) }}"
        arp_removed: "{{ arp_pre_normalized | difference(normalized_data) }}"
        arp_comparison_match: "{{ normalized_data == arp_pre_normalized }}"
        mac_added: "{{ network_baseline_post.mac_data | difference(network_baseline_pre.mac_data) }}"
        mac_removed: "{{ network_baseline_pre.mac_data | difference(network_baseline_post.mac_data) }}"
        mac_comparison_match: "{{ network_baseline_post.mac_data == network_baseline_pre.mac_data }}"

    - name: Report ARP added entries
      ansible.builtin.debug:
        msg:
          - "=== ARP and MAC Data Comparison ==="
          - "Added/Modified ARP Entries:"
          - "{{ arp_added | to_nice_json }}"
      when: arp_added | length > 0

    - name: Report ARP removed entries
      ansible.builtin.debug:
        msg:
          - "=== ARP and MAC Data Comparison ==="
          - "Removed ARP Entries:"
          - "{{ arp_removed | to_nice_json }}"
      when: arp_removed | length > 0

    - name: Report MAC added entries
      ansible.builtin.debug:
        msg:
          - "=== ARP and MAC Data Comparison ==="
          - "Added/Modified MAC Entries:"
          - "{{ mac_added | to_nice_json }}"
      when: mac_added | length > 0

    - name: Report MAC removed entries
      ansible.builtin.debug:
        msg:
          - "=== ARP and MAC Data Comparison ==="
          - "Removed MAC Entries:"
          - "{{ mac_removed | to_nice_json }}"
      when: mac_removed | length > 0

    - name: Report no ARP and MAC changes
      ansible.builtin.debug:
        msg:
          - "=== ARP and MAC Data Comparison ==="
          - "Status: No changes detected in ARP and MAC data"
      when: arp_comparison_match and mac_comparison_match

    - name: Determine ARP/MAC comparison status
      ansible.builtin.set_fact:
        arp_mac_comparison_status: "{{ 'PASS' if arp_comparison_match and mac_comparison_match else 'FAIL' }}"

- name: Set ARP/MAC comparison status when not applicable
  when:
    - validation_phase is not defined or validation_phase != 'post_upgrade' or
      platform != 'nxos' or
      network_baseline_pre is not defined or network_baseline_post is not defined
  ansible.builtin.set_fact:
    arp_mac_comparison_status: "NOT_RUN"
