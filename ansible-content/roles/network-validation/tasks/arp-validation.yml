---
# ARP and MAC Data Validation
# Compares entire arp_data and mac_data (arp_data normalized, mac_data raw)
# Validates all ARP and MAC state before operational state validation
#
# DESIGN: Extract complete arp_data and mac_data dicts from baseline data, normalize arp_data, compare, report deltas
# DATA SOURCES:
# - ARP data: network_baseline.arp_data (normalized for comparison)
# - MAC data: network_baseline.mac_data (raw comparison)
# - Pre-upgrade baseline: network_baseline_pre
# - Post-upgrade baseline: network_baseline_post

# Initialize ARP/MAC comparison status
- name: Initialize ARP/MAC comparison status
  ansible.builtin.set_fact:
    arp_mac_comparison_status: "NOT_RUN"

# Post-upgrade comparison for ARP and MAC data
- name: Compare ARP and MAC data with baseline (post-upgrade only)
  when:
    - validation_phase is defined
    - validation_phase == 'post_upgrade'
    - platform == 'nxos'
    - not ansible_check_mode
    - network_baseline_pre is defined
    - network_baseline_post is defined
  block:
    # ARP Data - Normalize and Compare
    - name: ARP Data Comparison
      when:
        - network_baseline_pre.arp_data is defined
        - network_baseline_post.arp_data is defined
      block:
        - name: Normalize ARP pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.arp_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.arp_data }}"

        - name: Store normalized ARP pre data
          ansible.builtin.set_fact:
            arp_pre_normalized: "{{ normalized_data }}"

        - name: Normalize ARP post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.arp_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.arp_data }}"

        - name: Calculate ARP deltas
          ansible.builtin.set_fact:
            arp_post_normalized: "{{ normalized_data }}"
            arp_added: "{{ normalized_data | difference_recursive(arp_pre_normalized) }}"
            arp_removed: "{{ arp_pre_normalized | difference_recursive(normalized_data) }}"
            arp_comparison_match: "{{ normalized_data == arp_pre_normalized }}"

        - name: Report ARP added entries
          ansible.builtin.debug:
            msg:
              - "=== ARP and MAC Data Comparison ==="
              - "Added/Modified ARP Entries:"
              - "{{ arp_added | to_proper_json }}"
          when: arp_added | length > 0

        - name: Report ARP removed entries
          ansible.builtin.debug:
            msg:
              - "=== ARP and MAC Data Comparison ==="
              - "Removed ARP Entries:"
              - "{{ arp_removed | to_proper_json }}"
          when: arp_removed | length > 0

    # MAC Data - Raw Comparison (no normalization needed)
    - name: MAC Data Comparison
      when:
        - network_baseline_pre.mac_data is defined
        - network_baseline_post.mac_data is defined
      block:
        - name: Calculate MAC deltas
          ansible.builtin.set_fact:
            mac_added: "{{ network_baseline_post.mac_data | difference_recursive(network_baseline_pre.mac_data) }}"
            mac_removed: "{{ network_baseline_pre.mac_data | difference_recursive(network_baseline_post.mac_data) }}"
            mac_comparison_match: "{{ network_baseline_post.mac_data == network_baseline_pre.mac_data }}"

        - name: Report MAC added entries
          ansible.builtin.debug:
            msg:
              - "=== ARP and MAC Data Comparison ==="
              - "Added/Modified MAC Entries:"
              - "{{ mac_added | to_proper_json }}"
          when: mac_added | length > 0

        - name: Report MAC removed entries
          ansible.builtin.debug:
            msg:
              - "=== ARP and MAC Data Comparison ==="
              - "Removed MAC Entries:"
              - "{{ mac_removed | to_proper_json }}"
          when: mac_removed | length > 0

    - name: Report no ARP and MAC changes
      ansible.builtin.debug:
        msg:
          - "=== ARP and MAC Data Comparison ==="
          - "Status: No changes detected in ARP and MAC data"
      when:
        - arp_comparison_match
        - mac_comparison_match

    - name: Validate ARP and MAC comparison passed
      ansible.builtin.assert:
        that:
          - arp_comparison_match | bool
          - mac_comparison_match | bool
        fail_msg:
          - "CRITICAL: Network validation failed - ARP/MAC mismatch detected"
          - "This indicates network state changed during upgrade"
          - "Pre-upgrade ARP entries: {{ arp_pre_normalized | length }}"
          - "Post-upgrade ARP entries: {{ arp_post_normalized | length }}"
          - "ARP added entries: {{ arp_added | length }}"
          - "ARP removed entries: {{ arp_removed | length }}"
          - "MAC added entries: {{ mac_added | length }}"
          - "MAC removed entries: {{ mac_removed | length }}"
          - "RECOMMENDATION: Investigate network changes or rollback upgrade"

    - name: Set ARP/MAC comparison success status
      ansible.builtin.set_fact:
        arp_mac_comparison_status: "PASS"
