---
# ARP and MAC Table Validation
# Validates ARP table entries and MAC address table
# Uses pre-gathered data from connectivity-check (nxos_validation_data)
# DESIGN: Single block pattern with platform gate
#
# FEATURES:
# - ARP table analysis (static, dynamic, incomplete)
# - MAC address table analysis
# - ARP-MAC correlation

- name: NX-OS ARP and MAC Validation (uses pre-gathered data from connectivity-check)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
  block:
    - name: Enforce NX-OS validation data availability
      ansible.builtin.assert:
        that:
          - nxos_validation_data is defined
          - nxos_validation_data.stdout is defined
          - nxos_validation_data.stdout | length == 2
        fail_msg:
          - "NX-OS validation data not available (ARP and MAC)"
          - "network-resources-gathering must run successfully before ARP validation"

    - name: Extract ARP and MAC data from pre-gathered data
      ansible.builtin.set_fact:
        arp_data: "{{ nxos_validation_data.stdout[0] }}"
        mac_data: "{{ nxos_validation_data.stdout[1] }}"

    - name: Parse ARP table data
      ansible.builtin.set_fact:
        arp_table: "{{ arp_data if arp_data is mapping else (arp_data | from_json) }}"

    - name: Parse MAC table data
      ansible.builtin.set_fact:
        mac_table: "{{ mac_data if mac_data is mapping else (mac_data | from_json) }}"

    - name: Extract ARP entries
      ansible.builtin.set_fact:
        arp_entries: "{{ arp_table.TABLE_vrf.ROW_vrf | map(attribute='TABLE_adj') | map(attribute='ROW_adj') | flatten }}"

    - name: Extract MAC entries
      ansible.builtin.set_fact:
        mac_entries: "{{ mac_table.TABLE_mac_address.ROW_mac_address }}"

    - name: Classify ARP entries by type
      ansible.builtin.set_fact:
        static_arp_entries: "{{ arp_entries | selectattr('flags', 'defined') | selectattr('flags', 'match', '.*S.*') | list }}"
        dynamic_arp_entries: "{{ arp_entries | selectattr('flags', 'defined') | selectattr('flags', 'match', '.*D.*') | list }}"
        incomplete_arp_entries: "{{ arp_entries | selectattr('flags', 'defined') | selectattr('flags', 'match', '.*I.*') | list }}"

    - name: Check ARP table completeness
      ansible.builtin.assert:
        that:
          - arp_entries | length > 0
        fail_msg: "ARP table appears to be empty"

    - name: Check for excessive incomplete entries
      ansible.builtin.debug:
        msg: "WARNING: {{ incomplete_arp_entries | length }} incomplete ARP entries found"
      when: incomplete_arp_entries | length > 10

    - name: Display ARP-MAC validation
      ansible.builtin.debug:
        msg:
          - "=== ARP and MAC Table Validation ==="
          - "ARP Entries: {{ arp_entries | length }}"
          - "Static ARP: {{ static_arp_entries | length }}"
          - "Dynamic ARP: {{ dynamic_arp_entries | length }}"
          - "Incomplete ARP: {{ incomplete_arp_entries | length }}"
          - "MAC Entries: {{ mac_entries | length }}"
      when: show_debug | bool
- name: Store ARP baseline (NX-OS)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
  ansible.builtin.set_fact:
    arp_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      total_arp_entries: "{{ arp_entries | length }}"
      static_entries: "{{ static_arp_entries | length }}"
      dynamic_entries: "{{ dynamic_arp_entries | length }}"
      incomplete_entries: "{{ incomplete_arp_entries | length }}"
      mac_entries: "{{ mac_entries | length }}"

- name: Store ARP baseline for check mode
  when:
    - ansible_check_mode
  ansible.builtin.set_fact:
    arp_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      total_arp_entries: 0
      static_entries: 0
      dynamic_entries: 0
      incomplete_entries: 0
      mac_entries: 0

- name: ARP validation summary
  ansible.builtin.debug:
    msg:
      - "=== ARP and MAC Table Validation Results ==="
      - "Total ARP Entries: {{ arp_baseline.total_arp_entries }}"
      - "Static ARP Entries: {{ arp_baseline.static_entries }}"
      - "Dynamic ARP Entries: {{ arp_baseline.dynamic_entries }}"
      - "Incomplete ARP Entries: {{ arp_baseline.incomplete_entries }}"
      - "MAC Table Entries: {{ arp_baseline.mac_entries }}"
      - "Overall Status: {{ 'HEALTHY' if arp_baseline.total_arp_entries | int > 0 else 'EMPTY TABLE' }}"
      - "============================================"

- name: IOS-XE ARP Validation (placeholder for future implementation)
  when:
    - platform == 'ios'
    - not ansible_check_mode
  block:
    - name: Get ARP information (IOS-XE)
      cisco.ios.ios_command:
        commands:
          - show ip arp
          - show arp summary
      register: ios_arp_info

    - name: Store IOS-XE ARP baseline (placeholder)
      ansible.builtin.set_fact:
        arp_baseline:
          timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
          total_arp_entries: 0
          platform: "ios"
          raw_output: "{{ ios_arp_info.stdout }}"
