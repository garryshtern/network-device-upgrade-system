---
# Multicast Protocol Validation (PIM and IGMP)
# Compares PIM interface, PIM neighbor, PIM RP, IGMP interface, IGMP groups, and mroute data
#
# DESIGN: Normalize only data types that have time-sensitive fields defined in defaults
# DATA SOURCES:
# - PIM data: network_baseline.pim_interface_data, network_baseline.pim_neighbor_data, network_baseline.pim_rp_data
# - IGMP data: network_baseline.igmp_interface_data, network_baseline.igmp_groups_data
# - Multicast routes: network_baseline.mroute_data
# - Pre-upgrade baseline: network_baseline_pre
# - Post-upgrade baseline: network_baseline_post

# Post-upgrade comparison for multicast data
- name: Initialize multicast comparison status
  ansible.builtin.set_fact:
    multicast_comparison_status: "NOT_RUN"

- name: Compare multicast data with baseline (post-upgrade only)
  when:
    - validation_phase is defined
    - validation_phase == 'post_upgrade'
    - platform == 'nxos'
    - not ansible_check_mode
    - multicast_enabled | bool
    - network_baseline_pre is defined
    - network_baseline_post is defined
  block:
    # PIM Interface Data - Normalize, Compare, and Report
    - name: PIM Interface Data Comparison
      when: network_baseline_pre.pim_interface_data is defined and network_baseline_post.pim_interface_data is defined
      block:
        - name: Normalize PIM interface pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.pim_interface_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.pim_interface_data }}"

        - name: Store normalized PIM interface pre data
          ansible.builtin.set_fact:
            pim_interface_pre_normalized: "{{ normalized_data }}"

        - name: Normalize PIM interface post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.pim_interface_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.pim_interface_data }}"

        - name: Calculate PIM interface deltas
          ansible.builtin.set_fact:
            pim_interface_post_normalized: "{{ normalized_data }}"
            pim_interface_added: "{{ normalized_data | difference(pim_interface_pre_normalized) }}"
            pim_interface_removed: "{{ pim_interface_pre_normalized | difference(normalized_data) }}"
            pim_interface_match: "{{ normalized_data == pim_interface_pre_normalized }}"

        - name: Report PIM interface added entries
          ansible.builtin.debug:
            msg:
              - "=== Multicast Data Comparison ==="
              - "Added/Modified PIM Interfaces:"
              - "{{ pim_interface_added | to_nice_json }}"
          when: pim_interface_added | length > 0

        - name: Report PIM interface removed entries
          ansible.builtin.debug:
            msg:
              - "=== Multicast Data Comparison ==="
              - "Removed PIM Interfaces:"
              - "{{ pim_interface_removed | to_nice_json }}"
          when: pim_interface_removed | length > 0

    # PIM Neighbor Data - Normalize, Compare, and Report
    - name: PIM Neighbor Data Comparison
      when: network_baseline_pre.pim_neighbor_data is defined and network_baseline_post.pim_neighbor_data is defined
      block:
        - name: Normalize PIM neighbor pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.pim_neighbor_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.pim_neighbor_data }}"

        - name: Store normalized PIM neighbor pre data
          ansible.builtin.set_fact:
            pim_neighbor_pre_normalized: "{{ normalized_data }}"

        - name: Normalize PIM neighbor post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.pim_neighbor_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.pim_neighbor_data }}"

        - name: Calculate PIM neighbor deltas
          ansible.builtin.set_fact:
            pim_neighbor_post_normalized: "{{ normalized_data }}"
            pim_neighbor_added: "{{ normalized_data | difference(pim_neighbor_pre_normalized) }}"
            pim_neighbor_removed: "{{ pim_neighbor_pre_normalized | difference(normalized_data) }}"
            pim_neighbor_match: "{{ normalized_data == pim_neighbor_pre_normalized }}"

        - name: Report PIM neighbor added entries
          ansible.builtin.debug:
            msg:
              - "=== Multicast Data Comparison ==="
              - "Added/Modified PIM Neighbors:"
              - "{{ pim_neighbor_added | to_nice_json }}"
          when: pim_neighbor_added | length > 0

        - name: Report PIM neighbor removed entries
          ansible.builtin.debug:
            msg:
              - "=== Multicast Data Comparison ==="
              - "Removed PIM Neighbors:"
              - "{{ pim_neighbor_removed | to_nice_json }}"
          when: pim_neighbor_removed | length > 0

    # PIM RP Data - Raw Comparison and Report
    - name: PIM RP Data Comparison
      when: network_baseline_pre.pim_rp_data is defined and network_baseline_post.pim_rp_data is defined
      block:
        - name: Calculate PIM RP deltas
          ansible.builtin.set_fact:
            pim_rp_added: "{{ network_baseline_post.pim_rp_data | difference(network_baseline_pre.pim_rp_data) }}"
            pim_rp_removed: "{{ network_baseline_pre.pim_rp_data | difference(network_baseline_post.pim_rp_data) }}"
            pim_rp_match: "{{ network_baseline_post.pim_rp_data == network_baseline_pre.pim_rp_data }}"

        - name: Report PIM RP added entries
          ansible.builtin.debug:
            msg:
              - "=== Multicast Data Comparison ==="
              - "Added/Modified PIM RPs:"
              - "{{ pim_rp_added | to_nice_json }}"
          when: pim_rp_added | length > 0

        - name: Report PIM RP removed entries
          ansible.builtin.debug:
            msg:
              - "=== Multicast Data Comparison ==="
              - "Removed PIM RPs:"
              - "{{ pim_rp_removed | to_nice_json }}"
          when: pim_rp_removed | length > 0

    # IGMP Interface Data - Normalize, Compare, and Report
    - name: IGMP Interface Data Comparison
      when: network_baseline_pre.igmp_interface_data is defined and network_baseline_post.igmp_interface_data is defined
      block:
        - name: Normalize IGMP interface pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.igmp_interface_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.igmp_interface_data }}"

        - name: Store normalized IGMP interface pre data
          ansible.builtin.set_fact:
            igmp_interface_pre_normalized: "{{ normalized_data }}"

        - name: Normalize IGMP interface post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.igmp_interface_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.igmp_interface_data }}"

        - name: Calculate IGMP interface deltas
          ansible.builtin.set_fact:
            igmp_interface_post_normalized: "{{ normalized_data }}"
            igmp_interface_added: "{{ normalized_data | difference(igmp_interface_pre_normalized) }}"
            igmp_interface_removed: "{{ igmp_interface_pre_normalized | difference(normalized_data) }}"
            igmp_interface_match: "{{ normalized_data == igmp_interface_pre_normalized }}"

        - name: Report IGMP interface added entries
          ansible.builtin.debug:
            msg:
              - "=== Multicast Data Comparison ==="
              - "Added/Modified IGMP Interfaces:"
              - "{{ igmp_interface_added | to_nice_json }}"
          when: igmp_interface_added | length > 0

        - name: Report IGMP interface removed entries
          ansible.builtin.debug:
            msg:
              - "=== Multicast Data Comparison ==="
              - "Removed IGMP Interfaces:"
              - "{{ igmp_interface_removed | to_nice_json }}"
          when: igmp_interface_removed | length > 0

    # IGMP Groups Data - Normalize, Compare, and Report
    - name: IGMP Groups Data Comparison
      when: network_baseline_pre.igmp_groups_data is defined and network_baseline_post.igmp_groups_data is defined
      block:
        - name: Normalize IGMP groups pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.igmp_groups_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.igmp_groups_data }}"

        - name: Store normalized IGMP groups pre data
          ansible.builtin.set_fact:
            igmp_groups_pre_normalized: "{{ normalized_data }}"

        - name: Normalize IGMP groups post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.igmp_groups_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.igmp_groups_data }}"

        - name: Calculate IGMP groups deltas
          ansible.builtin.set_fact:
            igmp_groups_post_normalized: "{{ normalized_data }}"
            igmp_groups_added: "{{ normalized_data | difference(igmp_groups_pre_normalized) }}"
            igmp_groups_removed: "{{ igmp_groups_pre_normalized | difference(normalized_data) }}"
            igmp_groups_match: "{{ normalized_data == igmp_groups_pre_normalized }}"

        - name: Report IGMP groups added entries
          ansible.builtin.debug:
            msg:
              - "=== Multicast Data Comparison ==="
              - "Added/Modified IGMP Groups:"
              - "{{ igmp_groups_added | to_nice_json }}"
          when: igmp_groups_added | length > 0

        - name: Report IGMP groups removed entries
          ansible.builtin.debug:
            msg:
              - "=== Multicast Data Comparison ==="
              - "Removed IGMP Groups:"
              - "{{ igmp_groups_removed | to_nice_json }}"
          when: igmp_groups_removed | length > 0

    # Multicast Route Data - Normalize, Compare, and Report
    - name: Multicast Route Data Comparison
      when: network_baseline_pre.mroute_data is defined and network_baseline_post.mroute_data is defined
      block:
        - name: Normalize mroute pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.mroute_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.mroute_data }}"

        - name: Store normalized mroute pre data
          ansible.builtin.set_fact:
            mroute_pre_normalized: "{{ normalized_data }}"

        - name: Normalize mroute post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.mroute_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.mroute_data }}"

        - name: Calculate mroute deltas
          ansible.builtin.set_fact:
            mroute_post_normalized: "{{ normalized_data }}"
            mroute_added: "{{ normalized_data | difference(mroute_pre_normalized) }}"
            mroute_removed: "{{ mroute_pre_normalized | difference(normalized_data) }}"
            mroute_match: "{{ normalized_data == mroute_pre_normalized }}"

        - name: Report mroute added entries
          ansible.builtin.debug:
            msg:
              - "=== Multicast Data Comparison ==="
              - "Added/Modified Multicast Routes:"
              - "{{ mroute_added | to_nice_json }}"
          when: mroute_added | length > 0

        - name: Report mroute removed entries
          ansible.builtin.debug:
            msg:
              - "=== Multicast Data Comparison ==="
              - "Removed Multicast Routes:"
              - "{{ mroute_removed | to_nice_json }}"
          when: mroute_removed | length > 0

    - name: Report no multicast changes
      ansible.builtin.debug:
        msg:
          - "=== Multicast Data Comparison ==="
          - "Status: No changes detected in multicast data"
      when:
        - pim_interface_match
        - pim_neighbor_match
        - pim_rp_match
        - igmp_interface_match
        - igmp_groups_match
        - mroute_match

    - name: Determine multicast comparison status
      ansible.builtin.set_fact:
        multicast_comparison_status: >-
          {{
            'PASS' if (
              pim_interface_match and
              pim_neighbor_match and
              pim_rp_match and
              igmp_interface_match and
              igmp_groups_match and
              mroute_match
            )
            else 'FAIL'
          }}

