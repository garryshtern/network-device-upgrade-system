---
# Multicast Protocol Validation
# Validates PIM, IGMP, RP configuration, and multicast routing
# Uses raw baseline data from network-resources-gathering
# DESIGN: Single block pattern with platform gate
#
# DATA SOURCES (raw baseline data from network-resources-gathering):
# - PIM data: network_baseline.pim_interface_data, network_baseline.pim_neighbor_data, network_baseline.pim_rp_data
# - IGMP data: network_baseline.igmp_interface_data, network_baseline.igmp_groups_data
# - Multicast routes: network_baseline.mroute_data, network_baseline.mroute_summary_data
# - Anycast RP: network_baseline.anycast_rp_data
#
# FEATURES:
# - PIM data availability validation
# - IGMP data availability validation
# - Multicast routing data availability validation
# - Only validates if PIM is configured

- name: NX-OS Multicast Validation (uses raw baseline data from network-resources-gathering)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
    - multicast_enabled | bool
    - network_baseline is defined
  block:
    - name: Use raw multicast baseline data
      ansible.builtin.set_fact:
        pim_data_available: "{{ network_baseline.pim_interface_data | length > 0 if network_baseline.pim_interface_data is defined else false }}"
        igmp_data_available: "{{ network_baseline.igmp_interface_data | length > 0 if network_baseline.igmp_interface_data is defined else false }}"
        mroute_data_available: "{{ network_baseline.mroute_data | length > 0 if network_baseline.mroute_data is defined else false }}"
        pim_configured: "{{ (network_baseline.pim_interface_data | length > 0) or (network_baseline.pim_neighbor_data | length > 0) if (network_baseline.pim_interface_data is defined and network_baseline.pim_neighbor_data is defined) else false }}"

    - name: Debug multicast data availability
      ansible.builtin.debug:
        msg:
          - "=== Multicast Protocol Validation ==="
          - "PIM Data Available: {{ pim_data_available }}"
          - "IGMP Data Available: {{ igmp_data_available }}"
          - "Mroute Data Available: {{ mroute_data_available }}"
          - "PIM Configured: {{ pim_configured }}"
      when:
        - show_debug | bool

- name: Store multicast baseline (NX-OS)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
  ansible.builtin.set_fact:
    multicast_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      pim_configured: "{{ pim_configured if pim_configured is defined else false }}"
      pim_data_available: "{{ pim_data_available if pim_data_available is defined else false }}"
      igmp_data_available: "{{ igmp_data_available if igmp_data_available is defined else false }}"
      mroute_data_available: "{{ mroute_data_available if mroute_data_available is defined else false }}"

- name: Store multicast baseline for check mode
  when:
    - ansible_check_mode
  ansible.builtin.set_fact:
    multicast_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      pim_configured: false
      pim_data_available: false
      igmp_data_available: false
      mroute_data_available: false

- name: Multicast validation summary
  ansible.builtin.debug:
    msg:
      - "=== Multicast Protocol Validation Results ==="
      - "PIM Configured: {{ multicast_baseline.pim_configured }}"
      - "PIM Data Available: {{ multicast_baseline.pim_data_available }}"
      - "IGMP Data Available: {{ multicast_baseline.igmp_data_available }}"
      - "Mroute Data Available: {{ multicast_baseline.mroute_data_available }}"
      - "Overall Status: {{ 'CONFIGURED' if multicast_baseline.pim_configured else 'NOT CONFIGURED' }}"
      - "==============================================="

# Post-upgrade comparison for multicast state
- name: Compare PIM/IGMP/Mroute data with baseline (post-upgrade only)
  when:
    - validation_phase is defined
    - validation_phase == 'post_upgrade'
    - multicast_enabled | bool
    - network_baseline_pre is defined
    - network_baseline_post is defined
  block:
    # PIM Interface Comparison
    - name: Compare PIM interface data
      when:
        - network_baseline_pre.pim_interface_data is defined
        - network_baseline_post.pim_interface_data is defined
      block:
        - name: Normalize PIM interface pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.pim_interface_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.pim_interface_data if baseline_comparison_excluded_fields.pim_interface_data is defined else [] }}"

        - name: Store normalized PIM interface pre data
          ansible.builtin.set_fact:
            pim_interface_pre_normalized: "{{ normalized_data }}"

        - name: Normalize PIM interface post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.pim_interface_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.pim_interface_data if baseline_comparison_excluded_fields.pim_interface_data is defined else [] }}"

        - name: Calculate PIM interface deltas
          ansible.builtin.set_fact:
            pim_interface_post_normalized: "{{ normalized_data }}"
            pim_interface_match: "{{ normalized_data == pim_interface_pre_normalized }}"

    # IGMP Group Comparison
    - name: Compare IGMP group data
      when:
        - network_baseline_pre.igmp_groups_data is defined
        - network_baseline_post.igmp_groups_data is defined
      block:
        - name: Normalize IGMP groups pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.igmp_groups_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.igmp_groups_data if baseline_comparison_excluded_fields.igmp_groups_data is defined else [] }}"

        - name: Store normalized IGMP groups pre data
          ansible.builtin.set_fact:
            igmp_groups_pre_normalized: "{{ normalized_data }}"

        - name: Normalize IGMP groups post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.igmp_groups_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.igmp_groups_data if baseline_comparison_excluded_fields.igmp_groups_data is defined else [] }}"

        - name: Calculate IGMP groups deltas
          ansible.builtin.set_fact:
            igmp_groups_post_normalized: "{{ normalized_data }}"
            igmp_groups_match: "{{ normalized_data == igmp_groups_pre_normalized }}"

    # Multicast Route Comparison
    - name: Compare multicast route data
      when:
        - network_baseline_pre.mroute_data is defined
        - network_baseline_post.mroute_data is defined
      block:
        - name: Normalize mroute pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.mroute_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.mroute_data if baseline_comparison_excluded_fields.mroute_data is defined else [] }}"

        - name: Store normalized mroute pre data
          ansible.builtin.set_fact:
            mroute_pre_normalized: "{{ normalized_data }}"

        - name: Normalize mroute post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.mroute_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.mroute_data if baseline_comparison_excluded_fields.mroute_data is defined else [] }}"

        - name: Calculate mroute deltas
          ansible.builtin.set_fact:
            mroute_post_normalized: "{{ normalized_data }}"
            mroute_match: "{{ normalized_data == mroute_pre_normalized }}"

    - name: Report multicast comparison results
      ansible.builtin.debug:
        msg:
          - "=== Multicast Data Comparison ==="
          - "{{ 'PIM Interfaces Match: ' + (pim_interface_match | string) if pim_interface_match is defined else '' }}"
          - "{{ 'IGMP Groups Match: ' + (igmp_groups_match | string) if igmp_groups_match is defined else '' }}"
          - "{{ 'Mroutes Match: ' + (mroute_match | string) if mroute_match is defined else '' }}"
      when: show_debug | bool

    - name: Determine multicast comparison status
      ansible.builtin.set_fact:
        multicast_comparison_status: >-
          {{
            'PASS' if ((pim_interface_match | default(true)) and
                       (igmp_groups_match | default(true)) and
                       (mroute_match | default(true)))
            else 'FAIL'
          }}

- name: Set multicast comparison status when not applicable
  when:
    - validation_phase is not defined or validation_phase != 'post_upgrade' or
      not (multicast_enabled | bool) or
      network_baseline_pre is not defined or network_baseline_post is not defined
  ansible.builtin.set_fact:
    multicast_comparison_status: "NOT_RUN"
