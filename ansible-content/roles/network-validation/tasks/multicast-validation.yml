---
# Multicast Protocol Validation
# Validates PIM, IGMP, RP configuration, and multicast routing
# Uses pre-parsed data from network-resources-gathering
# DESIGN: Single block pattern with platform gate
#
# DATA SOURCES (all pre-parsed from network-resources-gathering):
# - PIM interfaces/neighbors/RPs: pim_interfaces_list, pim_neighbors_list, pim_rps_list
# - IGMP interfaces/groups: igmp_interfaces_list, igmp_groups_list
# - Multicast routes: mroute_entries_list, mroute_summary
# - Anycast RP: gathered_anycast_rp_data
#
# FEATURES:
# - PIM neighbor and interface validation
# - IGMP group and interface validation
# - RP (Rendezvous Point) configuration and reachability
# - Anycast RP validation (pre-parsed, optional)
# - Multicast routing table validation (pre-parsed)
# - Only validates if PIM is configured

- name: NX-OS Multicast Validation (uses pre-parsed PIM/IGMP/mroute data from network-resources-gathering)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
    - multicast_enabled | bool
  block:
    - name: Use pre-parsed PIM and IGMP data (if available)
      ansible.builtin.set_fact:
        pim_interfaces: "{{ pim_interfaces_list }}"
        pim_neighbors: "{{ pim_neighbors_list }}"
        pim_rp_info: "{{ pim_rps_list }}"
        igmp_interfaces: "{{ igmp_interfaces_list }}"
        igmp_groups: "{{ igmp_groups_list }}"
        pim_configured: "{{ (pim_interfaces_list | length > 0) or (pim_neighbors_list | length > 0) }}"
      when:
        - pim_interfaces_list is defined
        - pim_neighbors_list is defined
        - pim_rps_list is defined
        - igmp_interfaces_list is defined
        - igmp_groups_list is defined

    - name: Classify PIM neighbor states
      ansible.builtin.set_fact:
        pim_neighbors_up: "{{ pim_neighbors | selectattr('neighbor_state', 'defined') | selectattr('neighbor_state', 'equalto', 'up') | list }}"
        pim_neighbors_down: "{{ pim_neighbors | selectattr('neighbor_state', 'defined') | selectattr('neighbor_state', 'ne', 'up') | list }}"
      when:
        - pim_neighbors is defined
        - pim_neighbors | length > 0

    - name: Classify PIM interface modes
      ansible.builtin.set_fact:
        pim_sparse_mode: "{{ pim_interfaces | selectattr('mode', 'defined') | selectattr('mode', 'match', '.*sparse.*') | list }}"
        pim_dense_mode: "{{ pim_interfaces | selectattr('mode', 'defined') | selectattr('mode', 'match', '.*dense.*') | list }}"
      when:
        - pim_interfaces is defined
        - pim_interfaces | length > 0

    - name: Debug PIM and IGMP data
      ansible.builtin.debug:
        msg:
          - "=== Multicast Protocol Validation ==="
          - "PIM Neighbors: {{ pim_neighbors | length }}"
          - "PIM Neighbors Up: {{ pim_neighbors_up | length if pim_neighbors_up is defined else 0 }}"
          - "PIM Interfaces: {{ pim_interfaces | length }}"
          - "PIM Sparse Mode: {{ pim_sparse_mode | length if pim_sparse_mode is defined else 0 }}"
          - "PIM RPs: {{ pim_rp_info | length }}"
          - "IGMP Interfaces: {{ igmp_interfaces | length }}"
          - "IGMP Groups: {{ igmp_groups | length }}"
      when:
        - show_debug | bool

    - name: Use pre-parsed Anycast RP data (if available)
      ansible.builtin.set_fact:
        anycast_rp_sets: "{{ gathered_anycast_rp_data | json_query('TABLE_anycast_rp.ROW_anycast_rp') }}"
      when:
        - gathered_anycast_rp_data is defined

    - name: Use pre-parsed mroute data (if available)
      ansible.builtin.set_fact:
        mroute_entries: "{{ mroute_entries_list }}"
      when:
        - mroute_entries_list is defined

- name: Store multicast baseline (NX-OS)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
  ansible.builtin.set_fact:
    multicast_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      pim_configured: "{{ pim_configured | default(false) }}"
      pim_neighbors_total: "{{ pim_neighbors | length if pim_neighbors is defined else 0 }}"
      pim_neighbors_up: "{{ pim_neighbors_up | length if pim_neighbors_up is defined else 0 }}"
      pim_sparse_interfaces: "{{ pim_sparse_mode | length if pim_sparse_mode is defined else 0 }}"
      igmp_interfaces_total: "{{ igmp_interfaces | length if igmp_interfaces is defined else 0 }}"
      igmp_groups_total: "{{ igmp_groups | length if igmp_groups is defined else 0 }}"
      rp_count: "{{ pim_rp_info | length if pim_rp_info is defined else 0 }}"
      anycast_rp_sets: "{{ anycast_rp_sets | length if anycast_rp_sets is defined else 0 }}"
      mroute_entries: "{{ mroute_entries | length if mroute_entries is defined else 0 }}"

- name: Store multicast baseline for check mode
  when:
    - ansible_check_mode
  ansible.builtin.set_fact:
    multicast_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      pim_configured: false
      pim_neighbors_total: 0
      pim_neighbors_up: 0
      pim_sparse_interfaces: 0
      igmp_interfaces_total: 0
      igmp_groups_total: 0
      rp_count: 0
      anycast_rp_sets: 0
      mroute_entries: 0

- name: Multicast validation summary
  ansible.builtin.debug:
    msg:
      - "=== Multicast Protocol Validation Results ==="
      - "PIM Configured: {{ multicast_baseline.pim_configured }}"
      - "PIM Neighbors: {{ multicast_baseline.pim_neighbors_up }}/{{ multicast_baseline.pim_neighbors_total }}"
      - "PIM Sparse Mode Interfaces: {{ multicast_baseline.pim_sparse_interfaces }}"
      - "IGMP Interfaces: {{ multicast_baseline.igmp_interfaces_total }}"
      - "IGMP Groups: {{ multicast_baseline.igmp_groups_total }}"
      - "Configured RPs: {{ multicast_baseline.rp_count }}"
      - "Anycast RP Sets: {{ multicast_baseline.anycast_rp_sets }}"
      - "Active Multicast Routes: {{ multicast_baseline.mroute_entries }}"
      - "Overall Status: {{ 'CONFIGURED' if multicast_baseline.pim_configured else 'NOT CONFIGURED' }}"
      - "==============================================="
