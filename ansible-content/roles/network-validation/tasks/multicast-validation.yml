---
# Multicast Protocol Validation
# Validates PIM, IGMP, RP configuration, and multicast routing
# Uses pre-gathered data from connectivity-check (nxos_validation_data)
# DESIGN: Single block pattern with platform gate
#
# FEATURES:
# - PIM neighbor and interface validation
# - IGMP group and interface validation
# - RP (Rendezvous Point) configuration and reachability
# - Anycast RP validation (not pre-gathered)
# - Multicast routing table validation (not pre-gathered)
# - Only validates if PIM is configured

- name: NX-OS Multicast Validation (uses pre-gathered PIM/IGMP data from connectivity-check)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
    - multicast_enabled | bool
  block:
    - name: Extract PIM and IGMP data from pre-gathered data
      ansible.builtin.set_fact:
        pim_interface_data: "{{ nxos_validation_data.stdout[5] }}"
        pim_neighbor_data: "{{ nxos_validation_data.stdout[6] }}"
        pim_rp_data: "{{ nxos_validation_data.stdout[7] }}"
        igmp_interface_data: "{{ nxos_validation_data.stdout[8] }}"
        igmp_groups_data: "{{ nxos_validation_data.stdout[9] }}"
      when:
        - nxos_validation_data is defined
        - nxos_validation_data.stdout is defined

    - name: Parse PIM data
      ansible.builtin.set_fact:
        pim_interface_table: "{{ pim_interface_data if pim_interface_data is mapping else (pim_interface_data | from_json) }}"
        pim_neighbor_table: "{{ pim_neighbor_data if pim_neighbor_data is mapping else (pim_neighbor_data | from_json) }}"
        pim_rp_table: "{{ pim_rp_data if pim_rp_data is mapping else (pim_rp_data | from_json) }}"
      when:
        - pim_interface_data is defined
        - pim_neighbor_data is defined
        - pim_rp_data is defined

    - name: Parse IGMP data
      ansible.builtin.set_fact:
        igmp_interface_table: "{{ igmp_interface_data if igmp_interface_data is mapping else (igmp_interface_data | from_json) }}"
        igmp_groups_table: "{{ igmp_groups_data if igmp_groups_data is mapping else (igmp_groups_data | from_json) }}"
      when:
        - igmp_interface_data is defined
        - igmp_groups_data is defined

    - name: Extract PIM entries
      ansible.builtin.set_fact:
        pim_interfaces: "{{ pim_interface_table.TABLE_intf.ROW_intf if pim_interface_table.TABLE_intf is defined else [] }}"
        pim_neighbors: "{{ pim_neighbor_table.TABLE_neighbor.ROW_neighbor if pim_neighbor_table.TABLE_neighbor is defined else [] }}"
        pim_rp_info: "{{ pim_rp_table.TABLE_rp.ROW_rp if pim_rp_table.TABLE_rp is defined else [] }}"
      when:
        - pim_interface_table is defined
        - pim_neighbor_table is defined
        - pim_rp_table is defined

    - name: Extract IGMP entries
      ansible.builtin.set_fact:
        igmp_interfaces: "{{ igmp_interface_table.TABLE_intf.ROW_intf if igmp_interface_table.TABLE_intf is defined else [] }}"
        igmp_groups: "{{ igmp_groups_table.TABLE_group.ROW_group if igmp_groups_table.TABLE_group is defined else [] }}"
      when:
        - igmp_interface_table is defined
        - igmp_groups_table is defined

    - name: Check if PIM is configured
      ansible.builtin.set_fact:
        pim_configured: "{{ (pim_interfaces | length > 0) or (pim_neighbors | length > 0) }}"
      when:
        - pim_interfaces is defined
        - pim_neighbors is defined

    - name: Classify PIM neighbor states
      ansible.builtin.set_fact:
        pim_neighbors_up: "{{ pim_neighbors | selectattr('neighbor_state', 'defined') | selectattr('neighbor_state', 'equalto', 'up') | list }}"
        pim_neighbors_down: "{{ pim_neighbors | selectattr('neighbor_state', 'defined') | selectattr('neighbor_state', 'ne', 'up') | list }}"
      when:
        - pim_neighbors is defined
        - pim_neighbors | length > 0

    - name: Classify PIM interface modes
      ansible.builtin.set_fact:
        pim_sparse_mode: "{{ pim_interfaces | selectattr('mode', 'defined') | selectattr('mode', 'match', '.*sparse.*') | list }}"
        pim_dense_mode: "{{ pim_interfaces | selectattr('mode', 'defined') | selectattr('mode', 'match', '.*dense.*') | list }}"
      when:
        - pim_interfaces is defined
        - pim_interfaces | length > 0

    - name: Debug PIM and IGMP data
      ansible.builtin.debug:
        msg:
          - "=== Multicast Protocol Validation ==="
          - "PIM Neighbors: {{ pim_neighbors | length }}"
          - "PIM Neighbors Up: {{ pim_neighbors_up | length if pim_neighbors_up is defined else 0 }}"
          - "PIM Interfaces: {{ pim_interfaces | length }}"
          - "PIM Sparse Mode: {{ pim_sparse_mode | length if pim_sparse_mode is defined else 0 }}"
          - "PIM RPs: {{ pim_rp_info | length }}"
          - "IGMP Interfaces: {{ igmp_interfaces | length }}"
          - "IGMP Groups: {{ igmp_groups | length }}"
      when:
        - show_debug | bool

    - name: Get Anycast RP configuration (not pre-gathered)
      cisco.nxos.nxos_command:
        commands:
          - show ip pim anycast-rp | json
      register: anycast_rp_info
      failed_when: false

    - name: Parse Anycast RP information
      ansible.builtin.set_fact:
        anycast_rp_sets: "{{ anycast_rp_info.stdout[0] | from_json | json_query('TABLE_anycast_rp.ROW_anycast_rp') }}"
      when:
        - anycast_rp_info is defined
        - anycast_rp_info is succeeded

    - name: Get multicast routing table (not pre-gathered)
      cisco.nxos.nxos_command:
        commands:
          - show ip mroute summary | json
          - show ip mroute | json
      register: mroute_info
      failed_when: false

    - name: Parse multicast routes
      ansible.builtin.set_fact:
        mroute_summary: "{{ mroute_info.stdout[0] | from_json }}"
        mroute_entries: "{{ mroute_info.stdout[1] | from_json | json_query('TABLE_mroute.ROW_mroute') }}"
      when:
        - mroute_info is defined
        - mroute_info is succeeded

- name: Store multicast baseline (NX-OS)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
  ansible.builtin.set_fact:
    multicast_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      pim_configured: "{{ pim_configured | default(false) }}"
      pim_neighbors_total: "{{ pim_neighbors | length if pim_neighbors is defined else 0 }}"
      pim_neighbors_up: "{{ pim_neighbors_up | length if pim_neighbors_up is defined else 0 }}"
      pim_sparse_interfaces: "{{ pim_sparse_mode | length if pim_sparse_mode is defined else 0 }}"
      igmp_interfaces_total: "{{ igmp_interfaces | length if igmp_interfaces is defined else 0 }}"
      igmp_groups_total: "{{ igmp_groups | length if igmp_groups is defined else 0 }}"
      rp_count: "{{ pim_rp_info | length if pim_rp_info is defined else 0 }}"
      anycast_rp_sets: "{{ anycast_rp_sets | length if anycast_rp_sets is defined else 0 }}"
      mroute_entries: "{{ mroute_entries | length if mroute_entries is defined else 0 }}"

- name: Store multicast baseline for check mode
  when:
    - ansible_check_mode
  ansible.builtin.set_fact:
    multicast_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      pim_configured: false
      pim_neighbors_total: 0
      pim_neighbors_up: 0
      pim_sparse_interfaces: 0
      igmp_interfaces_total: 0
      igmp_groups_total: 0
      rp_count: 0
      anycast_rp_sets: 0
      mroute_entries: 0

- name: Multicast validation summary
  ansible.builtin.debug:
    msg:
      - "=== Multicast Protocol Validation Results ==="
      - "PIM Configured: {{ multicast_baseline.pim_configured }}"
      - "PIM Neighbors: {{ multicast_baseline.pim_neighbors_up }}/{{ multicast_baseline.pim_neighbors_total }}"
      - "PIM Sparse Mode Interfaces: {{ multicast_baseline.pim_sparse_interfaces }}"
      - "IGMP Interfaces: {{ multicast_baseline.igmp_interfaces_total }}"
      - "IGMP Groups: {{ multicast_baseline.igmp_groups_total }}"
      - "Configured RPs: {{ multicast_baseline.rp_count }}"
      - "Anycast RP Sets: {{ multicast_baseline.anycast_rp_sets }}"
      - "Active Multicast Routes: {{ multicast_baseline.mroute_entries }}"
      - "Overall Status: {{ 'CONFIGURED' if multicast_baseline.pim_configured else 'NOT CONFIGURED' }}"
      - "==============================================="
