---
# BFD (Bidirectional Forwarding Detection) Validation
# Validates BFD data availability
# Uses raw baseline data from network-resources-gathering
# DESIGN: Single block pattern with platform gate
# PATTERN: Only validates if BFD is configured on device (same as BGP/multicast)
#
# DATA SOURCES:
# - BFD interfaces: ansible_network_resources.bfd_interfaces (from nxos_facts)
# - BFD baseline data: network_baseline.bfd_data
#
# FEATURES:
# - BFD interface configuration validation
# - BFD data availability validation

- name: Initialize BFD validation results
  ansible.builtin.set_fact:
    bfd_validation:
      device: "{{ inventory_hostname }}"
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      validation_type: "bfd"
      baseline: {}
      current: {}
      passed: true
      errors: []
      warnings: []
      bfd_configured: false

- name: Set BFD configured for check mode
  ansible.builtin.set_fact:
    bfd_validation: "{{ bfd_validation | combine({'bfd_configured': true}) }}"
  when: ansible_check_mode

- name: NX-OS BFD Validation (uses pre-gathered BFD data from connectivity-check)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
  block:
    - name: Extract BFD interfaces from pre-gathered facts
      ansible.builtin.set_fact:
        bfd_interfaces_config: "{{ ansible_network_resources.bfd_interfaces }}"
      when:
        - ansible_network_resources is defined
        - ansible_network_resources.bfd_interfaces is defined

    - name: Use raw BFD baseline data
      ansible.builtin.set_fact:
        bfd_data_available: "{{ network_baseline.bfd_data | length > 0 if network_baseline.bfd_data is defined else false }}"
        bfd_neighbors: []
      when:
        - network_baseline is defined

    - name: Determine if BFD is configured on device
      ansible.builtin.set_fact:
        bfd_validation: "{{ bfd_validation | combine({'bfd_configured': bfd_is_configured}) }}"
      vars:
        bfd_is_configured: "{{ (bfd_interfaces_config | length > 0) or bfd_data_available }}"
      when:
        - bfd_interfaces_config is defined
        - bfd_data_available is defined

  rescue:
    - name: Handle missing BFD facts (not pre-gathered)
      ansible.builtin.set_fact:
        bfd_validation: "{{ bfd_validation | combine({'warnings': bfd_validation.warnings + ['BFD facts not available - skipping BFD validation'], 'bfd_configured': false}) }}"

- name: Skip BFD validation if not configured
  ansible.builtin.debug:
    msg: "BFD is not configured on {{ inventory_hostname }} - skipping BFD validation"
  when: not bfd_validation.bfd_configured

- name: Analyze BFD data availability
  when: bfd_validation.bfd_configured
  block:
    - name: Display BFD data status
      ansible.builtin.debug:
        msg:
          - "=== BFD Data Status ==="
          - "BFD Interfaces Config: {{ 'Available' if bfd_interfaces_config is defined and bfd_interfaces_config | length > 0 else 'Not Available' }}"
          - "BFD Baseline Data: {{ 'Available' if bfd_data_available else 'Not Available' }}"
      when:
        - show_debug | bool

- name: Store BFD baseline (NX-OS)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
  ansible.builtin.set_fact:
    bfd_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      bfd_configured: "{{ bfd_validation.bfd_configured }}"
      bfd_data_available: "{{ bfd_data_available if bfd_data_available is defined else false }}"
      bfd_enabled_interfaces: "{{ bfd_interfaces_config | length if bfd_interfaces_config is defined else 0 }}"

- name: Store BFD baseline for check mode
  when:
    - ansible_check_mode
  ansible.builtin.set_fact:
    bfd_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      bfd_configured: false
      bfd_data_available: false
      bfd_enabled_interfaces: 0

- name: BFD validation summary
  ansible.builtin.debug:
    msg:
      - "=== BFD Validation Results ==="
      - "BFD Configured: {{ bfd_baseline.bfd_configured }}"
      - "BFD-Enabled Interfaces: {{ bfd_baseline.bfd_enabled_interfaces }}"
      - "BFD Baseline Data Available: {{ bfd_baseline.bfd_data_available }}"
      - "Overall Status: {{ 'CONFIGURED' if bfd_baseline.bfd_configured else 'NOT CONFIGURED' }}"
      - "============================"

- name: IOS-XE BFD Validation (placeholder for future implementation)
  when:
    - platform == 'ios'
    - not ansible_check_mode
  block:
    - name: Get BFD information (IOS-XE)
      cisco.ios.ios_command:
        commands:
          - show bfd neighbors
          - show bfd summary
      register: ios_bfd_info

    - name: Store IOS-XE BFD baseline (placeholder)
      ansible.builtin.set_fact:
        bfd_baseline:
          timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
          bfd_configured: false
          platform: "ios"
          raw_output: "{{ ios_bfd_info.stdout }}"
