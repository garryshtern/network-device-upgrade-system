---
# BFD (Bidirectional Forwarding Detection) Validation
# Validates BFD interfaces, neighbors, and session states
# Uses pre-gathered data from connectivity-check (nxos_validation_data)
# DESIGN: Single block pattern with platform gate
#
# FEATURES:
# - BFD interface configuration validation
# - BFD neighbor session state checking
# - Session up/down/admin-down classification
# - Per-VRF BFD session analysis

- name: NX-OS BFD Validation (uses pre-gathered BFD data from connectivity-check)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
  block:
    - name: Extract BFD interfaces from pre-gathered facts
      ansible.builtin.set_fact:
        bfd_interfaces_config: "{{ ansible_network_resources.bfd_interfaces if ansible_network_resources.bfd_interfaces is defined else [] }}"
      when:
        - ansible_network_resources is defined

    - name: Extract BFD neighbor data from pre-gathered data
      ansible.builtin.set_fact:
        bfd_neighbor_data: "{{ nxos_validation_data.stdout[4] }}"
      when:
        - nxos_validation_data is defined
        - nxos_validation_data.stdout is defined

    - name: Parse BFD neighbor data
      ansible.builtin.set_fact:
        bfd_neighbor_table: "{{ bfd_neighbor_data if bfd_neighbor_data is mapping else (bfd_neighbor_data | from_json) }}"
      when:
        - bfd_neighbor_data is defined

    - name: Extract BFD neighbor sessions
      ansible.builtin.set_fact:
        bfd_neighbors: "{{ bfd_neighbor_table.TABLE_vrf.ROW_vrf | map(attribute='TABLE_adj') | map(attribute='ROW_adj') | flatten if bfd_neighbor_table.TABLE_vrf is defined else [] }}"
      when:
        - bfd_neighbor_table is defined

    - name: Check if BFD is configured
      ansible.builtin.set_fact:
        bfd_configured: "{{ (bfd_interfaces_config | length > 0) or (bfd_neighbors | length > 0) }}"
      when:
        - bfd_interfaces_config is defined
        - bfd_neighbors is defined

    - name: Classify BFD session states
      ansible.builtin.set_fact:
        bfd_sessions_up: "{{ bfd_neighbors | selectattr('state', 'defined') | selectattr('state', 'equalto', 'Up') | list }}"
        bfd_sessions_down: "{{ bfd_neighbors | selectattr('state', 'defined') | selectattr('state', 'equalto', 'Down') | list }}"
        bfd_sessions_admin_down: "{{ bfd_neighbors | selectattr('state', 'defined') | selectattr('state', 'equalto', 'AdminDown') | list }}"
        bfd_sessions_init: "{{ bfd_neighbors | selectattr('state', 'defined') | selectattr('state', 'equalto', 'Init') | list }}"
      when:
        - bfd_neighbors is defined
        - bfd_neighbors | length > 0

    - name: Group BFD sessions by VRF
      ansible.builtin.set_fact:
        bfd_sessions_by_vrf: "{{ bfd_neighbor_table.TABLE_vrf.ROW_vrf | items2dict(key_name='vrf-name-out', value_name='TABLE_adj') if bfd_neighbor_table.TABLE_vrf is defined else {} }}"
      when:
        - bfd_neighbor_table is defined
        - bfd_neighbor_table.TABLE_vrf is defined

    - name: Validate BFD interface configuration
      ansible.builtin.debug:
        msg:
          - "=== BFD Interface Configuration ==="
          - "BFD-Enabled Interfaces: {{ bfd_interfaces_config | length }}"
          - "{% for intf in bfd_interfaces_config[:10] %}"
          - "  - {{ intf.name }}: echo={{ intf.echo | default('disabled') }}, interval={{ intf.interval | default('N/A') }}"
          - "{% endfor %}"
      when:
        - show_debug | bool
        - bfd_interfaces_config is defined
        - bfd_interfaces_config | length > 0

    - name: Validate BFD neighbor sessions
      ansible.builtin.debug:
        msg:
          - "=== BFD Neighbor Sessions ==="
          - "Total Sessions: {{ bfd_neighbors | length }}"
          - "Sessions Up: {{ bfd_sessions_up | length if bfd_sessions_up is defined else 0 }}"
          - "Sessions Down: {{ bfd_sessions_down | length if bfd_sessions_down is defined else 0 }}"
          - "Sessions AdminDown: {{ bfd_sessions_admin_down | length if bfd_sessions_admin_down is defined else 0 }}"
          - "Sessions Init: {{ bfd_sessions_init | length if bfd_sessions_init is defined else 0 }}"
      when:
        - show_debug | bool
        - bfd_neighbors is defined

    - name: Check for BFD sessions in Down state
      ansible.builtin.debug:
        msg: "WARNING: {{ bfd_sessions_down | length }} BFD sessions are DOWN"
      when:
        - bfd_sessions_down is defined
        - bfd_sessions_down | length > 0

    - name: Display BFD sessions in non-Up states
      ansible.builtin.debug:
        msg:
          - "BFD Sessions Requiring Attention:"
          - "{% for session in bfd_sessions_down | default([]) %}"
          - "  - DOWN: {{ session.ld_rd }} to {{ session.dest_addr }} ({{ session.intf }})"
          - "{% endfor %}"
          - "{% for session in bfd_sessions_init | default([]) %}"
          - "  - INIT: {{ session.ld_rd }} to {{ session.dest_addr }} ({{ session.intf }})"
          - "{% endfor %}"
      when:
        - show_debug | bool
        - (bfd_sessions_down is defined and bfd_sessions_down | length > 0) or (bfd_sessions_init is defined and bfd_sessions_init | length > 0)

- name: Store BFD baseline (NX-OS)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
  ansible.builtin.set_fact:
    bfd_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      bfd_configured: "{{ bfd_configured | default(false) }}"
      bfd_enabled_interfaces: "{{ bfd_interfaces_config | length if bfd_interfaces_config is defined else 0 }}"
      total_sessions: "{{ bfd_neighbors | length if bfd_neighbors is defined else 0 }}"
      sessions_up: "{{ bfd_sessions_up | length if bfd_sessions_up is defined else 0 }}"
      sessions_down: "{{ bfd_sessions_down | length if bfd_sessions_down is defined else 0 }}"
      sessions_admin_down: "{{ bfd_sessions_admin_down | length if bfd_sessions_admin_down is defined else 0 }}"
      sessions_init: "{{ bfd_sessions_init | length if bfd_sessions_init is defined else 0 }}"

- name: Store BFD baseline for check mode
  when:
    - ansible_check_mode
  ansible.builtin.set_fact:
    bfd_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      bfd_configured: false
      bfd_enabled_interfaces: 0
      total_sessions: 0
      sessions_up: 0
      sessions_down: 0
      sessions_admin_down: 0
      sessions_init: 0

- name: BFD validation summary
  ansible.builtin.debug:
    msg:
      - "=== BFD Validation Results ==="
      - "BFD Configured: {{ bfd_baseline.bfd_configured }}"
      - "BFD-Enabled Interfaces: {{ bfd_baseline.bfd_enabled_interfaces }}"
      - "Total BFD Sessions: {{ bfd_baseline.total_sessions }}"
      - "Sessions Up: {{ bfd_baseline.sessions_up }}"
      - "Sessions Down: {{ bfd_baseline.sessions_down }}"
      - "Sessions AdminDown: {{ bfd_baseline.sessions_admin_down }}"
      - "Sessions Init: {{ bfd_baseline.sessions_init }}"
      - "Overall Status: {{ 'HEALTHY' if bfd_baseline.sessions_up | int == bfd_baseline.total_sessions | int and bfd_baseline.total_sessions | int > 0 else ('NOT CONFIGURED' if bfd_baseline.total_sessions | int == 0 else 'DEGRADED') }}"
      - "============================"

- name: IOS-XE BFD Validation (placeholder for future implementation)
  when:
    - platform == 'ios'
    - not ansible_check_mode
  block:
    - name: Get BFD information (IOS-XE)
      cisco.ios.ios_command:
        commands:
          - show bfd neighbors
          - show bfd summary
      register: ios_bfd_info

    - name: Store IOS-XE BFD baseline (placeholder)
      ansible.builtin.set_fact:
        bfd_baseline:
          timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
          bfd_configured: false
          platform: "ios"
          raw_output: "{{ ios_bfd_info.stdout }}"
