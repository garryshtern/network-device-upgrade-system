---
# Routing Protocol Validation
# Validates RIB, FIB, and route consistency (static, BGP, connected routes only)
# Uses pre-gathered data from connectivity-check (nxos_validation_data)
# DESIGN: Single block pattern with platform gate
#
# FEATURES:
# - RIB (Routing Information Base) analysis
# - FIB (Forwarding Information Base) analysis
# - RIB-FIB consistency checking
# - Route type breakdown: static, BGP, connected
# - No OSPF or EIGRP validation (removed per requirements)

- name: NX-OS Routing Validation (uses pre-gathered RIB/FIB from connectivity-check)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
  block:
    - name: Extract RIB and FIB from pre-gathered data
      ansible.builtin.set_fact:
        rib_data: "{{ nxos_validation_data.stdout[2] }}"
        fib_data: "{{ nxos_validation_data.stdout[3] }}"
      when:
        - nxos_validation_data is defined
        - nxos_validation_data.stdout is defined

    - name: Parse RIB data (routing table)
      ansible.builtin.set_fact:
        routing_table: "{{ rib_data if rib_data is mapping else (rib_data | from_json) }}"
      when:
        - rib_data is defined

    - name: Parse FIB data (forwarding table)
      ansible.builtin.set_fact:
        forwarding_table: "{{ fib_data if fib_data is mapping else (fib_data | from_json) }}"
      when:
        - fib_data is defined

    - name: Extract route counts from RIB
      ansible.builtin.set_fact:
        total_routes: >-
          {{
            routing_table.TABLE_vrf.ROW_vrf
            | map(attribute='TABLE_addrf')
            | map(attribute='ROW_addrf')
            | map(attribute='TABLE_prefix')
            | map(attribute='ROW_prefix')
            | flatten
            | length
          }}
        static_routes: >-
          {{
            routing_table.TABLE_vrf.ROW_vrf
            | map(attribute='TABLE_addrf')
            | map(attribute='ROW_addrf')
            | map(attribute='TABLE_prefix')
            | map(attribute='ROW_prefix')
            | flatten
            | selectattr('ucast_nhops.TABLE_path.ROW_path.clientname', 'defined')
            | selectattr('ucast_nhops.TABLE_path.ROW_path.clientname', 'equalto', 'static')
            | list
          }}
        connected_routes: >-
          {{
            routing_table.TABLE_vrf.ROW_vrf
            | map(attribute='TABLE_addrf')
            | map(attribute='ROW_addrf')
            | map(attribute='TABLE_prefix')
            | map(attribute='ROW_prefix')
            | flatten
            | selectattr('ucast_nhops.TABLE_path.ROW_path.clientname', 'defined')
            | selectattr('ucast_nhops.TABLE_path.ROW_path.clientname', 'equalto', 'direct')
            | list
          }}
        bgp_routes: >-
          {{
            routing_table.TABLE_vrf.ROW_vrf
            | map(attribute='TABLE_addrf')
            | map(attribute='ROW_addrf')
            | map(attribute='TABLE_prefix')
            | map(attribute='ROW_prefix')
            | flatten
            | selectattr('ucast_nhops.TABLE_path.ROW_path.clientname', 'defined')
            | selectattr('ucast_nhops.TABLE_path.ROW_path.clientname', 'equalto', 'bgp')
            | list
          }}
      when:
        - routing_table is defined
        - routing_table.TABLE_vrf is defined

    - name: Extract FIB statistics
      ansible.builtin.set_fact:
        fib_entries: >-
          {{
            forwarding_table.TABLE_vrf.ROW_vrf
            | map(attribute='TABLE_prefix')
            | map(attribute='ROW_prefix')
            | flatten
            | length
          }}
      when:
        - forwarding_table is defined
        - forwarding_table.TABLE_vrf is defined

    - name: Validate RIB-FIB consistency
      ansible.builtin.set_fact:
        rib_fib_consistent: "{{ (total_routes | int) == (fib_entries | int) }}"
        rib_fib_variance: "{{ ((total_routes | int) - (fib_entries | int)) | abs }}"
      when:
        - total_routes is defined
        - fib_entries is defined

    - name: Debug RIB and FIB comparison
      ansible.builtin.debug:
        msg:
          - "=== RIB/FIB Validation ==="
          - "RIB Entries: {{ total_routes }}"
          - "FIB Entries: {{ fib_entries }}"
          - "Consistent: {{ rib_fib_consistent }}"
          - "Variance: {{ rib_fib_variance }}"
      when:
        - show_debug | bool
        - total_routes is defined
        - fib_entries is defined

    - name: Verify static routes presence
      ansible.builtin.debug:
        msg: |
          Static Routes Found: {{ static_routes | length }}
          {% for route in static_routes[:10] %}
          - {{ route.ipprefix }}: via {{ route.ucast_nhops.TABLE_path.ROW_path.ipnexthop | default('N/A') }}
          {% endfor %}
      when:
        - static_routes is defined
        - static_routes | length > 0

    - name: Validate BGP routes presence
      ansible.builtin.debug:
        msg: |
          BGP Routes Found: {{ bgp_routes | length }}
          {% for route in bgp_routes[:10] %}
          - {{ route.ipprefix }}: via {{ route.ucast_nhops.TABLE_path.ROW_path.ipnexthop | default('N/A') }}
          {% endfor %}
      when:
        - bgp_routes is defined
        - bgp_routes | length > 0

    - name: Check route table health
      ansible.builtin.assert:
        that:
          - total_routes | int > 0
        fail_msg: "Routing table appears to be empty"
      when:
        - total_routes is defined

    - name: Validate connected routes
      ansible.builtin.debug:
        msg: |
          Connected Routes: {{ connected_routes | length }}
          {% for route in connected_routes[:10] %}
          - {{ route.ipprefix }} via {{ route.ucast_nhops.TABLE_path.ROW_path.ifname }}
          {% endfor %}
      when:
        - connected_routes is defined
        - connected_routes | length > 0


- name: Store routing baseline (NX-OS)
  when:
    - platform == 'nxos'
    - not ansible_check_mode
  ansible.builtin.set_fact:
    routing_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      total_routes: "{{ total_routes | default(0) }}"
      fib_entries: "{{ fib_entries | default(0) }}"
      rib_fib_consistent: "{{ rib_fib_consistent | default(true) }}"
      rib_fib_variance: "{{ rib_fib_variance | default(0) }}"
      static_routes_count: "{{ static_routes | length if static_routes is defined else 0 }}"
      connected_routes_count: "{{ connected_routes | length if connected_routes is defined else 0 }}"
      bgp_routes_count: "{{ bgp_routes | length if bgp_routes is defined else 0 }}"

- name: Store routing baseline for check mode
  when:
    - ansible_check_mode
  ansible.builtin.set_fact:
    routing_baseline:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      total_routes: 0
      fib_entries: 0
      rib_fib_consistent: true
      rib_fib_variance: 0
      static_routes_count: 0
      connected_routes_count: 0
      bgp_routes_count: 0

- name: Routing validation summary
  ansible.builtin.debug:
    msg:
      - "=== Routing Validation Results ==="
      - "RIB Total Routes: {{ routing_baseline.total_routes }}"
      - "FIB Total Entries: {{ routing_baseline.fib_entries }}"
      - "RIB-FIB Consistent: {{ routing_baseline.rib_fib_consistent }}"
      - "RIB-FIB Variance: {{ routing_baseline.rib_fib_variance }}"
      - "Static Routes: {{ routing_baseline.static_routes_count }}"
      - "Connected Routes: {{ routing_baseline.connected_routes_count }}"
      - "BGP Routes: {{ routing_baseline.bgp_routes_count }}"
      - "Status: {{ 'HEALTHY' if routing_baseline.total_routes | int > 0 else 'CHECK REQUIRED' }}"
      - "================================="

- name: IOS-XE Routing Validation (placeholder for future implementation)
  when:
    - platform == 'ios'
    - not ansible_check_mode
  block:
    - name: Get routing table (IOS-XE)
      cisco.ios.ios_command:
        commands:
          - show ip route summary
          - show ip route
      register: ios_routing_info

    - name: Store IOS-XE routing baseline (placeholder)
      ansible.builtin.set_fact:
        routing_baseline:
          timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
          total_routes: 0
          platform: "ios"
          raw_output: "{{ ios_routing_info.stdout }}"
