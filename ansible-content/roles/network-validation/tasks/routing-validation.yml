---
# Routing Data Validation
# Compares RIB (Routing Information Base) and FIB (Forwarding Information Base) data
# Validates all routing state before operational state validation
#
# DESIGN: Extract complete rib_data and fib_data dicts from baseline data, normalize, compare using difference(), report only deltas
# DATA SOURCES:
# - RIB data: network_baseline.rib_data (from 'show ip route vrf all')
# - FIB data: network_baseline.fib_data (from 'show forwarding ipv4 route')
# - Pre-upgrade baseline: network_baseline_pre
# - Post-upgrade baseline: network_baseline_post

# Post-upgrade comparison for RIB and FIB data
- name: Compare RIB and FIB data with baseline (post-upgrade only)
  when:
    - validation_phase is defined
    - validation_phase == 'post_upgrade'
    - platform == 'nxos'
    - not ansible_check_mode
    - network_baseline_pre is defined
    - network_baseline_post is defined
  block:
    # RIB Data Comparison
    - name: Normalize RIB pre-upgrade data
      ansible.builtin.include_tasks: normalize-baseline-data.yml
      vars:
        data_to_normalize: "{{ network_baseline_pre.rib_data }}"
        fields_to_exclude: "{{ baseline_comparison_excluded_fields.rib_data if baseline_comparison_excluded_fields.rib_data is defined else [] }}"

    - name: Store normalized RIB pre data
      ansible.builtin.set_fact:
        rib_pre_normalized: "{{ normalized_data }}"

    - name: Normalize RIB post-upgrade data
      ansible.builtin.include_tasks: normalize-baseline-data.yml
      vars:
        data_to_normalize: "{{ network_baseline_post.rib_data }}"
        fields_to_exclude: "{{ baseline_comparison_excluded_fields.rib_data if baseline_comparison_excluded_fields.rib_data is defined else [] }}"

    - name: Calculate RIB and FIB deltas using difference filter
      ansible.builtin.set_fact:
        rib_post_normalized: "{{ normalized_data }}"
        rib_added: "{{ normalized_data | difference(rib_pre_normalized) }}"
        rib_removed: "{{ rib_pre_normalized | difference(normalized_data) }}"
        rib_comparison_match: "{{ normalized_data == rib_pre_normalized }}"

    - name: Normalize FIB pre-upgrade data
      ansible.builtin.include_tasks: normalize-baseline-data.yml
      vars:
        data_to_normalize: "{{ network_baseline_pre.fib_data }}"
        fields_to_exclude: "{{ baseline_comparison_excluded_fields.fib_data if baseline_comparison_excluded_fields.fib_data is defined else [] }}"

    - name: Store normalized FIB pre data
      ansible.builtin.set_fact:
        fib_pre_normalized: "{{ normalized_data }}"

    - name: Normalize FIB post-upgrade data
      ansible.builtin.include_tasks: normalize-baseline-data.yml
      vars:
        data_to_normalize: "{{ network_baseline_post.fib_data }}"
        fields_to_exclude: "{{ baseline_comparison_excluded_fields.fib_data if baseline_comparison_excluded_fields.fib_data is defined else [] }}"

    - name: Calculate FIB deltas using difference filter
      ansible.builtin.set_fact:
        fib_post_normalized: "{{ normalized_data }}"
        fib_added: "{{ normalized_data | difference(fib_pre_normalized) }}"
        fib_removed: "{{ fib_pre_normalized | difference(normalized_data) }}"
        fib_comparison_match: "{{ normalized_data == fib_pre_normalized }}"

    - name: Report RIB added entries
      ansible.builtin.debug:
        msg:
          - "=== RIB and FIB Data Comparison ==="
          - "Added/Modified RIB Entries:"
          - "{{ rib_added | to_nice_json }}"
      when: rib_added | length > 0

    - name: Report RIB removed entries
      ansible.builtin.debug:
        msg:
          - "=== RIB and FIB Data Comparison ==="
          - "Removed RIB Entries:"
          - "{{ rib_removed | to_nice_json }}"
      when: rib_removed | length > 0

    - name: Report FIB added entries
      ansible.builtin.debug:
        msg:
          - "=== RIB and FIB Data Comparison ==="
          - "Added/Modified FIB Entries:"
          - "{{ fib_added | to_nice_json }}"
      when: fib_added | length > 0

    - name: Report FIB removed entries
      ansible.builtin.debug:
        msg:
          - "=== RIB and FIB Data Comparison ==="
          - "Removed FIB Entries:"
          - "{{ fib_removed | to_nice_json }}"
      when: fib_removed | length > 0

    - name: Report no RIB and FIB changes
      ansible.builtin.debug:
        msg:
          - "=== RIB and FIB Data Comparison ==="
          - "Status: No changes detected in RIB and FIB data"
      when: rib_comparison_match and fib_comparison_match and rib_added | length == 0 and rib_removed | length == 0 and fib_added | length == 0 and fib_removed | length == 0

    - name: Determine routing comparison status
      ansible.builtin.set_fact:
        routing_comparison_status: "{{ 'PASS' if rib_comparison_match and fib_comparison_match else 'FAIL' }}"

- name: Set routing comparison status when not applicable
  when:
    - validation_phase is not defined or validation_phase != 'post_upgrade' or
      platform != 'nxos' or
      network_baseline_pre is not defined or network_baseline_post is not defined
  ansible.builtin.set_fact:
    routing_comparison_status: "NOT_RUN"
