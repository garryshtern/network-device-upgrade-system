---
# BGP Operational State Validation
# Compares entire bgp_data (operational BGP state: neighbors, prefixes, session states)
# Validates all BGP operational state before comparison with baseline
#
# DESIGN: Extract complete bgp_data dict from baseline data, compare using difference(), report only deltas
# DATA SOURCES:
# - BGP data: network_baseline.bgp_data (gathered from 'show bgp summary' or similar operational commands)
# - Pre-upgrade baseline: network_baseline_pre
# - Post-upgrade baseline: network_baseline_post

# Post-upgrade comparison for BGP operational state
- name: Compare BGP operational state with baseline (post-upgrade only)
  when:
    - validation_phase is defined
    - validation_phase == 'post_upgrade'
    - platform == 'nxos'
    - not ansible_check_mode
    - network_baseline_pre is defined
    - network_baseline_post is defined
    - bgp_enabled | bool
  block:
    - name: Calculate BGP operational state deltas using difference filter
      ansible.builtin.set_fact:
        bgp_added: "{{ network_baseline_post.bgp_data | difference(network_baseline_pre.bgp_data) }}"
        bgp_removed: "{{ network_baseline_pre.bgp_data | difference(network_baseline_post.bgp_data) }}"
        bgp_comparison_match: "{{ network_baseline_post.bgp_data == network_baseline_pre.bgp_data }}"

    - name: Report BGP added changes
      ansible.builtin.debug:
        msg:
          - "=== BGP Operational State Changes ==="
          - "Added/Modified BGP State:"
          - "{{ bgp_added | to_nice_json }}"
      when: bgp_added | length > 0

    - name: Report BGP removed changes
      ansible.builtin.debug:
        msg:
          - "=== BGP Operational State Changes ==="
          - "Removed BGP State:"
          - "{{ bgp_removed | to_nice_json }}"
      when: bgp_removed | length > 0

    - name: Report no BGP changes
      ansible.builtin.debug:
        msg:
          - "=== BGP Operational State Changes ==="
          - "Status: No changes detected in BGP operational state"
      when: bgp_comparison_match and bgp_added | length == 0 and bgp_removed | length == 0

    - name: Determine BGP comparison status
      ansible.builtin.set_fact:
        bgp_comparison_status: "{{ 'PASS' if bgp_comparison_match else 'FAIL' }}"

- name: Set BGP comparison status when not applicable
  when:
    - validation_phase is not defined or validation_phase != 'post_upgrade' or
      platform != 'nxos' or
      not (bgp_enabled | bool) or
      network_baseline_pre is not defined or network_baseline_post is not defined
  ansible.builtin.set_fact:
    bgp_comparison_status: "NOT_RUN"
