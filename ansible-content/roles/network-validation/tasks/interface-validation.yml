---
# Interface State Validation
# Validates interface configuration and operational status
# Compares pre/post upgrade interface state
#
# DESIGN: Extract interface dictionaries from baseline data, normalize, compare, report deltas
# DATA SOURCES:
# - Interface config: network_baseline.network_resources.interfaces
# - Pre-upgrade baseline: network_baseline_pre
# - Post-upgrade baseline: network_baseline_post

# Post-upgrade comparison for interface state
- name: Compare interface configuration with baseline (post-upgrade only)
  when:
    - validation_phase is defined
    - validation_phase == 'post_upgrade'
    - platform == 'nxos'
    - not ansible_check_mode
    - network_baseline_pre is defined
    - network_baseline_post is defined
    - network_baseline_pre.network_resources is defined
    - network_baseline_post.network_resources is defined
    - network_baseline_pre.network_resources.interfaces is defined
    - network_baseline_post.network_resources.interfaces is defined
  block:
    - name: Normalize interface pre-upgrade data
      ansible.builtin.include_tasks: normalize-baseline-data.yml
      vars:
        data_to_normalize: "{{ network_baseline_pre.network_resources.interfaces }}"
        fields_to_exclude: "{{ baseline_comparison_excluded_fields.interfaces if baseline_comparison_excluded_fields.interfaces is defined else [] }}"

    - name: Store normalized interface pre data
      ansible.builtin.set_fact:
        interface_pre_normalized: "{{ normalized_data }}"

    - name: Normalize interface post-upgrade data
      ansible.builtin.include_tasks: normalize-baseline-data.yml
      vars:
        data_to_normalize: "{{ network_baseline_post.network_resources.interfaces }}"
        fields_to_exclude: "{{ baseline_comparison_excluded_fields.interfaces if baseline_comparison_excluded_fields.interfaces is defined else [] }}"

    - name: Calculate interface deltas (added/removed/modified)
      ansible.builtin.set_fact:
        interface_post_normalized: "{{ normalized_data }}"
        interface_added: "{{ normalized_data | difference(interface_pre_normalized) }}"
        interface_removed: "{{ interface_pre_normalized | difference(normalized_data) }}"
        interface_comparison_match: "{{ normalized_data == interface_pre_normalized }}"

    - name: Report interface comparison deltas (if any)
      ansible.builtin.debug:
        msg:
          - "=== Interface Configuration Changes ==="
          - "Pre-upgrade interfaces: {{ network_baseline_pre.network_resources.interfaces | length }}"
          - "Post-upgrade interfaces: {{ network_baseline_post.network_resources.interfaces | length }}"
          - "{{ '' if interface_added | length == 0 else 'Added Interfaces:' }}"
          - "{{ interface_added | to_nice_json if interface_added | length > 0 else '' }}"
          - "{{ '' if interface_removed | length == 0 else 'Removed Interfaces:' }}"
          - "{{ interface_removed | to_nice_json if interface_removed | length > 0 else '' }}"
      when: interface_added | length > 0 or interface_removed | length > 0

    - name: Report no interface changes
      ansible.builtin.debug:
        msg:
          - "=== Interface Configuration Changes ==="
          - "Status: No changes detected"
      when: interface_added | length == 0 and interface_removed | length == 0

    - name: Determine interface comparison status
      ansible.builtin.set_fact:
        interface_comparison_status: "{{ 'PASS' if interface_comparison_match else 'FAIL' }}"

- name: Set interface comparison status when not applicable
  when:
    - validation_phase is not defined or validation_phase != 'post_upgrade' or
      platform != 'nxos' or
      network_baseline_pre is not defined or network_baseline_post is not defined or
      network_baseline_pre.network_resources is not defined or network_baseline_post.network_resources is not defined or
      network_baseline_pre.network_resources.interfaces is not defined or network_baseline_post.network_resources.interfaces is not defined
  ansible.builtin.set_fact:
    interface_comparison_status: "NOT_RUN"
