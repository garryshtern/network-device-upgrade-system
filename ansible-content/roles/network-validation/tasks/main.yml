---
# Network Validation Role - Main Tasks
# Comprehensive network state validation and comparison

- name: Initialize validation baselines
  ansible.builtin.set_fact:
    interface_baseline:
      up_interfaces: 0
      total_interfaces: 0
    routing_baseline:
      total_routes: 0
    arp_baseline:
      total_arp_entries: 0
    bgp_validation:
      bgp_configured: false
      peers_established: 0

- name: Run BGP validation
  ansible.builtin.include_tasks: bgp-validation.yml
  when: bgp_enabled

- name: Run interface validation
  ansible.builtin.include_tasks: interface-validation.yml

- name: Run routing validation
  ansible.builtin.include_tasks: routing-validation.yml

- name: Run ARP validation
  ansible.builtin.include_tasks: arp-validation.yml

- name: Run multicast validation
  ansible.builtin.include_tasks: multicast-validation.yml
  when: multicast_enabled

- name: Run protocol convergence validation
  ansible.builtin.include_tasks: protocol-convergence.yml

- name: Aggregate validation results (check mode)
  ansible.builtin.set_fact:
    network_validation_results:
      overall_status: "healthy"
      interface_status: "check_mode"
      routing_status: "check_mode"
      arp_status: "check_mode"
      bgp_status: "check_mode"
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
  when: ansible_check_mode

- name: Aggregate validation results (normal mode)
  ansible.builtin.set_fact:
    network_validation_results:
      overall_status: "{{ 'healthy' if (interface_baseline.up_interfaces | int > 0) and (routing_baseline.total_routes | int > 0) else 'unhealthy' }}"
      interface_status: "{{ 'healthy' if interface_baseline.up_interfaces | int > 0 else 'unhealthy' }}"
      routing_status: "{{ 'healthy' if routing_baseline.total_routes | int > 0 else 'unhealthy' }}"
      arp_status: "{{ 'healthy' if arp_baseline.total_arp_entries | int > 0 else 'warning' }}"
      bgp_status: "{{ 'healthy' if bgp_validation.bgp_configured and bgp_validation.peers_established | int > 0 else 'skipped' }}"
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
  when: not ansible_check_mode
