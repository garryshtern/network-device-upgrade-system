---
# Network Validation Role - Main Tasks
# Comprehensive network state validation and comparison
# PREREQUISITE: Caller MUST call network-resources-gathering BEFORE this role
#
# DESIGN: Single when clause for all platform-specific tasks
# All NX-OS validation tasks grouped under one block with single platform gate

- name: Display network validation entry
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "ENTERING NETWORK-VALIDATION ROLE"
      - "=========================================="
      - "Device: {{ inventory_hostname }}"
      - "Platform: {{ platform }}"
      - "Validation Phase: {{ validation_phase | default('not specified') }}"
      - "WARNING: Facts MUST be gathered before this role"
      - "=========================================="

- name: NX-OS Network Validation
  when: platform == 'nxos'
  block:
    - name: Initialize all comparison status variables to NOT_RUN
      ansible.builtin.set_fact:
        interface_comparison_status: "NOT_RUN"
        arp_mac_comparison_status: "NOT_RUN"
        bgp_comparison_status: "NOT_RUN"
        routing_comparison_status: "NOT_RUN"
        bfd_comparison_status: "NOT_RUN"
        multicast_comparison_status: "NOT_RUN"

    - name: Run network resource validation (first - foundation for all comparisons)
      ansible.builtin.include_tasks: network-resource-validation.yml

    - name: Run ARP and MAC validation (second - baseline comparison)
      ansible.builtin.include_tasks: arp-validation.yml

    - name: Run BGP validation
      ansible.builtin.include_tasks: bgp-validation.yml
      when: bgp_enabled | bool

    - name: Run routing validation
      ansible.builtin.include_tasks: routing-validation.yml

    - name: Run multicast validation
      ansible.builtin.include_tasks: multicast-validation.yml
      when: multicast_enabled | bool

    - name: Run BFD validation
      ansible.builtin.include_tasks: bfd-validation.yml
      when: bfd_enabled | bool

# POST-UPGRADE COMPARISON VALIDATION RESULTS
# Aggregates comparison status between pre/post upgrade baselines
# All status variables initialized to NOT_RUN at block start, then overridden by validation tasks
- name: Aggregate comparison validation results
  ansible.builtin.set_fact:
    validation_comparison_results:
      network_resources_status: "{{ interface_comparison_status }}"
      arp_mac_status: "{{ arp_mac_comparison_status }}"
      bgp_status: "{{ bgp_comparison_status }}"
      routing_status: "{{ routing_comparison_status }}"
      bfd_status: "{{ bfd_comparison_status }}"
      multicast_status: "{{ multicast_comparison_status }}"
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
  when: platform == 'nxos'
