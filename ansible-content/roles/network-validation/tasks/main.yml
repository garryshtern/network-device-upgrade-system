---
# Network Validation Role - Main Tasks
# Comprehensive network state validation and comparison
# PREREQUISITE: Caller MUST call network-resources-gathering BEFORE this role
#
# DESIGN: Single when clause for all platform-specific tasks
# All NX-OS validation tasks grouped under one block with single platform gate

- name: NX-OS Network Validation
  when: platform == 'nxos'
  block:
    - name: Initialize validation baselines
      ansible.builtin.set_fact:
        interface_baseline:
          up_interfaces: 0
          total_interfaces: 0
        routing_baseline:
          total_routes: 0
        arp_baseline:
          total_arp_entries: 0
        bfd_baseline:
          total_sessions: 0
          sessions_up: 0

    - name: Run BGP validation
      ansible.builtin.include_tasks: bgp-validation.yml
      when: bgp_enabled | bool

    - name: Run interface validation
      ansible.builtin.include_tasks: interface-validation.yml

    - name: Run routing validation
      ansible.builtin.include_tasks: routing-validation.yml

    - name: Run ARP validation
      ansible.builtin.include_tasks: arp-validation.yml

    - name: Run multicast validation
      ansible.builtin.include_tasks: multicast-validation.yml
      when: multicast_enabled | bool

    - name: Run BFD validation
      ansible.builtin.include_tasks: bfd-validation.yml
      when: bfd_enabled | bool

- name: Aggregate validation results (check mode)
  ansible.builtin.set_fact:
    network_validation_results:
      overall_status: "healthy"
      interface_status: "check_mode"
      routing_status: "check_mode"
      arp_status: "check_mode"
      bgp_status: "check_mode"
      bfd_status: "check_mode"
      comparison_status: "passed"
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
  when: ansible_check_mode

- name: Aggregate validation results (normal mode - no comparison)
  ansible.builtin.set_fact:
    network_validation_results:
      overall_status: "{{ 'healthy' if (interface_baseline.up_interfaces | int > 0) and (routing_baseline.total_routes | int > 0) else 'unhealthy' }}"
      interface_status: "{{ 'healthy' if interface_baseline.up_interfaces | int > 0 else 'unhealthy' }}"
      routing_status: "{{ 'healthy' if routing_baseline.total_routes | int > 0 else 'unhealthy' }}"
      arp_status: "{{ 'healthy' if arp_baseline.total_arp_entries | int > 0 else 'warning' }}"
      bgp_status: "{{ 'healthy' if bgp_validation.bgp_configured and bgp_validation.peers_established | int > 0 else 'skipped' }}"
      bfd_status: "{{ 'healthy' if bfd_baseline.bfd_configured and bfd_baseline.sessions_up | int == bfd_baseline.total_sessions | int and bfd_baseline.total_sessions | int > 0 else ('not_configured' if bfd_baseline.total_sessions | int == 0 else 'degraded') }}"
      comparison_status: "not_applicable"
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
  when:
    - not ansible_check_mode
    - not compare_to_baseline

- name: Aggregate validation results (normal mode - with comparison)
  ansible.builtin.set_fact:
    network_validation_results:
      overall_status: "{{ 'healthy' if (interface_baseline.up_interfaces | int > 0) and (routing_baseline.total_routes | int > 0) else 'unhealthy' }}"
      interface_status: "{{ 'healthy' if interface_baseline.up_interfaces | int > 0 else 'unhealthy' }}"
      routing_status: "{{ 'healthy' if routing_baseline.total_routes | int > 0 else 'unhealthy' }}"
      arp_status: "{{ 'healthy' if arp_baseline.total_arp_entries | int > 0 else 'warning' }}"
      bgp_status: "{{ 'healthy' if bgp_validation.bgp_configured and bgp_validation.peers_established | int > 0 else 'skipped' }}"
      bfd_status: "{{ 'healthy' if bfd_baseline.bfd_configured and bfd_baseline.sessions_up | int == bfd_baseline.total_sessions | int and bfd_baseline.total_sessions | int > 0 else ('not_configured' if bfd_baseline.total_sessions | int == 0 else 'degraded') }}"
      comparison_status: "passed"
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
  when:
    - not ansible_check_mode
    - compare_to_baseline
