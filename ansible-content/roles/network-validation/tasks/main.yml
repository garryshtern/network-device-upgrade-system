---
# Network Validation Role - Main Tasks
# Comprehensive network state validation and comparison
# STRICT GATE: Uses platform-specific facts gathered in connectivity-check

- name: Validate platform and pre-gathered facts for NX-OS
  when: platform == 'nxos'
  block:
    - name: Enforce NX-OS facts availability
      ansible.builtin.assert:
        that:
          - ansible_network_resources is defined
          - ansible_network_resources.interfaces is defined
        fail_msg: "NX-OS facts not pre-gathered. Connectivity-check must run first."
        success_msg: "NX-OS facts verified - proceeding with validation"

- name: Initialize validation baselines
  ansible.builtin.set_fact:
    interface_baseline:
      up_interfaces: 0
      total_interfaces: 0
    routing_baseline:
      total_routes: 0
    arp_baseline:
      total_arp_entries: 0

- name: Run BGP validation (NX-OS only)
  ansible.builtin.include_tasks: bgp-validation.yml
  when:
    - platform == 'nxos'
    - bgp_enabled | bool

- name: Run interface validation (NX-OS only)
  ansible.builtin.include_tasks: interface-validation.yml
  when: platform == 'nxos'

- name: Run routing validation (NX-OS only)
  ansible.builtin.include_tasks: routing-validation.yml
  when: platform == 'nxos'

- name: Run ARP validation (NX-OS only)
  ansible.builtin.include_tasks: arp-validation.yml
  when: platform == 'nxos'

- name: Run multicast validation (NX-OS only)
  ansible.builtin.include_tasks: multicast-validation.yml
  when:
    - platform == 'nxos'
    - multicast_enabled | bool

- name: Run protocol convergence validation (NX-OS only)
  ansible.builtin.include_tasks: protocol-convergence.yml
  when: platform == 'nxos'

- name: Aggregate validation results (check mode)
  ansible.builtin.set_fact:
    network_validation_results:
      overall_status: "healthy"
      interface_status: "check_mode"
      routing_status: "check_mode"
      arp_status: "check_mode"
      bgp_status: "check_mode"
      comparison_status: "passed"
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
  when: ansible_check_mode

- name: Aggregate validation results (normal mode - no comparison)
  ansible.builtin.set_fact:
    network_validation_results:
      overall_status: "{{ 'healthy' if (interface_baseline.up_interfaces | int > 0) and (routing_baseline.total_routes | int > 0) else 'unhealthy' }}"
      interface_status: "{{ 'healthy' if interface_baseline.up_interfaces | int > 0 else 'unhealthy' }}"
      routing_status: "{{ 'healthy' if routing_baseline.total_routes | int > 0 else 'unhealthy' }}"
      arp_status: "{{ 'healthy' if arp_baseline.total_arp_entries | int > 0 else 'warning' }}"
      bgp_status: "{{ 'healthy' if bgp_validation.bgp_configured and bgp_validation.peers_established | int > 0 else 'skipped' }}"
      comparison_status: "not_applicable"
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
  when:
    - not ansible_check_mode
    - not compare_to_baseline

- name: Aggregate validation results (normal mode - with comparison)
  ansible.builtin.set_fact:
    network_validation_results:
      overall_status: "{{ 'healthy' if (interface_baseline.up_interfaces | int > 0) and (routing_baseline.total_routes | int > 0) else 'unhealthy' }}"
      interface_status: "{{ 'healthy' if interface_baseline.up_interfaces | int > 0 else 'unhealthy' }}"
      routing_status: "{{ 'healthy' if routing_baseline.total_routes | int > 0 else 'unhealthy' }}"
      arp_status: "{{ 'healthy' if arp_baseline.total_arp_entries | int > 0 else 'warning' }}"
      bgp_status: "{{ 'healthy' if bgp_validation.bgp_configured and bgp_validation.peers_established | int > 0 else 'skipped' }}"
      comparison_status: "passed"
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
  when:
    - not ansible_check_mode
    - compare_to_baseline
