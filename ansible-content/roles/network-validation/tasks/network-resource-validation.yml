---
# Network Resources Validation
# Compares entire network_resources tree (interfaces, L2/L3, VLANs, LAG, LACP, BFD, BGP config, etc.)
# Validates all configuration facts before operational state validation
#
# DESIGN: Extract complete network_resources dict from baseline data, compare, report deltas
# DATA SOURCES:
# - Complete network config: network_baseline.network_resources (all config resources)
# - Pre-upgrade baseline: network_baseline_pre
# - Post-upgrade baseline: network_baseline_post

# Post-upgrade comparison for network resources
- name: Compare network resources configuration with baseline (post-upgrade only)
  when:
    - validation_phase is defined
    - validation_phase == 'post_upgrade'
    - platform == 'nxos'
    - not ansible_check_mode
    - network_baseline_pre is defined
    - network_baseline_post is defined
    - network_baseline_pre.network_resources is defined
    - network_baseline_post.network_resources is defined
  block:
    - name: Calculate network_resources deltas
      ansible.builtin.set_fact:
        network_resources_pre: "{{ network_baseline_pre.network_resources }}"
        network_resources_post: "{{ network_baseline_post.network_resources }}"
        network_resources_comparison_match: "{{ network_baseline_post.network_resources == network_baseline_pre.network_resources }}"

    - name: Report network_resources comparison results
      ansible.builtin.debug:
        msg:
          - "=== Network Resources Configuration Changes ==="
          - "Pre-upgrade resources keys: {{ network_resources_pre.keys() | list | join(', ') }}"
          - "Post-upgrade resources keys: {{ network_resources_post.keys() | list | join(', ') }}"
          - "Match: {{ network_resources_comparison_match }}"
          - "Pre-upgrade network_resources:"
          - "{{ network_resources_pre | to_nice_json }}"
          - "Post-upgrade network_resources:"
          - "{{ network_resources_post | to_nice_json }}"

    - name: Determine network_resources comparison status
      ansible.builtin.set_fact:
        interface_comparison_status: "{{ 'PASS' if network_resources_comparison_match else 'FAIL' }}"

- name: Set network_resources comparison status when not applicable
  when:
    - validation_phase is not defined or validation_phase != 'post_upgrade' or
      platform != 'nxos' or
      network_baseline_pre is not defined or network_baseline_post is not defined or
      network_baseline_pre.network_resources is not defined or network_baseline_post.network_resources is not defined
  ansible.builtin.set_fact:
    interface_comparison_status: "NOT_RUN"
