---
# Network Resources Validation
# Compares entire network_resources tree (interfaces, L2/L3, VLANs, LAG, LACP, BFD, BGP config, etc.)
# Validates all configuration facts before operational state validation
#
# DESIGN: Extract complete network_resources dict from baseline data, compare using difference(), report only deltas
# DATA SOURCES:
# - Complete network config: network_baseline.network_resources (all config resources)
# - Pre-upgrade baseline: network_baseline_pre
# - Post-upgrade baseline: network_baseline_post

# Initialize network resources comparison status
- name: Initialize network resources comparison status
  ansible.builtin.set_fact:
    network_resources_comparison_status: "NOT_RUN"

# Post-upgrade comparison for network resources
- name: Compare network resources configuration with baseline (post-upgrade only)
  when:
    - validation_phase is defined
    - validation_phase == 'post_upgrade'
    - platform == 'nxos'
    - not ansible_check_mode
    - network_baseline_pre is defined
    - network_baseline_post is defined
    - network_baseline_pre.network_resources is defined
    - network_baseline_post.network_resources is defined
  block:
    # Network Resources - Raw Comparison (no normalization needed)
    - name: Network Resources Data Comparison
      block:
        - name: Calculate network_resources deltas using difference filter
          ansible.builtin.set_fact:
            network_resources_added: "{{ network_baseline_post.network_resources | difference(network_baseline_pre.network_resources) }}"
            network_resources_removed: "{{ network_baseline_pre.network_resources | difference(network_baseline_post.network_resources) }}"
            network_resources_comparison_match: "{{ network_baseline_post.network_resources == network_baseline_pre.network_resources }}"

        - name: Report network_resources added changes
          ansible.builtin.debug:
            msg:
              - "=== Network Resources Configuration Changes ==="
              - "Added/Modified Resources:"
              - "{{ network_resources_added | to_nice_json }}"
          when: network_resources_added | length > 0

        - name: Report network_resources removed changes
          ansible.builtin.debug:
            msg:
              - "=== Network Resources Configuration Changes ==="
              - "Removed Resources:"
              - "{{ network_resources_removed | to_nice_json }}"
          when: network_resources_removed | length > 0

        - name: Report no network_resources changes
          ansible.builtin.debug:
            msg:
              - "=== Network Resources Configuration Changes ==="
              - "Status: No changes detected in network resources configuration"
          when:
            - network_resources_comparison_match

        - name: Validate network resources comparison passed
          ansible.builtin.assert:
            that:
              - network_resources_comparison_match | bool
            fail_msg:
              - "CRITICAL: Network validation failed - Network resources mismatch detected"
              - "This indicates network configuration changed during upgrade"
              - "Network resources added: {{ network_resources_added | length }}"
              - "Network resources removed: {{ network_resources_removed | length }}"
              - "RECOMMENDATION: Investigate configuration changes or rollback upgrade"

        - name: Set network resources comparison success status
          ansible.builtin.set_fact:
            network_resources_comparison_status: "PASS"
