---
# Generate detailed baseline deltas for failed comparisons
# Shows exactly what changed between pre and post upgrade states
#
# Input variables:
#   - network_baseline_pre: Pre-upgrade baseline data
#   - network_baseline_post: Post-upgrade baseline data
#   - baseline_comparison: Comparison results with sections_with_differences
#   - baseline_comparison_excluded_fields: Fields to exclude from delta calculations
#
# Output variables:
#   - baseline_deltas: Detailed delta information with added/removed items per data type
#
# NOTE: Time-sensitive fields MUST be excluded before calculating deltas using difference()
#       The difference() filter compares entire dict entries, so if time fields differ,
#       no matches will be found even for structurally identical entries.

- name: Initialize baseline deltas
  ansible.builtin.set_fact:
    baseline_deltas: {}

- name: Generate deltas for mismatched sections
  block:
    # ARP Data Deltas
    - name: Calculate ARP deltas (if mismatched)
      when: "'arp_data' in baseline_comparison.sections_with_differences"
      block:
        - name: Normalize ARP pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.arp_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.arp_data }}"

        - name: Store normalized ARP pre data
          ansible.builtin.set_fact:
            arp_pre_normalized: "{{ normalized_data }}"

        - name: Normalize ARP post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.arp_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.arp_data }}"

        - name: Store normalized ARP post data and calculate deltas
          ansible.builtin.set_fact:
            arp_post_normalized: "{{ normalized_data }}"
            arp_added_items: "{{ (normalized_data) | difference(arp_pre_normalized) }}"
            arp_removed_items: "{{ arp_pre_normalized | difference(normalized_data) }}"

        - name: Record ARP deltas
          set_fact:
            arp_delta_record:
              pre_entries: "{{ network_baseline_pre.arp_data | length }}"
              post_entries: "{{ network_baseline_post.arp_data | length }}"
              change_count: "{{ arp_added_items | length + arp_removed_items | length }}"
              added: "{{ arp_added_items }}"
              removed: "{{ arp_removed_items }}"

        - name: Update baseline_deltas with ARP results
          set_fact:
            baseline_deltas: "{{ baseline_deltas | combine({'arp_data': arp_delta_record}) }}"

    # MAC Data Deltas
    - name: Calculate MAC deltas (if mismatched)
      when: "'mac_data' in baseline_comparison.sections_with_differences"
      block:
        - name: Normalize MAC pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.mac_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.mac_data }}"

        - name: Store normalized MAC pre data
          ansible.builtin.set_fact:
            mac_pre_normalized: "{{ normalized_data }}"

        - name: Normalize MAC post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.mac_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.mac_data }}"

        - name: Store normalized MAC post data and calculate deltas
          ansible.builtin.set_fact:
            mac_post_normalized: "{{ normalized_data }}"
            mac_added_items: "{{ (normalized_data) | difference(mac_pre_normalized) }}"
            mac_removed_items: "{{ mac_pre_normalized | difference(normalized_data) }}"

        - name: Record MAC deltas
          ansible.builtin.set_fact:
            mac_delta_record:
              pre_entries: "{{ network_baseline_pre.mac_data | length }}"
              post_entries: "{{ network_baseline_post.mac_data | length }}"
              change_count: "{{ mac_added_items | length + mac_removed_items | length }}"
              added: "{{ mac_added_items }}"
              removed: "{{ mac_removed_items }}"

        - name: Update baseline_deltas with MAC results
          ansible.builtin.set_fact:
            baseline_deltas: "{{ baseline_deltas | combine({'mac_data': mac_delta_record}) }}"

    # RIB Data Deltas
    - name: Calculate RIB deltas (if mismatched)
      when: "'rib_data' in baseline_comparison.sections_with_differences"
      block:
        - name: Normalize RIB pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.rib_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.rib_data }}"

        - name: Store normalized RIB pre data
          ansible.builtin.set_fact:
            rib_pre_normalized: "{{ normalized_data }}"

        - name: Normalize RIB post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.rib_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.rib_data }}"

        - name: Store normalized RIB post data and calculate deltas
          ansible.builtin.set_fact:
            rib_post_normalized: "{{ normalized_data }}"
            rib_added_items: "{{ (normalized_data) | difference(rib_pre_normalized) }}"
            rib_removed_items: "{{ rib_pre_normalized | difference(normalized_data) }}"

        - name: Record RIB deltas
          ansible.builtin.set_fact:
            rib_delta_record:
              pre_entries: "{{ network_baseline_pre.rib_data | length }}"
              post_entries: "{{ network_baseline_post.rib_data | length }}"
              change_count: "{{ rib_added_items | length + rib_removed_items | length }}"
              added: "{{ rib_added_items }}"
              removed: "{{ rib_removed_items }}"

        - name: Update baseline_deltas with RIB results
          ansible.builtin.set_fact:
            baseline_deltas: "{{ baseline_deltas | combine({'rib_data': rib_delta_record}) }}"

    # FIB Data Deltas
    - name: Calculate FIB deltas (if mismatched)
      when: "'fib_data' in baseline_comparison.sections_with_differences"
      block:
        - name: Normalize FIB pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.fib_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.fib_data }}"

        - name: Store normalized FIB pre data
          ansible.builtin.set_fact:
            fib_pre_normalized: "{{ normalized_data }}"

        - name: Normalize FIB post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.fib_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.fib_data }}"

        - name: Store normalized FIB post data and calculate deltas
          ansible.builtin.set_fact:
            fib_post_normalized: "{{ normalized_data }}"
            fib_added_items: "{{ (normalized_data) | difference(fib_pre_normalized) }}"
            fib_removed_items: "{{ fib_pre_normalized | difference(normalized_data) }}"

        - name: Record FIB deltas
          ansible.builtin.set_fact:
            fib_delta_record:
              pre_entries: "{{ network_baseline_pre.fib_data | length }}"
              post_entries: "{{ network_baseline_post.fib_data | length }}"
              change_count: "{{ fib_added_items | length + fib_removed_items | length }}"
              added: "{{ fib_added_items }}"
              removed: "{{ fib_removed_items }}"

        - name: Update baseline_deltas with FIB results
          ansible.builtin.set_fact:
            baseline_deltas: "{{ baseline_deltas | combine({'fib_data': fib_delta_record}) }}"

    # BFD Data Deltas (only if BFD enabled)
    - name: Calculate BFD deltas (if mismatched)
      when:
        - bfd_enabled | bool
        - "'bfd_data' in baseline_comparison.sections_with_differences"
      block:
        - name: Normalize BFD pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.bfd_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.bfd_data }}"

        - name: Store normalized BFD pre data
          ansible.builtin.set_fact:
            bfd_pre_normalized: "{{ normalized_data }}"

        - name: Normalize BFD post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.bfd_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.bfd_data }}"

        - name: Store normalized BFD post data and calculate deltas
          ansible.builtin.set_fact:
            bfd_post_normalized: "{{ normalized_data }}"
            bfd_added_items: "{{ (normalized_data) | difference(bfd_pre_normalized) }}"
            bfd_removed_items: "{{ bfd_pre_normalized | difference(normalized_data) }}"

        - name: Record BFD deltas
          ansible.builtin.set_fact:
            bfd_delta_record:
              pre_entries: "{{ network_baseline_pre.bfd_data | length }}"
              post_entries: "{{ network_baseline_post.bfd_data | length }}"
              change_count: "{{ bfd_added_items | length + bfd_removed_items | length }}"
              added: "{{ bfd_added_items }}"
              removed: "{{ bfd_removed_items }}"

        - name: Update baseline_deltas with BFD results
          ansible.builtin.set_fact:
            baseline_deltas: "{{ baseline_deltas | combine({'bfd_data': bfd_delta_record}) }}"

    # PIM Interface Data Deltas (only if multicast enabled)
    - name: Calculate PIM interface deltas (if mismatched)
      when:
        - multicast_enabled | bool
        - "'pim_interface_data' in baseline_comparison.sections_with_differences"
      block:
        - name: Normalize PIM interface pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.pim_interface_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.pim_interface_data }}"

        - name: Store normalized PIM interface pre data
          ansible.builtin.set_fact:
            pim_int_pre_normalized: "{{ normalized_data }}"

        - name: Normalize PIM interface post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.pim_interface_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.pim_interface_data }}"

        - name: Store normalized PIM interface post data and calculate deltas
          ansible.builtin.set_fact:
            pim_int_post_normalized: "{{ normalized_data }}"
            pim_int_added_items: "{{ (normalized_data) | difference(pim_int_pre_normalized) }}"
            pim_int_removed_items: "{{ pim_int_pre_normalized | difference(normalized_data) }}"

        - name: Record PIM interface deltas
          ansible.builtin.set_fact:
            pim_int_delta_record:
              pre_entries: "{{ network_baseline_pre.pim_interface_data | length }}"
              post_entries: "{{ network_baseline_post.pim_interface_data | length }}"
              change_count: "{{ pim_int_added_items | length + pim_int_removed_items | length }}"
              added: "{{ pim_int_added_items }}"
              removed: "{{ pim_int_removed_items }}"

        - name: Update baseline_deltas with PIM interface results
          ansible.builtin.set_fact:
            baseline_deltas: "{{ baseline_deltas | combine({'pim_interface_data': pim_int_delta_record}) }}"

    # PIM Neighbor Data Deltas (only if multicast enabled)
    - name: Calculate PIM neighbor deltas (if mismatched)
      when:
        - multicast_enabled | bool
        - "'pim_neighbor_data' in baseline_comparison.sections_with_differences"
      block:
        - name: Normalize PIM neighbor pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.pim_neighbor_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.pim_neighbor_data }}"

        - name: Store normalized PIM neighbor pre data
          ansible.builtin.set_fact:
            pim_nbr_pre_normalized: "{{ normalized_data }}"

        - name: Normalize PIM neighbor post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.pim_neighbor_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.pim_neighbor_data }}"

        - name: Store normalized PIM neighbor post data and calculate deltas
          ansible.builtin.set_fact:
            pim_nbr_post_normalized: "{{ normalized_data }}"
            pim_nbr_added_items: "{{ (normalized_data) | difference(pim_nbr_pre_normalized) }}"
            pim_nbr_removed_items: "{{ pim_nbr_pre_normalized | difference(normalized_data) }}"

        - name: Record PIM neighbor deltas
          ansible.builtin.set_fact:
            pim_nbr_delta_record:
              pre_entries: "{{ network_baseline_pre.pim_neighbor_data | length }}"
              post_entries: "{{ network_baseline_post.pim_neighbor_data | length }}"
              change_count: "{{ pim_nbr_added_items | length + pim_nbr_removed_items | length }}"
              added: "{{ pim_nbr_added_items }}"
              removed: "{{ pim_nbr_removed_items }}"

        - name: Update baseline_deltas with PIM neighbor results
          ansible.builtin.set_fact:
            baseline_deltas: "{{ baseline_deltas | combine({'pim_neighbor_data': pim_nbr_delta_record}) }}"

    # IGMP Interface Data Deltas (only if multicast enabled)
    - name: Calculate IGMP interface deltas (if mismatched)
      when:
        - multicast_enabled | bool
        - "'igmp_interface_data' in baseline_comparison.sections_with_differences"
      block:
        - name: Normalize IGMP interface pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.igmp_interface_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.igmp_interface_data }}"

        - name: Store normalized IGMP interface pre data
          ansible.builtin.set_fact:
            igmp_int_pre_normalized: "{{ normalized_data }}"

        - name: Normalize IGMP interface post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.igmp_interface_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.igmp_interface_data }}"

        - name: Store normalized IGMP interface post data and calculate deltas
          ansible.builtin.set_fact:
            igmp_int_post_normalized: "{{ normalized_data }}"
            igmp_int_added_items: "{{ (normalized_data) | difference(igmp_int_pre_normalized) }}"
            igmp_int_removed_items: "{{ igmp_int_pre_normalized | difference(normalized_data) }}"

        - name: Record IGMP interface deltas
          ansible.builtin.set_fact:
            igmp_int_delta_record:
              pre_entries: "{{ network_baseline_pre.igmp_interface_data | length }}"
              post_entries: "{{ network_baseline_post.igmp_interface_data | length }}"
              change_count: "{{ igmp_int_added_items | length + igmp_int_removed_items | length }}"
              added: "{{ igmp_int_added_items }}"
              removed: "{{ igmp_int_removed_items }}"

        - name: Update baseline_deltas with IGMP interface results
          ansible.builtin.set_fact:
            baseline_deltas: "{{ baseline_deltas | combine({'igmp_interface_data': igmp_int_delta_record}) }}"

    # IGMP Groups Data Deltas (only if multicast enabled)
    - name: Calculate IGMP groups deltas (if mismatched)
      when:
        - multicast_enabled | bool
        - "'igmp_groups_data' in baseline_comparison.sections_with_differences"
      block:
        - name: Normalize IGMP groups pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.igmp_groups_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.igmp_groups_data }}"

        - name: Store normalized IGMP groups pre data
          ansible.builtin.set_fact:
            igmp_grp_pre_normalized: "{{ normalized_data }}"

        - name: Normalize IGMP groups post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.igmp_groups_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.igmp_groups_data }}"

        - name: Store normalized IGMP groups post data and calculate deltas
          ansible.builtin.set_fact:
            igmp_grp_post_normalized: "{{ normalized_data }}"
            igmp_grp_added_items: "{{ (normalized_data) | difference(igmp_grp_pre_normalized) }}"
            igmp_grp_removed_items: "{{ igmp_grp_pre_normalized | difference(normalized_data) }}"

        - name: Record IGMP groups deltas
          ansible.builtin.set_fact:
            igmp_grp_delta_record:
              pre_entries: "{{ network_baseline_pre.igmp_groups_data | length }}"
              post_entries: "{{ network_baseline_post.igmp_groups_data | length }}"
              change_count: "{{ igmp_grp_added_items | length + igmp_grp_removed_items | length }}"
              added: "{{ igmp_grp_added_items }}"
              removed: "{{ igmp_grp_removed_items }}"

        - name: Update baseline_deltas with IGMP groups results
          ansible.builtin.set_fact:
            baseline_deltas: "{{ baseline_deltas | combine({'igmp_groups_data': igmp_grp_delta_record}) }}"

    # Multicast Route Data Deltas (only if multicast enabled)
    - name: Calculate Mroute deltas (if mismatched)
      when:
        - multicast_enabled | bool
        - "'mroute_data' in baseline_comparison.sections_with_differences"
      block:
        - name: Normalize Mroute pre-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_pre.mroute_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.mroute_data }}"

        - name: Store normalized Mroute pre data
          ansible.builtin.set_fact:
            mroute_pre_normalized: "{{ normalized_data }}"

        - name: Normalize Mroute post-upgrade data
          ansible.builtin.include_tasks: normalize-baseline-data.yml
          vars:
            data_to_normalize: "{{ network_baseline_post.mroute_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.mroute_data }}"

        - name: Store normalized Mroute post data and calculate deltas
          ansible.builtin.set_fact:
            mroute_post_normalized: "{{ normalized_data }}"
            mroute_added_items: "{{ (normalized_data) | difference(mroute_pre_normalized) }}"
            mroute_removed_items: "{{ mroute_pre_normalized | difference(normalized_data) }}"

        - name: Record Mroute deltas
          ansible.builtin.set_fact:
            mroute_delta_record:
              pre_entries: "{{ network_baseline_pre.mroute_data | length }}"
              post_entries: "{{ network_baseline_post.mroute_data | length }}"
              change_count: "{{ mroute_added_items | length + mroute_removed_items | length }}"
              added: "{{ mroute_added_items }}"
              removed: "{{ mroute_removed_items }}"

        - name: Update baseline_deltas with Mroute results
          ansible.builtin.set_fact:
            baseline_deltas: "{{ baseline_deltas | combine({'mroute_data': mroute_delta_record}) }}"

  when:
    - baseline_comparison.sections_with_differences is defined
    - baseline_comparison.sections_with_differences | length > 0
