---
# Generate detailed baseline deltas for failed comparisons
# Shows exactly what changed between pre and post upgrade states
#
# Input variables:
#   - network_baseline_pre: Pre-upgrade baseline data (already normalized)
#   - network_baseline_post: Post-upgrade baseline data (already normalized)
#   - baseline_comparison: Comparison results with sections_with_differences
#
# Output variables:
#   - baseline_deltas: Detailed delta information with added/removed items per data type

- name: Initialize baseline deltas
  ansible.builtin.set_fact:
    baseline_deltas: {}

- name: Generate deltas for mismatched sections
  block:
    # ARP Data Deltas
    - name: Calculate ARP deltas (if mismatched)
      when: 'arp_data in baseline_comparison.sections_with_differences'
      vars:
        arp_added_items: "{{ network_baseline_post.arp_data | difference(network_baseline_pre.arp_data) }}"
        arp_removed_items: "{{ network_baseline_pre.arp_data | difference(network_baseline_post.arp_data) }}"
      ansible.builtin.set_fact:
        baseline_deltas: "{{ baseline_deltas | combine({'arp_data': {'pre_entries': network_baseline_pre.arp_data | length, 'post_entries': network_baseline_post.arp_data | length, 'added': arp_added_items, 'removed': arp_removed_items}}) }}"

    # MAC Data Deltas
    - name: Calculate MAC deltas (if mismatched)
      when: 'mac_data in baseline_comparison.sections_with_differences'
      vars:
        mac_added_items: "{{ network_baseline_post.mac_data | difference(network_baseline_pre.mac_data) }}"
        mac_removed_items: "{{ network_baseline_pre.mac_data | difference(network_baseline_post.mac_data) }}"
      ansible.builtin.set_fact:
        baseline_deltas: "{{ baseline_deltas | combine({'mac_data': {'pre_entries': network_baseline_pre.mac_data | length, 'post_entries': network_baseline_post.mac_data | length, 'added': mac_added_items, 'removed': mac_removed_items}}) }}"

    # RIB Data Deltas
    - name: Calculate RIB deltas (if mismatched)
      when: 'rib_data in baseline_comparison.sections_with_differences'
      vars:
        rib_added_items: "{{ network_baseline_post.rib_data | difference(network_baseline_pre.rib_data) }}"
        rib_removed_items: "{{ network_baseline_pre.rib_data | difference(network_baseline_post.rib_data) }}"
      ansible.builtin.set_fact:
        baseline_deltas: "{{ baseline_deltas | combine({'rib_data': {'pre_entries': network_baseline_pre.rib_data | length, 'post_entries': network_baseline_post.rib_data | length, 'added': rib_added_items, 'removed': rib_removed_items}}) }}"

    # FIB Data Deltas
    - name: Calculate FIB deltas (if mismatched)
      when: 'fib_data in baseline_comparison.sections_with_differences'
      vars:
        fib_added_items: "{{ network_baseline_post.fib_data | difference(network_baseline_pre.fib_data) }}"
        fib_removed_items: "{{ network_baseline_pre.fib_data | difference(network_baseline_post.fib_data) }}"
      ansible.builtin.set_fact:
        baseline_deltas: "{{ baseline_deltas | combine({'fib_data': {'pre_entries': network_baseline_pre.fib_data | length, 'post_entries': network_baseline_post.fib_data | length, 'added': fib_added_items, 'removed': fib_removed_items}}) }}"

    # BFD Data Deltas (only if BFD enabled)
    - name: Calculate BFD deltas (if mismatched)
      when:
        - bfd_enabled | bool
        - 'bfd_data in baseline_comparison.sections_with_differences'
      vars:
        bfd_added_items: "{{ network_baseline_post.bfd_data | difference(network_baseline_pre.bfd_data) }}"
        bfd_removed_items: "{{ network_baseline_pre.bfd_data | difference(network_baseline_post.bfd_data) }}"
      ansible.builtin.set_fact:
        baseline_deltas: "{{ baseline_deltas | combine({'bfd_data': {'pre_entries': network_baseline_pre.bfd_data | length, 'post_entries': network_baseline_post.bfd_data | length, 'added': bfd_added_items, 'removed': bfd_removed_items}}) }}"

    # PIM Interface Data Deltas (only if multicast enabled)
    - name: Calculate PIM interface deltas (if mismatched)
      when:
        - multicast_enabled | bool
        - 'pim_interface_data in baseline_comparison.sections_with_differences'
      vars:
        pim_int_added_items: "{{ network_baseline_post.pim_interface_data | difference(network_baseline_pre.pim_interface_data) }}"
        pim_int_removed_items: "{{ network_baseline_pre.pim_interface_data | difference(network_baseline_post.pim_interface_data) }}"
      ansible.builtin.set_fact:
        baseline_deltas: "{{ baseline_deltas | combine({'pim_interface_data': {'pre_entries': network_baseline_pre.pim_interface_data | length, 'post_entries': network_baseline_post.pim_interface_data | length, 'added': pim_int_added_items, 'removed': pim_int_removed_items}}) }}"

    # PIM Neighbor Data Deltas (only if multicast enabled)
    - name: Calculate PIM neighbor deltas (if mismatched)
      when:
        - multicast_enabled | bool
        - 'pim_neighbor_data in baseline_comparison.sections_with_differences'
      vars:
        pim_nbr_added_items: "{{ network_baseline_post.pim_neighbor_data | difference(network_baseline_pre.pim_neighbor_data) }}"
        pim_nbr_removed_items: "{{ network_baseline_pre.pim_neighbor_data | difference(network_baseline_post.pim_neighbor_data) }}"
      ansible.builtin.set_fact:
        baseline_deltas: "{{ baseline_deltas | combine({'pim_neighbor_data': {'pre_entries': network_baseline_pre.pim_neighbor_data | length, 'post_entries': network_baseline_post.pim_neighbor_data | length, 'added': pim_nbr_added_items, 'removed': pim_nbr_removed_items}}) }}"

    # IGMP Interface Data Deltas (only if multicast enabled)
    - name: Calculate IGMP interface deltas (if mismatched)
      when:
        - multicast_enabled | bool
        - 'igmp_interface_data in baseline_comparison.sections_with_differences'
      vars:
        igmp_int_added_items: "{{ network_baseline_post.igmp_interface_data | difference(network_baseline_pre.igmp_interface_data) }}"
        igmp_int_removed_items: "{{ network_baseline_pre.igmp_interface_data | difference(network_baseline_post.igmp_interface_data) }}"
      ansible.builtin.set_fact:
        baseline_deltas: "{{ baseline_deltas | combine({'igmp_interface_data': {'pre_entries': network_baseline_pre.igmp_interface_data | length, 'post_entries': network_baseline_post.igmp_interface_data | length, 'added': igmp_int_added_items, 'removed': igmp_int_removed_items}}) }}"

    # IGMP Groups Data Deltas (only if multicast enabled)
    - name: Calculate IGMP groups deltas (if mismatched)
      when:
        - multicast_enabled | bool
        - 'igmp_groups_data in baseline_comparison.sections_with_differences'
      vars:
        igmp_grp_added_items: "{{ network_baseline_post.igmp_groups_data | difference(network_baseline_pre.igmp_groups_data) }}"
        igmp_grp_removed_items: "{{ network_baseline_pre.igmp_groups_data | difference(network_baseline_post.igmp_groups_data) }}"
      ansible.builtin.set_fact:
        baseline_deltas: "{{ baseline_deltas | combine({'igmp_groups_data': {'pre_entries': network_baseline_pre.igmp_groups_data | length, 'post_entries': network_baseline_post.igmp_groups_data | length, 'added': igmp_grp_added_items, 'removed': igmp_grp_removed_items}}) }}"

    # Multicast Route Data Deltas (only if multicast enabled)
    - name: Calculate Mroute deltas (if mismatched)
      when:
        - multicast_enabled | bool
        - 'mroute_data in baseline_comparison.sections_with_differences'
      vars:
        mroute_added_items: "{{ network_baseline_post.mroute_data | difference(network_baseline_pre.mroute_data) }}"
        mroute_removed_items: "{{ network_baseline_pre.mroute_data | difference(network_baseline_post.mroute_data) }}"
      ansible.builtin.set_fact:
        baseline_deltas: "{{ baseline_deltas | combine({'mroute_data': {'pre_entries': network_baseline_pre.mroute_data | length, 'post_entries': network_baseline_post.mroute_data | length, 'added': mroute_added_items, 'removed': mroute_removed_items}}) }}"

  when:
    - baseline_comparison.sections_with_differences is defined
    - baseline_comparison.sections_with_differences | length > 0
