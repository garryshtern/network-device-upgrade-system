---
# Image Loading for Cisco IOS-XE Devices
# Handles file transfer and staging

- name: Pre-transfer validation
  block:
    - name: Check available space
      cisco.ios.ios_command:
        commands:
          - dir bootflash: | include bytes
      register: space_check
      
    - name: Parse available space
      set_fact:
        available_bytes: "{{ space_check.stdout[0] | regex_search('(\\d+) bytes free') | regex_replace(' bytes free', '') | int }}"
        
    - name: Verify sufficient space
      assert:
        that:
          - available_bytes | int > (target_image_size | default(1000000000) | int)
        fail_msg: "Insufficient space: {{ available_bytes }} bytes available, {{ target_image_size | default(1000000000) }} required"

- name: Transfer image file
  block:
    - name: Copy image to bootflash
      cisco.ios.ios_command:
        commands:
          - "copy {{ source_image_url }} bootflash:{{ target_image_filename }}"
        timeout: 3600
        wait_for:
          - result[0] contains "bytes copied"
      register: copy_result
      
    - name: Verify file transfer completion
      cisco.ios.ios_command:
        commands:
          - "dir bootflash:{{ target_image_filename }}"
      register: file_verification
      
    - name: Confirm file exists and size matches
      assert:
        that:
          - target_image_filename in file_verification.stdout[0]
          - target_image_size | string in file_verification.stdout[0]
        fail_msg: "File transfer verification failed"

- name: Image integrity validation
  block:
    - name: Calculate MD5 hash of transferred file
      cisco.ios.ios_command:
        commands:
          - "verify /md5 bootflash:{{ target_image_filename }}"
        timeout: 1800
      register: md5_verification
      when: expected_md5_hash is defined
      
    - name: Verify MD5 hash matches expected
      assert:
        that:
          - expected_md5_hash in md5_verification.stdout[0]
        fail_msg: "MD5 hash verification failed"
      when: expected_md5_hash is defined
      
- name: Log transfer completion
  debug:
    msg: |
      Image Transfer Completed:
      - Source: {{ source_image_url }}
      - Destination: bootflash:{{ target_image_filename }}
      - Size: {{ target_image_size }} bytes
      - Hash Verified: {{ 'Yes' if expected_md5_hash is defined else 'Skipped' }}