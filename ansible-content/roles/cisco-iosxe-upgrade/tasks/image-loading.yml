---
# Image Loading for Cisco IOS-XE Devices
# Handles secure server-initiated file transfer and staging
# SECURITY: Uses server-initiated PUSH transfers (not device-initiated PULL)
# NOTE: Core transfer logic refactored to common/tasks/secure-file-transfer.yml

# NOTE: Storage space validation already performed in STEP 3 of main-upgrade-workflow
# No need to re-check here - STEP 3 ensures sufficient space before calling this task

- name: Execute platform-specific IOS-XE firmware transfer
  ansible.builtin.include_role:
    name: common
    tasks_from: secure-file-transfer
  vars:
    transfer_handler_task: iosxe-firmware-transfer.yml
    local_file_path: "{{ local_image_path }}"

- name: Log transfer completion
  ansible.builtin.debug:
    msg:
      - "Secure Image Transfer Completed (Server-Initiated PUSH):"
      - "- Local Source: {{ local_file_path }}"
      - "- Remote Destination: {{ ansible_host }}:bootflash:{{ target_image_filename }}"
      - "- Transfer Method: {{ transfer_result.method if transfer_result.method is defined else 'SCP' }}"
      - "- Size: {{ file_size_mb }}MB"
      - "- Hash Verified: {{ 'Yes' if transferred_file_hash is defined else 'Skipped' }}"
