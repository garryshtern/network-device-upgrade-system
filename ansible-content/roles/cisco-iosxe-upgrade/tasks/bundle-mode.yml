---
# Bundle Mode Upgrade for Cisco IOS-XE
# Traditional boot system method for older platforms

- name: Pre-bundle validation
  block:
    - name: Check current boot system configuration
      cisco.ios.ios_command:
        commands:
          - show running-config | include boot system
      register: current_boot_config

    - name: Check bootflash contents
      cisco.ios.ios_command:
        commands:
          - dir bootflash:
      register: bootflash_contents

- name: Bundle mode upgrade process
  block:
    - name: Configure boot system with new image
      cisco.ios.ios_config:
        lines:
          - "boot system flash bootflash:{{ target_image_filename }}"
        save_when: always
      register: boot_config_result

    - name: Remove old boot system entries (if any)
      cisco.ios.ios_config:
        lines:
          - "no boot system flash bootflash:{{ item }}"
        save_when: always
      loop: "{{ old_image_files }}"
      when: old_image_files is defined

    - name: Verify boot system configuration
      cisco.ios.ios_command:
        commands:
          - show running-config | include boot system
      register: new_boot_config

    - name: Validate boot system entry
      ansible.builtin.assert:
        that:
          - target_image_filename in new_boot_config.stdout[0]
        fail_msg: "Boot system configuration failed"

- name: Schedule reboot for bundle mode
  block:
    - name: Save configuration before reboot
      cisco.ios.ios_config:
        save_when: always

    - name: Set reboot flag for bundle mode
      ansible.builtin.set_fact:
        requires_reboot: true
        reboot_reason: "Bundle mode upgrade - boot system configured"

- name: Post-configuration validation
  block:
    - name: Display new boot configuration
      ansible.builtin.debug:
        msg:
          - "Bundle Mode Configuration Complete:"
          - "- Target Image: {{ target_image_filename }}"
          - "- Boot System: {{ new_boot_config.stdout[0] }}"
          - "- Reboot Required: {{ requires_reboot }}"

    - name: Verify image file exists on device
      cisco.ios.ios_command:
        commands:
          - "dir bootflash:{{ target_image_filename }}"
      register: image_verification

    - name: Confirm image presence
      ansible.builtin.assert:
        that:
          - target_image_filename in image_verification.stdout[0]
        fail_msg: "Target image file not found on device"
