---
# Opengear Upgrade Role - Main Tasks
# Handles console servers and smart PDU upgrades via web interface

- name: Initialize Opengear upgrade variables
  set_fact:
    opengear_upgrade_state:
      device: "{{ inventory_hostname }}"
      device_model: ""
      current_version: ""
      target_version: "{{ target_firmware_version }}"
      device_type: "console_server"  # console_server or smart_pdu
      serial_ports: []
      power_ports: []
      web_session: ""
      
- name: Detect Opengear device type and model
  uri:
    url: "https://{{ ansible_host }}/api/v1/system/info"
    method: GET
    headers:
      Authorization: "Token {{ opengear_api_token }}"
    validate_certs: false
  register: device_info
  
- name: Parse device information
  set_fact:
    opengear_upgrade_state: "{{ opengear_upgrade_state | combine({
      'device_model': device_info.json.model,
      'current_version': device_info.json.version,
      'device_type': 'smart_pdu' if 'CM8100' in device_info.json.model else 'console_server'
    }) }}"
    
- name: Check device-specific capabilities
  include_tasks: "{{ 'smart-pdu-check.yml' if opengear_upgrade_state.device_type == 'smart_pdu' else 'console-server-check.yml' }}"
  
- name: Display upgrade plan
  debug:
    msg: |
      Opengear Upgrade Plan for {{ inventory_hostname }}:
      Model: {{ opengear_upgrade_state.device_model }}
      Type: {{ opengear_upgrade_state.device_type }}
      Current Version: {{ opengear_upgrade_state.current_version }}
      Target Version: {{ opengear_upgrade_state.target_version }}
      Serial Ports: {{ opengear_upgrade_state.serial_ports | length }}
      Power Outlets: {{ opengear_upgrade_state.power_ports | length }}
      
- name: Validate upgrade path
  assert:
    that:
      - opengear_upgrade_state.current_version != opengear_upgrade_state.target_version
      - opengear_upgrade_state.target_version is match("^[0-9]+\\.[0-9]+")
    fail_msg: "Invalid upgrade path or target version format"
    
- name: Execute image loading
  include_tasks: image-loading.yml
  
- name: Execute image installation
  include_tasks: image-installation.yml