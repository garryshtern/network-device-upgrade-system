---
# Image Loading for Opengear Devices
# Secure server-initiated firmware image transfer via web API
# SECURITY: Uses server-initiated PUSH transfers (API upload from server)

- name: Pre-loading validation
  block:
    - name: Authenticate to Opengear API
      ansible.builtin.uri:
        url: "https://{{ ansible_host }}/api/v1/auth/login"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          username: "{{ opengear_username }}"
          password: "{{ opengear_password }}"
        validate_certs: false
      register: opengear_auth
      when: not ansible_check_mode

    - name: Simulate authentication in check mode
      ansible.builtin.set_fact:
        opengear_auth:
          json:
            token: "simulated-token-for-check-mode"
      when: ansible_check_mode

    - name: Store authentication token
      ansible.builtin.set_fact:
        opengear_api_token: "{{ opengear_auth.json.token }}"

    - name: Check available storage space
      ansible.builtin.uri:
        url: "https://{{ ansible_host }}/api/v1/system/storage"
        method: GET
        headers:
          Authorization: "Token {{ opengear_api_token }}"
        validate_certs: false
      register: storage_info
      when: not ansible_check_mode

    - name: Simulate storage check in check mode
      ansible.builtin.set_fact:
        storage_info:
          json:
            available_mb: 500
            total_mb: 1000
      when: ansible_check_mode

    - name: Validate sufficient storage space
      ansible.builtin.assert:
        that:
          - >-
            storage_info.json.available_mb | int >
              (target_firmware_size_mb | int)
        fail_msg: >-
          Insufficient storage space: {{ storage_info.json.available_mb }}MB
          available, {{ target_firmware_size_mb |
            default(100) }}MB required

- name: Prepare firmware image for upload
  block:
    - name: Check if firmware file exists locally
      ansible.builtin.stat:
        path: "{{ local_firmware_path }}"
      register: local_firmware_check
      delegate_to: localhost
      when: local_firmware_path is defined

    - name: Validate local firmware file
      ansible.builtin.assert:
        that:
          - local_firmware_check.stat.exists
        fail_msg: "Local firmware file not found: {{ local_firmware_path }}"
      when: local_firmware_path is defined

    - name: Calculate firmware file checksum
      ansible.builtin.stat:
        path: "{{ local_firmware_path }}"
        checksum_algorithm: md5
      register: firmware_checksum
      delegate_to: localhost
      when: local_firmware_path is defined

- name: Upload firmware image to Opengear device
  when: local_firmware_path is defined

  block:
    - name: Start firmware upload session
      ansible.builtin.uri:
        url: "https://{{ ansible_host }}/api/v1/system/firmware/upload/start"
        method: POST
        headers:
          Authorization: "Token {{ opengear_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          filename: "{{ target_firmware_filename }}"
          size: >-
            {{ firmware_checksum.stat.size if firmware_checksum is defined else
            target_firmware_size_mb |
              default(100) * 1024 * 1024 }}
          checksum: >-
            {{ firmware_checksum.stat.checksum if
              firmware_checksum is defined else omit }}
        validate_certs: false
      register: upload_session
      when: not ansible_check_mode

    - name: Simulate upload session in check mode
      ansible.builtin.set_fact:
        upload_session:
          json:
            session_id: "simulated-session-id"
      when: ansible_check_mode

    - name: Push firmware file from server via API (Server-Initiated PUSH)
      ansible.builtin.uri:
        url: >
          "https://{{ ansible_host }}/api/v1/system/firmware/upload/{{
            upload_session.json.session_id }}/chunk"
        method: POST
        headers:
          Authorization: "Token {{ opengear_api_token }}"
          Content-Type: "application/octet-stream"
        body: >
          "{{ lookup('file', local_firmware_path, rstrip=False) | b64decode }}"
        timeout: 3600
        validate_certs: false
      register: secure_chunk_upload
      delegate_to: localhost
      when:
        - local_firmware_path is defined
        - not ansible_check_mode
      vars:
        ansible_connection: local

    - name: Complete firmware upload
      ansible.builtin.uri:
        url: >
          "https://{{ ansible_host }}/api/v1/system/firmware/upload/{{
            upload_session.json.session_id }}/complete"
        method: POST
        headers:
          Authorization: "Token {{ opengear_api_token }}"
        validate_certs: false
      register: upload_complete
      when: not ansible_check_mode

- name: Verify firmware upload/download
  when: target_firmware_filename is defined
  block:
    - name: Get list of available firmware images
      ansible.builtin.uri:
        url: "https://{{ ansible_host }}/api/v1/system/firmware/list"
        method: GET
        headers:
          Authorization: "Token {{ opengear_api_token }}"
        validate_certs: false
      register: firmware_list
      when: not ansible_check_mode

    - name: Simulate firmware list in check mode
      ansible.builtin.set_fact:
        firmware_list:
          json:
            - filename: "{{ target_firmware_filename }}"
              status: "ready"
              checksum: "{{ firmware_checksum.stat.checksum if firmware_checksum is defined else 'simulated-checksum' }}"
              size_mb: 100
      when: ansible_check_mode

    - name: Verify target firmware is available
      ansible.builtin.assert:
        that:
          - >
            firmware_list.json | selectattr('filename', 'equalto',
              target_firmware_filename) | list | length > 0
        fail_msg: "Target firmware file not found in device storage"

    - name: Extract firmware information
      ansible.builtin.set_fact:
        uploaded_firmware_info: "{{ firmware_list.json | selectattr('filename', 'equalto', target_firmware_filename) | first }}"

    - name: Validate firmware integrity
      ansible.builtin.assert:
        that:
          - uploaded_firmware_info.status == 'ready'
          - >
            uploaded_firmware_info.checksum == firmware_checksum.stat.checksum
              if firmware_checksum is defined else true
        fail_msg: "Firmware integrity validation failed"

- name: Log image loading completion
  ansible.builtin.debug:
    msg: |-
      Secure Opengear Image Loading Completed:
      - Device: {{ opengear_upgrade_state.device_model if opengear_upgrade_state is defined else 'Unknown' }}
      - Firmware File: {{ target_firmware_filename }}
      - Size: {{ uploaded_firmware_info.size_mb }}MB
      - Checksum: {{ uploaded_firmware_info.checksum }}
      - Transfer Method: Server-Initiated PUSH (API Upload)
      - Security Level: HIGH (server pushes file)
      - Status: Ready for Installation
  when:
    - opengear_upgrade_state is defined
    - uploaded_firmware_info is defined
