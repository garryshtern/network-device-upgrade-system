---
# Image Loading for Opengear Devices
# Secure server-initiated firmware image transfer via web API
# SECURITY: Uses server-initiated PUSH transfers (API upload from server)
# NOTE: Core transfer logic refactored to common/tasks/secure-file-transfer.yml

# NOTE: Storage space validation already performed in STEP 3 of main-upgrade-workflow
# No need to re-check here - STEP 3 ensures sufficient space before calling this task

- name: Execute platform-specific Opengear firmware transfer
  ansible.builtin.include_role:
    name: common
    tasks_from: secure-file-transfer
  vars:
    transfer_handler_task: opengear-firmware-transfer.yml
    local_file_path: "{{ local_firmware_path }}"

- name: Log image loading completion
  ansible.builtin.debug:
    msg:
      - "Secure Opengear Image Loading Completed:"
      - "- Device: {{ opengear_upgrade_state.device_model if opengear_upgrade_state is defined else 'Unknown' }}"
      - "- Firmware File: {{ target_firmware_filename }}"
      - "- Size: {{ file_size_mb }}MB"
      - "- Checksum: {{ transferred_file_hash if transferred_file_hash is defined else 'not_verified' }}"
      - "- Transfer Method: {{ transfer_result.method if transfer_result.method is defined else 'Server-Initiated PUSH' }}"
      - "- Security Level: HIGH (server pushes file)"
      - "- Status: Ready for Installation"
