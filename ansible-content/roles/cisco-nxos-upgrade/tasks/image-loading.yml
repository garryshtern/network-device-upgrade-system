---
# Cisco NX-OS Image Loading Tasks
# Securely transfers firmware images from server to device
# SECURITY: Uses server-initiated PUSH transfers (not device-initiated PULL)
# NOTE: Core transfer logic refactored to common/tasks/secure-file-transfer.yml

- name: Set firmware paths
  ansible.builtin.set_fact:
    firmware_filename: "{{ target_firmware }}"
    local_firmware_path: "{{ firmware_base_path }}/{{ target_firmware }}"

- name: EPLD setup block (if EPLD upgrade enabled)
  when: enable_epld_upgrade | bool
  block:
    - name: Validate EPLD firmware filename provided
      ansible.builtin.assert:
        that:
          - target_epld_firmware is defined
          - target_epld_firmware | length > 0
        fail_msg:
          - "EPLD upgrade enabled but target_epld_firmware not provided"
          - "You must explicitly specify the EPLD firmware filename"
          - "Example: target_epld_firmware=n9000-epld.10.3.1.img"

    - name: Set EPLD firmware paths
      ansible.builtin.set_fact:
        epld_firmware_filename: "{{ target_epld_firmware }}"
        local_epld_path: "{{ firmware_base_path }}/{{ target_epld_firmware }}"

- name: Display firmware selection
  ansible.builtin.debug:
    msg:
      - "Device: {{ inventory_hostname }}"
      - "Model: {{ ansible_net_model }}"
      - "Firmware File: {{ firmware_filename }}"
      - "Full Path: {{ local_firmware_path }}"
      - "EPLD Enabled: {{ enable_epld_upgrade }}"
      - "EPLD File: {{ epld_firmware_filename if (enable_epld_upgrade | bool) else 'N/A' }}"
      - "EPLD Path: {{ local_epld_path if (enable_epld_upgrade | bool) else 'N/A' }}"

# NOTE: Storage space validation already performed in STEP 3 of main-upgrade-workflow
# STEP 3 ran "dir bootflash:" and stored image list in storage_info.images_found
# Reuse that data instead of running another dir command

- name: Initialize file existence checks (default to not found)
  ansible.builtin.set_fact:
    target_firmware_exists: false
    target_epld_exists_check: false

- name: Check if target firmware and EPLD already exist on device
  ansible.builtin.set_fact:
    target_firmware_exists: "{{ target_firmware in storage_info.images_found }}"
    target_epld_exists_check: "{{ target_epld_firmware in storage_info.images_found if target_epld_firmware is defined else false }}"
  when:
    - storage_info is defined
    - storage_info.images_found is defined

- name: Set EPLD existence variable based on enable_epld_upgrade
  when: enable_epld_upgrade | bool
  block:
    - name: Set EPLD exists flag when EPLD is enabled
      ansible.builtin.set_fact:
        target_epld_exists: "{{ target_epld_exists_check }}"

- name: Set EPLD does not exist when EPLD is disabled
  ansible.builtin.set_fact:
    target_epld_exists: false
  when: not (enable_epld_upgrade | bool)

- name: Display upload status for firmware and EPLD
  ansible.builtin.debug:
    msg:
      - "Firmware status: {{ 'Already staged' if target_firmware_exists else 'Needs upload' }}"
      - "EPLD enabled: {{ enable_epld_upgrade | bool }}"
      - "EPLD status: {{ 'Already staged' if target_epld_exists else ('Needs upload' if (enable_epld_upgrade | bool) else 'Not enabled') }}"

- name: Firmware already staged - skip upload
  when: target_firmware_exists
  block:
    - name: Report firmware already staged on device
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "FIRMWARE ALREADY STAGED"
          - "=========================================="
          - "Device: {{ inventory_hostname }}"
          - "Firmware: {{ target_firmware }}"
          - "Location: bootflash:{{ target_firmware }}"
          - "Status: SKIPPING UPLOAD"
          - "Action: Proceeding to installation phase"
          - "=========================================="

    - name: Set image loading results for already staged firmware
      ansible.builtin.set_fact:
        nxos_image_loading_results:
          firmware_file: "{{ target_firmware }}"
          file_size_bytes: "{{ firmware_file_info.size_bytes }}"
          source_sha512: "{{ calculated_hash if calculated_hash is defined else 'not_verified' }}"
          device_sha512: "skipped"
          hash_verified: false
          file_uploaded: false
          loading_successful: true
          loading_timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"

- name: Transfer firmware if not already staged
  when: not target_firmware_exists
  block:
    - name: Report firmware upload starting
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "UPLOADING FIRMWARE TO DEVICE"
          - "=========================================="
          - "Device: {{ inventory_hostname }}"
          - "Firmware: {{ target_firmware }}"
          - "Source: {{ local_firmware_path }}"
          - "Destination: bootflash:{{ target_firmware }}"
          - "Method: SCP (Server-Initiated PUSH)"
          - "Status: STARTING UPLOAD..."
          - "=========================================="

    - name: Execute platform-specific NX-OS firmware transfer
      ansible.builtin.include_role:
        name: common
        tasks_from: secure-file-transfer
      vars:
        transfer_handler_task: nxos-firmware-transfer.yml
        local_file_path: "{{ local_firmware_path }}"

    - name: Set image loading results after upload
      ansible.builtin.set_fact:
        nxos_image_loading_results:
          firmware_file: "{{ target_firmware }}"
          file_size_bytes: "{{ firmware_file_info.size_bytes }}"
          source_sha512: "{{ calculated_hash }}"
          device_sha512: "{{ transferred_file_hash }}"
          hash_verified: true
          file_uploaded: true
          loading_successful: true
          loading_timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"

    - name: Display image loading results after upload
      ansible.builtin.debug:
        msg:
          - "Secure firmware image transfer completed successfully (Server-Initiated PUSH)"
          - "Local Source: {{ local_firmware_path }}"
          - "Remote Destination: {{ ansible_host }}:bootflash:{{ nxos_image_loading_results.firmware_file }}"
          - "File Size: {{ (nxos_image_loading_results.file_size_bytes | int / 1024 / 1024) | round(2) }}MB"
          - "Transfer Method: SCP (server-initiated)"
          - "SHA512 Verified: {{ nxos_image_loading_results.hash_verified }}"

# ============================================================================
# OPTIONAL EPLD FIRMWARE UPLOAD - DELEGATED TO SEPARATE TASK FILE
# ============================================================================

- name: Load and upload EPLD firmware (optional)
  ansible.builtin.include_tasks:
    file: epld-loading.yml
  when: enable_epld_upgrade | bool
