---
# Cisco NX-OS Image Loading Tasks
# Securely transfers firmware images from server to device
# SECURITY: Uses server-initiated PUSH transfers (not device-initiated PULL)

- name: Set firmware paths
  ansible.builtin.set_fact:
    firmware_filename: "{{ target_firmware }}"
    local_firmware_path: "{{ firmware_base_path }}/{{ target_firmware }}"

- name: Validate EPLD firmware filename provided (if EPLD upgrade enabled)
  ansible.builtin.assert:
    that:
      - target_epld_firmware is defined
      - target_epld_firmware | length > 0
    fail_msg:
      - "EPLD upgrade enabled but target_epld_firmware not provided"
      - "You must explicitly specify the EPLD firmware filename"
      - "Example: target_epld_firmware=n9000-epld.10.3.1.img"
  when: enable_epld_upgrade | bool

- name: Set EPLD firmware paths (if EPLD upgrade enabled)
  ansible.builtin.set_fact:
    epld_firmware_filename: "{{ target_epld_firmware }}"
    local_epld_path: "{{ firmware_base_path }}/{{ target_epld_firmware }}"
  when: enable_epld_upgrade | bool

- name: Display firmware selection
  ansible.builtin.debug:
    msg:
      - "Device: {{ inventory_hostname }}"
      - "Model: {{ ansible_net_model }}"
      - "Firmware File: {{ firmware_filename }}"
      - "Full Path: {{ local_firmware_path }}"
      - "EPLD Enabled: {{ enable_epld_upgrade }}"
      - "EPLD File: {{ epld_firmware_filename if (enable_epld_upgrade | bool) else 'N/A' }}"
      - "EPLD Path: {{ local_epld_path if (enable_epld_upgrade | bool) else 'N/A' }}"

# NOTE: Storage space validation already performed in STEP 3 of main-upgrade-workflow
# STEP 3 ran "dir bootflash:" and stored image list in storage_info.images_found
# Reuse that data instead of running another dir command

- name: Check if target firmware already exists on device
  ansible.builtin.set_fact:
    target_firmware_exists: "{{ target_firmware in (storage_info.images_found | map('first') | list) }}"
  when:
    - storage_info is defined
    - storage_info.images_found is defined

- name: Set firmware does not exist if storage_info not available
  ansible.builtin.set_fact:
    target_firmware_exists: false
  when: storage_info is not defined or storage_info.images_found is not defined

- name: Report firmware already staged on device
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "FIRMWARE ALREADY STAGED"
      - "=========================================="
      - "Device: {{ inventory_hostname }}"
      - "Firmware: {{ target_firmware }}"
      - "Location: bootflash:{{ target_firmware }}"
      - "Status: SKIPPING UPLOAD"
      - "Action: Proceeding to installation phase"
      - "=========================================="
  when: target_firmware_exists

- name: Report firmware upload starting
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "UPLOADING FIRMWARE TO DEVICE"
      - "=========================================="
      - "Device: {{ inventory_hostname }}"
      - "Firmware: {{ target_firmware }}"
      - "Source: {{ local_firmware_path }}"
      - "Destination: bootflash:{{ target_firmware }}"
      - "Method: SCP (Server-Initiated PUSH)"
      - "Status: STARTING UPLOAD..."
      - "=========================================="
  when: not target_firmware_exists

- name: Transfer firmware image to device (Server-Initiated PUSH)
  when: not target_firmware_exists

  block:
    - name: Enable SCP server on NX-OS device
      cisco.nxos.nxos_config:
        lines:
          - feature scp-server
      register: scp_enable_result
      failed_when: false  # May already be enabled

    - name: Log SCP server enable failures
      ansible.builtin.debug:
        msg: "Warning: Failed to enable SCP server: {{ scp_enable_result.msg if scp_enable_result.msg is defined else 'Unknown error' }}"
      when:
        - scp_enable_result is defined
        - scp_enable_result.failed is defined
        - scp_enable_result.failed | bool

    - name: Push firmware image from server to device via SCP
      cisco.nxos.nxos_file_copy:
        file_system: "bootflash:"
        local_file: "{{ local_firmware_path }}"
        remote_file: "{{ target_firmware }}"
        file_pull: false  # Server pushes to device
      register: nxos_file_copy_result
      async: 3600  # Allow up to 1 hour for large files
      poll: 10  # Check status every 10 seconds

    - name: Display file transfer results
      ansible.builtin.debug:
        msg:
          - "File transfer completed"
          - "Status: {{ nxos_file_copy_result.transfer_status | default('N/A') }}"
          - "Changed: {{ nxos_file_copy_result.changed }}"
          - "File already exists: {{ nxos_file_copy_result.file_already_exists | default(false) }}"

    - name: Verify secure file transfer completed successfully
      ansible.builtin.assert:
        that:
          - nxos_file_copy_result is succeeded
        fail_msg: "Secure firmware file transfer failed: {{ nxos_file_copy_result | to_nice_json }}"

- name: Verify firmware file on device
  cisco.nxos.nxos_command:
    commands:
      - dir bootflash:{{ target_firmware }} | json
  register: firmware_verification

- name: Parse firmware file information
  ansible.builtin.set_fact:
    firmware_file_info: "{{ firmware_verification.stdout[0] }}"

- name: Validate firmware file integrity
  ansible.builtin.assert:
    that:
      - firmware_file_info.file_list | length > 0
      - firmware_file_info.file_list[0].size > 1024000  # Minimum 1MB
    fail_msg: "Firmware file validation failed"

- name: Calculate MD5 hash of firmware file on device
  cisco.nxos.nxos_command:
    commands:
      - show file bootflash:{{ target_firmware }} md5sum
  register: nxos_firmware_hash
  when: firmware_md5_hash is defined

- name: Verify firmware MD5 hash
  ansible.builtin.assert:
    that:
      - firmware_md5_hash in nxos_firmware_hash.stdout[0]
    fail_msg: |
      Firmware MD5 hash mismatch!
      Expected: {{ firmware_md5_hash }}
      Device hash output: {{ nxos_firmware_hash.stdout[0] }}
  when: firmware_md5_hash is defined

- name: Set image loading results
  ansible.builtin.set_fact:
    nxos_image_loading_results:
      firmware_file: "{{ target_firmware }}"
      file_size_bytes: "{{ firmware_file_info.file_list[0].size }}"
      loading_successful: true
      hash_verified: "{{ firmware_md5_hash is defined }}"
      loading_timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"

- name: Display image loading results
  ansible.builtin.debug:
    msg:
      - >
        "Secure firmware image transfer completed
          successfully (Server-Initiated PUSH)"
      - "Local Source: {{ local_firmware_path }}"
      - >
        "Remote Destination: {{ ansible_host }}:bootflash:{{
          nxos_image_loading_results.firmware_file }}"
      - >-
        File Size: {{ (nxos_image_loading_results.file_size_bytes |
          int / 1024 / 1024) | round(2) }}MB
      - "Transfer Method: SCP (server-initiated)"
      - "Hash Verified: {{ nxos_image_loading_results.hash_verified }}"
