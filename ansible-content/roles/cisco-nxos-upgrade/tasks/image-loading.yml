---
# Cisco NX-OS Image Loading Tasks
# Securely transfers firmware images from server to device
# SECURITY: Uses server-initiated PUSH transfers (not device-initiated PULL)

- name: Set firmware paths
  ansible.builtin.set_fact:
    firmware_filename: "{{ target_firmware }}"
    local_firmware_path: "{{ firmware_base_path }}/{{ target_firmware }}"

- name: Validate EPLD firmware filename provided (if EPLD upgrade enabled)
  ansible.builtin.assert:
    that:
      - target_epld_firmware is defined
      - target_epld_firmware | length > 0
    fail_msg:
      - "EPLD upgrade enabled but target_epld_firmware not provided"
      - "You must explicitly specify the EPLD firmware filename"
      - "Example: target_epld_firmware=n9000-epld.10.3.1.img"
  when: enable_epld_upgrade | bool

- name: Set EPLD firmware paths (if EPLD upgrade enabled)
  ansible.builtin.set_fact:
    epld_firmware_filename: "{{ target_epld_firmware }}"
    local_epld_path: "{{ firmware_base_path }}/{{ target_epld_firmware }}"
  when: enable_epld_upgrade | bool

- name: Display firmware selection
  ansible.builtin.debug:
    msg:
      - "Device: {{ inventory_hostname }}"
      - "Model: {{ ansible_net_model }}"
      - "Firmware File: {{ firmware_filename }}"
      - "Full Path: {{ local_firmware_path }}"
      - "EPLD Enabled: {{ enable_epld_upgrade }}"
      - "EPLD File: {{ epld_firmware_filename if (enable_epld_upgrade | bool) else 'N/A' }}"
      - "EPLD Path: {{ local_epld_path if (enable_epld_upgrade | bool) else 'N/A' }}"

# NOTE: Storage space validation already performed in STEP 3 of main-upgrade-workflow
# STEP 3 ran "dir bootflash:" and stored image list in storage_info.images_found
# Reuse that data instead of running another dir command

- name: Check if target firmware and EPLD already exist on device
  ansible.builtin.set_fact:
    target_firmware_exists: "{{ target_firmware in storage_info.images_found }}"
    target_epld_exists: "{{ target_epld_firmware in storage_info.images_found if (enable_epld_upgrade | bool and target_epld_firmware is defined) else false }}"
  when:
    - storage_info is defined
    - storage_info.images_found is defined

- name: Set files do not exist if storage_info not available
  ansible.builtin.set_fact:
    target_firmware_exists: false
    target_epld_exists: false
  when: storage_info is not defined or storage_info.images_found is not defined

- name: Display upload status for firmware and EPLD
  ansible.builtin.debug:
    msg:
      - "Firmware status: {{ 'Already staged' if target_firmware_exists else 'Needs upload' }}"
      - "EPLD enabled: {{ enable_epld_upgrade | bool }}"
      - "EPLD status: {{ 'Already staged' if target_epld_exists else ('Needs upload' if (enable_epld_upgrade | bool) else 'Not enabled') }}"

- name: Firmware already staged - skip upload
  when: target_firmware_exists
  block:
    - name: Report firmware already staged on device
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "FIRMWARE ALREADY STAGED"
          - "=========================================="
          - "Device: {{ inventory_hostname }}"
          - "Firmware: {{ target_firmware }}"
          - "Location: bootflash:{{ target_firmware }}"
          - "Status: SKIPPING UPLOAD"
          - "Action: Proceeding to installation phase"
          - "=========================================="

    - name: Set image loading results for already staged firmware
      ansible.builtin.set_fact:
        nxos_image_loading_results:
          firmware_file: "{{ target_firmware }}"
          file_size_bytes: "{{ firmware_file_info.size_bytes }}"
          source_sha512: "{{ calculated_hash if calculated_hash is defined else 'not_verified' }}"
          device_sha512: "skipped"
          hash_verified: false
          file_uploaded: false
          loading_successful: true
          loading_timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"

- name: Report firmware upload starting
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "UPLOADING FIRMWARE TO DEVICE"
      - "=========================================="
      - "Device: {{ inventory_hostname }}"
      - "Firmware: {{ target_firmware }}"
      - "Source: {{ local_firmware_path }}"
      - "Destination: bootflash:{{ target_firmware }}"
      - "Method: SCP (Server-Initiated PUSH)"
      - "Status: STARTING UPLOAD..."
      - "=========================================="
  when: not target_firmware_exists

- name: Transfer firmware image to device (Server-Initiated PUSH)
  when: not target_firmware_exists

  block:
    - name: Enable SCP server on NX-OS device
      cisco.nxos.nxos_config:
        lines:
          - feature scp-server
      register: scp_enable_result
      failed_when: false  # May already be enabled

    - name: Log SCP server enable failures
      ansible.builtin.debug:
        msg: "Warning: Failed to enable SCP server: {{ scp_enable_result.msg if scp_enable_result.msg is defined else 'Unknown error' }}"
      when:
        - scp_enable_result is defined
        - scp_enable_result.failed is defined
        - scp_enable_result.failed | bool

    - name: Push firmware image from server to device via SCP
      cisco.nxos.nxos_file_copy:
        file_system: "bootflash:"
        local_file: "{{ local_firmware_path }}"
        remote_file: "{{ target_firmware }}"
        file_pull: false  # Server pushes to device
      register: nxos_file_copy_result
      async: "{{ file_transfer_timeout }}"
      poll: "{{ file_transfer_poll_interval }}"

    - name: Display file transfer results
      ansible.builtin.debug:
        msg:
          - "File transfer completed"
          - "Status: {{ nxos_file_copy_result.transfer_status }}"
          - "Changed: {{ nxos_file_copy_result.changed }}"

    - name: Verify secure file transfer completed successfully
      ansible.builtin.assert:
        that:
          - nxos_file_copy_result is succeeded
          - nxos_file_copy_result.transfer_status in nxos_valid_transfer_statuses
        fail_msg:
          - "Secure firmware file transfer failed or returned invalid status"
          - "Expected status: {{ nxos_valid_transfer_statuses }}"
          - "Actual status: {{ nxos_file_copy_result.transfer_status }}"
          - "Full result: {{ nxos_file_copy_result | to_nice_json }}"

- name: Post-upload verification
  when: not target_firmware_exists
  block:
    - name: Calculate SHA512 hash of firmware file on device
      cisco.nxos.nxos_command:
        commands:
          - show file bootflash:{{ target_firmware }} sha512sum
      register: nxos_firmware_hash_result

    - name: Extract device SHA512 hash from output
      ansible.builtin.set_fact:
        device_firmware_hash: "{{ nxos_firmware_hash_result.stdout[0] | regex_search('[a-f0-9]{128}') }}"

    - name: Verify firmware SHA512 hash matches source
      ansible.builtin.assert:
        that:
          - calculated_hash is defined
          - device_firmware_hash is defined
          - device_firmware_hash == calculated_hash
        fail_msg:
          - "Firmware SHA512 hash verification FAILED!"
          - "Expected (source): {{ calculated_hash if calculated_hash is defined else 'MISSING - hash verification is MANDATORY' }}"
          - "Actual (device): {{ device_firmware_hash }}"
          - "File: {{ target_firmware }}"
          - "Hash verification is REQUIRED for all firmware uploads"

    - name: Set image loading results after upload
      ansible.builtin.set_fact:
        nxos_image_loading_results:
          firmware_file: "{{ target_firmware }}"
          file_size_bytes: "{{ firmware_file_info.size_bytes }}"
          source_sha512: "{{ calculated_hash }}"
          device_sha512: "{{ device_firmware_hash }}"
          hash_verified: true
          file_uploaded: true
          loading_successful: true
          loading_timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"

    - name: Display image loading results after upload
      ansible.builtin.debug:
        msg:
          - "Secure firmware image transfer completed successfully (Server-Initiated PUSH)"
          - "Local Source: {{ local_firmware_path }}"
          - "Remote Destination: {{ ansible_host }}:bootflash:{{ nxos_image_loading_results.firmware_file }}"
          - "File Size: {{ (nxos_image_loading_results.file_size_bytes | int / 1024 / 1024) | round(2) }}MB"
          - "Transfer Method: SCP (server-initiated)"
          - "SHA512 Verified: {{ nxos_image_loading_results.hash_verified }}"

# ============================================================================
# OPTIONAL EPLD FIRMWARE UPLOAD - DELEGATED TO SEPARATE TASK FILE
# ============================================================================

- name: Load and upload EPLD firmware (optional)
  ansible.builtin.include_tasks:
    file: epld-loading.yml
  when: enable_epld_upgrade | bool
