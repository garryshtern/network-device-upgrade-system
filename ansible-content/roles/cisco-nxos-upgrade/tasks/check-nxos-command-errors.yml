---
# Reusable Error Checker and Parser for nxos_command Output
# Checks stdout entries for "ERROR:" and populates variables accordingly
#
# REQUIRED INPUT VARIABLES:
# - command_result: The registered result from nxos_command
# - variable_mapping: Dictionary mapping variable names to stdout indices
#   Example: {'gathered_arp_data': 0, 'gathered_mac_data': 1}
# - fail_on_error: Boolean - true if errors should fail the playbook (required data)
#
# BEHAVIOR:
# - Iterates through variable_mapping
# - For each variable:
#   - If stdout[index] contains "ERROR:":
#     - If fail_on_error=true: Dump error and fail
#     - If fail_on_error=false: Skip defining this variable (leave undefined)
#   - If no ERROR: Define the variable with stdout[index] data
#
# OUTPUT:
# - Sets variables as defined in variable_mapping (only if no ERROR)
# - If fail_on_error=true and ERROR found: Fails with detailed error message

- name: Check if command has valid output
  ansible.builtin.set_fact:
    command_has_error: >-
      {{
        command_result.stdout is not defined or
        (command_result.stdout is defined and (command_result.stdout | map('string') | select('search', 'ERROR:') | list | length > 0))
      }}

- name: Process nxos_command output and check for errors
  ansible.builtin.set_fact:
    "{{ mapping_item.key }}": "{{ command_result.stdout[mapping_item.value] }}"
  loop: "{{ variable_mapping | dict2items }}"
  when:
    - not (command_has_error | bool)
    - command_result.stdout | length > mapping_item.value
    - "'ERROR:' not in (command_result.stdout[mapping_item.value] | string)"
  loop_control:
    loop_var: mapping_item
    label: "{{ mapping_item.key }}"

- name: Fail if required data missing and fail_on_error is true
  ansible.builtin.fail:
    msg:
      - "Required NX-OS command data failed"
      - "Device: {{ inventory_hostname }}"
      - "Reason: {{ 'No stdout (Invalid command or execution failure)' if command_result.stdout is not defined else 'ERROR found in command output' }}"
      - "Command result: {{ command_result }}"
  when:
    - fail_on_error is defined
    - fail_on_error | bool
    - command_has_error | bool
