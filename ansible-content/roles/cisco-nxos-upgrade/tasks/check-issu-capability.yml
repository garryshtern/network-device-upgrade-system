---
# Check ISSU Capability for Cisco NX-OS Devices
# Determines if In-Service Software Upgrade is supported
# REFACTORED: Uses nxos_facts instead of show commands
#
# Note: Hardware facts already gathered in STEP 1 of main workflow
# ansible_net_model, ansible_net_platform already available

- name: Check current ISSU state impact
  cisco.nxos.nxos_command:
    commands:
      - show install all impact
  register: issu_impact
  failed_when: false
  when:
    - not ansible_check_mode

- name: Analyze dual supervisor setup from facts
  ansible.builtin.set_fact:
    has_dual_sup: "{{ ansible_net_model is search('N[679]K.*-C.*-SUP') or ansible_net_model is search('N77-C') }}"
  when:
    - not ansible_check_mode
    - ansible_net_model is defined

- name: Set has_dual_sup for check mode
  ansible.builtin.set_fact:
    has_dual_sup: false
  when:
    - ansible_check_mode

- name: Check platform ISSU support
  ansible.builtin.set_fact:
    platform_supports_issu: "{{ ansible_net_platform is search('N[679]K') }}"
  when:
    - not ansible_check_mode
    - ansible_net_platform is defined

- name: Set platform_supports_issu for check mode
  ansible.builtin.set_fact:
    platform_supports_issu: false
  when:
    - ansible_check_mode

- name: Determine ISSU compatibility
  ansible.builtin.set_fact:
    nxos_upgrade_state: >-
      {{ nxos_upgrade_state | combine({
        'issu_capable': (
          has_dual_sup and
          platform_supports_issu and
          issu_impact is defined and
          (issu_impact.rc if issu_impact.rc is defined else 1) == 0
        ),
        'upgrade_method': 'issu' if (has_dual_sup and platform_supports_issu) else 'disruptive'
      }) }}

- name: Display ISSU capability assessment
  ansible.builtin.debug:
    msg:
      - "ISSU Capability Assessment:"
      - "- Platform: {{ ansible_net_platform if ansible_net_platform is defined else 'unknown' }}"
      - "- Model: {{ ansible_net_model if ansible_net_model is defined else 'unknown' }}"
      - "- Dual Supervisors: {{ has_dual_sup }}"
      - "- Platform ISSU Support: {{ platform_supports_issu }}"
      - "- ISSU Capable: {{ nxos_upgrade_state.issu_capable }}"
      - "- Selected Method: {{ nxos_upgrade_state.upgrade_method }}"
