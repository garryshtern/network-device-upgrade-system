---
# NX-OS EPLD Loading Tasks
# Securely transfers optional EPLD firmware from server to device
# SECURITY: Uses server-initiated PUSH transfers (not device-initiated PULL)

- name: Display EPLD loading entry
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "NX-OS EPLD LOADING"
      - "=========================================="
      - "Device: {{ inventory_hostname }}"
      - "EPLD Enabled: {{ enable_epld_upgrade | bool }}"
      - "EPLD File: {{ target_epld_firmware if (enable_epld_upgrade | bool and target_epld_firmware) else 'N/A' }}"
      - "=========================================="
  when: enable_epld_upgrade | bool

- name: EPLD upgrade not enabled - skipping
  ansible.builtin.debug:
    msg: "EPLD upgrade disabled (enable_epld_upgrade=false) - skipping EPLD upload"
  when: not (enable_epld_upgrade | bool)

- name: EPLD loading block (if enabled)
  when:
    - enable_epld_upgrade | bool
    - target_epld_firmware is defined
    - target_epld_firmware | length > 0
  block:
    - name: Set EPLD firmware paths
      ansible.builtin.set_fact:
        epld_filename: "{{ target_epld_firmware }}"
        local_epld_path: "{{ firmware_base_path }}/{{ target_epld_firmware }}"

    - name: Check if target EPLD already exists on device
      ansible.builtin.set_fact:
        target_epld_exists: "{{ target_epld_firmware in storage_info.images_found if (storage_info is defined and storage_info.images_found is defined) else false }}"

    - name: Display EPLD upload status
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "NX-OS EPLD STATUS"
          - "=========================================="
          - "Device: {{ inventory_hostname }}"
          - "EPLD File: {{ target_epld_firmware }}"
          - "Local Path: {{ local_epld_path }}"
          - "Status: {{ 'Already staged' if target_epld_exists else 'Needs upload' }}"
          - "=========================================="

    - name: EPLD already staged - skip upload
      when: target_epld_exists
      block:
        - name: Report EPLD already staged on device
          ansible.builtin.debug:
            msg:
              - "=========================================="
              - "EPLD ALREADY STAGED"
              - "=========================================="
              - "Device: {{ inventory_hostname }}"
              - "EPLD: {{ target_epld_firmware }}"
              - "Location: bootflash:{{ target_epld_firmware }}"
              - "Status: SKIPPING UPLOAD"
              - "Action: Proceeding to installation phase"
              - "=========================================="

        - name: Set EPLD loading results for already staged EPLD
          ansible.builtin.set_fact:
            nxos_epld_loading_results:
              epld_file: "{{ target_epld_firmware }}"
              file_size_bytes: 0
              source_sha512: "{{ epld_calculated_hash if epld_calculated_hash is defined else 'not_verified' }}"
              device_sha512: "skipped"
              hash_verified: false
              file_uploaded: false
              loading_successful: true
              loading_timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"

    - name: EPLD firmware upload block (if not already staged)
      when: not target_epld_exists
      block:
        - name: Report EPLD upload starting
          ansible.builtin.debug:
            msg:
              - "=========================================="
              - "UPLOADING EPLD TO DEVICE"
              - "=========================================="
              - "Device: {{ inventory_hostname }}"
              - "EPLD: {{ target_epld_firmware }}"
              - "Source: {{ local_epld_path }}"
              - "Destination: bootflash:{{ target_epld_firmware }}"
              - "Method: SCP (Server-Initiated PUSH)"
              - "Status: STARTING UPLOAD..."
              - "=========================================="

        - name: Enable SCP server on NX-OS device (if not already enabled)
          cisco.nxos.nxos_config:
            lines:
              - feature scp-server
          register: scp_enable_result
          failed_when: false  # May already be enabled

        - name: Push EPLD image from server to device via SCP
          cisco.nxos.nxos_file_copy:
            file_system: "bootflash:"
            local_file: "{{ local_epld_path }}"
            remote_file: "{{ target_epld_firmware }}"
            file_pull: false  # Server pushes to device
          register: nxos_epld_file_copy_result
          async: "{{ file_transfer_timeout }}"
          poll: "{{ file_transfer_poll_interval }}"

        - name: Display EPLD file transfer results
          ansible.builtin.debug:
            msg:
              - "EPLD file transfer completed"
              - "Status: {{ nxos_epld_file_copy_result.transfer_status }}"
              - "Changed: {{ nxos_epld_file_copy_result.changed }}"

        - name: Verify EPLD secure file transfer completed successfully
          ansible.builtin.assert:
            that:
              - nxos_epld_file_copy_result is succeeded
              - nxos_epld_file_copy_result.transfer_status in nxos_valid_transfer_statuses
            fail_msg:
              - "Secure EPLD file transfer failed or returned invalid status"
              - "Expected status: {{ nxos_valid_transfer_statuses }}"
              - "Actual status: {{ nxos_epld_file_copy_result.transfer_status }}"
              - "Full result: {{ nxos_epld_file_copy_result | to_nice_json }}"

        - name: Verify EPLD file exists on device after upload
          ansible.builtin.assert:
            that:
              - target_epld_firmware in storage_info.images_found
            fail_msg:
              - "EPLD file not found on device after upload"
              - "Expected file: {{ target_epld_firmware }}"
              - "Files found: {{ storage_info.images_found }}"

        - name: Extract uploaded EPLD file size from parsed storage
          ansible.builtin.set_fact:
            uploaded_epld_size: "{{ parsed_storage.files | selectattr('1', 'equalto', target_epld_firmware) | map(attribute='0') | first | int }}"

        - name: Calculate SHA512 hash of EPLD file on device
          cisco.nxos.nxos_command:
            commands:
              - show file bootflash:{{ target_epld_firmware }} sha512sum
          register: nxos_epld_hash_result

        - name: Extract device EPLD SHA512 hash from output
          ansible.builtin.set_fact:
            device_epld_hash: "{{ nxos_epld_hash_result.stdout[0] | regex_search('[a-f0-9]{128}') }}"

        - name: Verify EPLD SHA512 hash matches source
          ansible.builtin.assert:
            that:
              - epld_calculated_hash is defined
              - device_epld_hash is defined
              - device_epld_hash == epld_calculated_hash
            fail_msg:
              - "EPLD SHA512 hash verification FAILED!"
              - "Expected (source): {{ epld_calculated_hash if epld_calculated_hash is defined else 'MISSING - hash verification is MANDATORY' }}"
              - "Actual (device): {{ device_epld_hash }}"
              - "File: {{ target_epld_firmware }}"
              - "Hash verification is REQUIRED for all EPLD uploads"

        - name: Set EPLD loading results after upload
          ansible.builtin.set_fact:
            nxos_epld_loading_results:
              epld_file: "{{ target_epld_firmware }}"
              file_size_bytes: "{{ uploaded_epld_size }}"
              source_sha512: "{{ epld_calculated_hash }}"
              device_sha512: "{{ device_epld_hash }}"
              hash_verified: true
              file_uploaded: true
              loading_successful: true
              loading_timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"

        - name: Display EPLD loading results after upload
          ansible.builtin.debug:
            msg:
              - "Secure EPLD image transfer completed successfully (Server-Initiated PUSH)"
              - "Local Source: {{ local_epld_path }}"
              - "Remote Destination: {{ ansible_host }}:bootflash:{{ nxos_epld_loading_results.epld_file }}"
              - "File Size: {{ (nxos_epld_loading_results.file_size_bytes | int / 1024 / 1024) | round(2) }}MB"
              - "Transfer Method: SCP (server-initiated)"
              - "SHA512 Verified: {{ nxos_epld_loading_results.hash_verified }}"
