---
# Cisco NX-OS Image Installation Tasks
# Installs and activates firmware images using nxos_install_os module
# REFACTORED: Uses cisco.nxos.nxos_install_os instead of manual install commands

- name: Gather current system facts
  cisco.nxos.nxos_facts:
    gather_subset:
      - hardware
  register: system_facts

- name: Display current system information
  ansible.builtin.debug:
    msg:
      - "Current image: {{ ansible_net_image }}"
      - "Current version: {{ ansible_net_version }}"
      - "Target image: {{ target_firmware_version }}"
      - "Platform: {{ ansible_net_platform }}"

- name: Install NX-OS image using nxos_install_os module
  cisco.nxos.nxos_install_os:
    system_image_file: "{{ target_firmware_version }}"
    issu: desired
  register: install_result
  vars:
    ansible_command_timeout: 1800
    ansible_connect_timeout: 1800

- name: Set installation method based on result
  ansible.builtin.set_fact:
    installation_method: "{{ 'issu' if install_result.issu_attempted | default(false) else 'disruptive' }}"
    boot_update_successful: true

- name: Set installation completion status
  ansible.builtin.set_fact:
    nxos_installation_results:
      target_firmware: "{{ target_firmware_version }}"
      installation_method: "{{ installation_method }}"
      boot_variables_updated: "{{ boot_update_successful | default(false) }}"
      issu_performed: "{{ installation_method == 'issu' }}"
      reboot_required: "{{ installation_method == 'disruptive' }}"
      installation_timestamp: >
        "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"

- name: Display installation results
  ansible.builtin.debug:
    msg:
      - "Firmware installation completed"
      - "Method: {{ nxos_installation_results.installation_method }}"
      - "Target firmware: {{ nxos_installation_results.target_firmware }}"
      - "Reboot required: {{ nxos_installation_results.reboot_required }}"

- name: Installation completion notification
  ansible.builtin.debug:
    msg: "NX-OS firmware installation phase completed successfully"
