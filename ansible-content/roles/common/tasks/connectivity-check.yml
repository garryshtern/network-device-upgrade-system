---
# Common Connectivity Check Tasks
# Platform-specific basic connectivity validation
# REDESIGNED: Uses platform-appropriate commands (not generic "show version")

- name: Platform-based connectivity check
  when: platform is defined
  block:
    - name: Initialize ansible_date_time if not defined (check mode)
      ansible.builtin.set_fact:
        ansible_date_time:
          iso8601: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
          epoch: "{{ lookup('pipe', 'date +%s') }}"
      when:
        - ansible_check_mode
        - ansible_date_time is not defined

    - name: Set platform-specific connection settings (once for entire workflow)
      ansible.builtin.set_fact:
        ansible_connection: >-
          {{
            (ansible_check_mode and platform == 'fortios') | ternary('local',
            (platform == 'nxos') | ternary('ansible.netcommon.network_cli',
            (platform == 'ios') | ternary('ansible.netcommon.network_cli',
            (platform == 'fortios') | ternary('httpapi',
            (platform == 'metamako_mos') | ternary('ansible.netcommon.network_cli',
            (platform == 'opengear') | ternary('ssh',
            ansible_connection | default('ansible.netcommon.network_cli')))))))
          }}
        ansible_network_os: >-
          {{
            (platform == 'nxos') | ternary('cisco.nxos.nxos',
            (platform == 'ios') | ternary('cisco.ios.ios',
            (platform == 'fortios') | ternary('fortinet.fortios.fortios',
            (platform == 'metamako_mos') | ternary('metamako_mos',
            (platform == 'opengear') | ternary('opengear',
            ansible_network_os | default(omit))))))
          }}
        ansible_user: >-
          {{
            (platform == 'nxos') | ternary(vault_cisco_nxos_username,
            (platform == 'ios') | ternary(vault_cisco_iosxe_username,
            (platform == 'fortios') | ternary(vault_fortios_username,
            (platform == 'metamako_mos') | ternary(vault_metamako_username,
            (platform == 'opengear') | ternary(vault_opengear_username,
            ansible_user | default('admin'))))))
          }}
        ansible_password: >-
          {{
            (platform == 'nxos') | ternary(vault_cisco_nxos_password | default(omit),
            (platform == 'ios') | ternary(vault_cisco_iosxe_password | default(omit),
            (platform == 'fortios') | ternary(vault_fortios_password | default(omit),
            (platform == 'metamako_mos') | ternary(vault_metamako_password | default(omit),
            (platform == 'opengear') | ternary(vault_opengear_password | default(omit),
            omit)))))
          }}
        ansible_ssh_private_key_file: >-
          {{
            (platform == 'nxos') | ternary(vault_cisco_nxos_ssh_key | default(omit),
            (platform == 'ios') | ternary(vault_cisco_iosxe_ssh_key | default(omit),
            (platform == 'metamako_mos') | ternary(vault_metamako_ssh_key | default(omit),
            (platform == 'opengear') | ternary(vault_opengear_ssh_key | default(omit),
            omit))))
          }}
        ansible_httpapi_key: >-
          {{
            (platform == 'fortios') | ternary(vault_fortios_api_token | default(omit), omit)
          }}

    - name: Step 1 & 2 - Connect and retrieve version information (tests auth and connection)
      when: not ansible_check_mode
      block:
        - name: Gather comprehensive NX-OS facts (hardware, interfaces, config, BGP, version)
          cisco.nxos.nxos_facts:
            gather_subset:
              - all
            gather_network_resources:
              - '!acls'
              - '!acl_interfaces'
            available_network_resources: true
          register: nxos_facts_output
          when: platform == 'nxos'

        - name: Parse and store NX-OS version from facts
          ansible.builtin.set_fact:
            device_version_info:
              raw_output: "{{ ansible_net_version }}"
              platform: "{{ platform }}"
              timestamp: "{{ ansible_date_time.iso8601 }}"
              version: "{{ ansible_net_version }}"
              model: "{{ ansible_net_model }}"
              hostname: "{{ ansible_net_hostname }}"
              serial: "{{ ansible_net_serialnum }}"
              image: "{{ ansible_net_image }}"
            current_firmware_version: "{{ ansible_net_version }}"
          when:
            - platform == 'nxos'
            - nxos_facts_output is defined
            - nxos_facts_output is succeeded

        - name: Display all NX-OS facts after successful connection
          ansible.builtin.debug:
            msg:
              - "=== NX-OS Device Facts ==="
              - "--- Device Identity ---"
              - "Hostname: {{ ansible_net_hostname | default('N/A') }}"
              - "Model: {{ ansible_net_model | default('N/A') }}"
              - "Serial Number: {{ ansible_net_serialnum | default('N/A') }}"
              - "--- Software & Image ---"
              - "OS Version: {{ ansible_net_version | default('N/A') }}"
              - "Image: {{ ansible_net_image | default('N/A') }}"
              - "License Host ID: {{ ansible_net_license_hostid | default('N/A') }}"
              - "--- System Resources ---"
              - "Memory Total: {{ ansible_net_memtotal_mb | default('N/A') }} MB"
              - "Memory Free: {{ ansible_net_memfree_mb | default('N/A') }} MB"
              - "File Systems: {{ ansible_net_filesystems | default([]) | join(', ') }}"
              - "--- Network Configuration ---"
              - "IPv4 Addresses: {{ ansible_net_all_ipv4_addresses | default([]) | join(', ') }}"
              - "IPv6 Addresses: {{ ansible_net_all_ipv6_addresses | default([]) | join(', ') }}"
              - "VLANs: {{ vlan_list | default([]) | join(', ') }}"
              - "--- Interfaces ---"
              - "Interface Names: {{ interfaces_list | default({}) | list | join(', ') }}"
              - "Interface Details: {{ ansible_net_interfaces | default({}) | dict2items | map(attribute='key') | list | join(', ') }}"
              - "--- Active Configuration ---"
              - "Config Length: {{ ansible_net_config | default('') | length }} characters"
              - "Config Available: {{ 'Yes' if ansible_net_config is defined and ansible_net_config else 'No' }}"
              - "--- Network Resources Gathered ---"
              - "Gathered Resources: {{ ansible_net_gather_network_resources | default([]) | join(', ') }}"
              - "Available Network Resources: {{ ansible_network_resources | default({}) | dict2items | map(attribute='key') | list | join(', ') }}"
              - "--- Collection Details ---"
              - "Gathered Subsets: {{ ansible_net_gather_subset | default([]) | join(', ') }}"
              - "Transport: {{ ansible_net_api | default('N/A') }}"
              - "Python Version: {{ ansible_net_python_version | default('N/A') }}"
              - "=========================="
          when:
            - platform == 'nxos'
            - nxos_facts_output is succeeded

        - name: Dump detailed NX-OS facts (lists and dictionaries)
          ansible.builtin.debug:
            msg:
              - "=== NX-OS Detailed Facts Dump ==="
              - "--- File Systems List ---"
              - "{{ ansible_net_filesystems | default([]) | to_nice_json }}"
              - "--- All IPv4 Addresses List ---"
              - "{{ ansible_net_all_ipv4_addresses | default([]) | to_nice_json }}"
              - "--- All IPv6 Addresses List ---"
              - "{{ ansible_net_all_ipv6_addresses | default([]) | to_nice_json }}"
              - "--- Interfaces Dictionary ---"
              - "{{ ansible_net_interfaces | default({}) | to_nice_json }}"
              - "--- Network Resources Dictionary ---"
              - "{{ ansible_network_resources | default({}) | to_nice_json }}"
              - "--- Gathered Network Resources List ---"
              - "{{ ansible_net_gather_network_resources | default([]) | to_nice_json }}"
              - "--- Gathered Subsets List ---"
              - "{{ ansible_net_gather_subset | default([]) | to_nice_json }}"
              - "--- Neighbors (LLDP/CDP) ---"
              - "{{ ansible_net_neighbors | default({}) | to_nice_json }}"
              - "================================="
          when:
            - platform == 'nxos'
            - nxos_facts_output is succeeded
            - show_debug | bool

        - name: Get IOS-XE version
          cisco.ios.ios_command:
            commands:
              - show version
          register: ios_version_output
          changed_when: false
          when: platform == 'ios'

        - name: Parse and store IOS-XE version
          ansible.builtin.set_fact:
            device_version_info:
              raw_output: "{{ ios_version_output.stdout[0] }}"
              platform: "{{ platform }}"
              timestamp: "{{ ansible_date_time.iso8601 }}"
              version: "{{ ios_version_output.stdout[0] | regex_search('Version ([0-9.()A-Za-z]+)', '\\1') | first }}"
            current_firmware_version: "{{ ios_version_output.stdout[0] | regex_search('Version ([0-9.()A-Za-z]+)', '\\1') | first }}"
          when:
            - platform == 'ios'
            - ios_version_output is defined
            - ios_version_output.stdout is defined
            - ios_version_output is succeeded

        - name: Get FortiOS version
          fortinet.fortios.fortios_monitor_fact:
            vdom: "root"
            selector: "system_status"
          register: fortios_version_output
          when: platform == 'fortios'

        - name: Parse and store FortiOS version
          ansible.builtin.set_fact:
            device_version_info:
              raw_output: "{{ fortios_version_output }}"
              platform: "{{ platform }}"
              timestamp: "{{ ansible_date_time.iso8601 }}"
              version: "{{ fortios_version_output.meta.results.version }}"
            current_firmware_version: "{{ fortios_version_output.meta.results.version }}"
          when:
            - platform == 'fortios'
            - fortios_version_output is defined
            - fortios_version_output is succeeded

        - name: Get Metamako version
          ansible.netcommon.cli_command:
            command: show system info
          register: mos_version_output
          changed_when: false
          when: platform == 'metamako_mos'

        - name: Parse and store Metamako version
          ansible.builtin.set_fact:
            device_version_info:
              raw_output: "{{ mos_version_output.stdout }}"
              platform: "{{ platform }}"
              timestamp: "{{ ansible_date_time.iso8601 }}"
              version: "{{ mos_version_output.stdout | regex_search('Version:\\s+([0-9.]+)', '\\1') | first }}"
            current_firmware_version: "{{ mos_version_output.stdout | regex_search('Version:\\s+([0-9.]+)', '\\1') | first }}"
          when:
            - platform == 'metamako_mos'
            - mos_version_output is defined
            - mos_version_output.stdout is defined
            - mos_version_output is succeeded

        - name: Get Opengear version
          ansible.builtin.raw: config -g config.version
          register: opengear_version_output
          changed_when: false
          when: platform == 'opengear'

        - name: Parse and store Opengear version
          ansible.builtin.set_fact:
            device_version_info:
              raw_output: "{{ opengear_version_output.stdout }}"
              platform: "{{ platform }}"
              timestamp: "{{ ansible_date_time.iso8601 }}"
              version: "{{ opengear_version_output.stdout | regex_replace('\\n', '') }}"
            current_firmware_version: "{{ opengear_version_output.stdout | regex_replace('\\n', '') }}"
          when:
            - platform == 'opengear'
            - opengear_version_output is defined
            - opengear_version_output.stdout is defined
            - opengear_version_output is succeeded

        - name: Set connection test result (success)
          ansible.builtin.set_fact:
            connection_wait_result: {"changed": false, "failed": false}
            ping_result: {"changed": false, "failed": false}
            cli_connectivity: true

      rescue:
        - name: Connection or version retrieval failed
          ansible.builtin.fail:
            msg: |
              Failed to connect to device {{ inventory_hostname }} or retrieve version information.
              This is required for upgrade operations.

              Please check:
              - Device connectivity (network, SSH access)
              - Credentials (username, password, or SSH key)
              - Device is responding to commands

              Platform: {{ platform }}
              Error occurred during version retrieval.

    - name: Simulate connectivity test in check mode
      ansible.builtin.set_fact:
        connection_wait_result: {"changed": false, "failed": false}
        ping_result: {"changed": false, "failed": false}
        cli_connectivity: true
        device_version_info:
          raw_output: "Check mode - no actual connection"
          platform: "{{ platform }}"
          timestamp: "{{ ansible_date_time.iso8601 }}"
          version: "check_mode"
        current_firmware_version: "check_mode"
      when: ansible_check_mode

    - name: Set overall connectivity status
      ansible.builtin.set_fact:
        device_connectivity:
          device: "{{ inventory_hostname }}"
          platform: "{{ platform }}"
          timestamp: "{{ ansible_date_time.iso8601 }}"
          basic_connectivity: "{{ connection_wait_result is succeeded }}"
          ping_successful: "{{ ping_result is succeeded }}"
          cli_connectivity: "{{ cli_connectivity }}"
          overall_status: >-
            {{
              (connection_wait_result is succeeded) and
              (ping_result is succeeded) and
              (cli_connectivity)
            }}

    - name: Display connectivity results
      ansible.builtin.debug:
        msg:
          - "=== Connectivity Check Results ==="
          - "Device: {{ inventory_hostname }}"
          - "Platform: {{ device_connectivity.platform }}"
          - "Ping Test: {{ 'PASS' if device_connectivity.ping_successful else 'FAIL' }}"
          - "CLI Connectivity: {{ 'PASS' if device_connectivity.cli_connectivity else 'FAIL' }}"
          - "Current Version: {{ device_version_info.version if device_version_info is defined else 'unknown' }}"
          - "Overall Status: {{ 'CONNECTED' if device_connectivity.overall_status else 'CONNECTION FAILED' }}"
          - "================================="

    - name: Fail if device is not reachable
      ansible.builtin.fail:
        msg: "Device {{ inventory_hostname }} is not reachable - connectivity check failed"
      when: not device_connectivity.overall_status

- name: Platform not defined - provide guidance
  ansible.builtin.fail:
    msg: |
      Platform variable not defined for host {{ inventory_hostname }}.

      To fix this, ensure your host is a member of a platform group in your inventory:
        - cisco_nxos (for Cisco NX-OS devices)
        - cisco_iosxe (for Cisco IOS-XE devices)
        - fortios (for Fortinet FortiGate devices)
        - metamako_mos (for Metamako devices)
        - opengear (for Opengear devices)

      Alternatively, define 'platform' variable in host_vars for this host.

      Current groups: {{ group_names | default([]) }}
  when: platform is not defined
