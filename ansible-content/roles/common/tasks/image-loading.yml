---
# Image Loading Tasks
# Extracted from image-loading.yml playbook for task inclusion
# Downloads and stages firmware images on network devices

- name: Display image loading entry
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "ENTERING IMAGE LOADING TASK"
      - "=========================================="
      - "Device: {{ inventory_hostname }}"
      - "Platform: {{ platform }}"
      - "=========================================="

- name: Set image loading variables
  ansible.builtin.set_fact:
    firmware_source_path: "{{ firmware_base_path }}"
    device_storage_path: "/var/lib/firmware"
    integrity_check_required: true
    cleanup_old_images: true

# NOTE: Image integrity is already validated in main-upgrade-workflow STEP 3
# before calling this task. No need to validate again here.

# NOTE: Storage capacity is already checked in main-upgrade-workflow STEP 2
# with automatic cleanup. No need to check again here.

- name: Platform-specific image loading
  block:
    - name: Load firmware image (platform-specific)
      ansible.builtin.include_role:
        name: "{{ platform_role_map[platform] }}"
        tasks_from: image-loading
      when:
        - platform is defined
        - platform in platform_role_map
        - not (platform == 'fortios' and ansible_check_mode)

- name: Build image loading metrics data
  ansible.builtin.set_fact:
    loading_metric_data:
      device_id: "{{ inventory_hostname }}"
      firmware_version: "{{ firmware_version }}"
      platform: "{{ platform }}"
      status: "success"
      timestamp: "{{ ansible_date_time.iso8601 }}"
  when:
    - export_metrics | bool

- name: Record image loading completion
  ansible.builtin.include_role:
    name: common
    tasks_from: metrics-export
  vars:
    metric_type: "image_loading"
    metric_data: "{{ loading_metric_data }}"
  when:
    - export_metrics | bool

- name: Display loading results
  ansible.builtin.debug:
    msg:
      - "=== Image Loading Complete ==="
      - "Device: {{ inventory_hostname }}"
      - "Platform: {{ platform }}"
      - "Firmware: {{ firmware_version }}"
      - "Status: LOADED"
      - "=============================="
