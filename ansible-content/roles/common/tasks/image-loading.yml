---
# Image Loading Tasks
# Extracted from image-loading.yml playbook for task inclusion
# Downloads and stages firmware images on network devices

- name: Set image loading variables
  ansible.builtin.set_fact:
    firmware_source_path: "{{ firmware_base_path }}"
    device_storage_path: "/var/lib/firmware"
    integrity_check_required: true
    cleanup_old_images: true

- name: Validate firmware file integrity (existence, size, permissions, extension)
  ansible.builtin.include_role:
    name: image-validation
    tasks_from: integrity-audit

- name: Check device storage capacity
  ansible.builtin.include_role:
    name: space-management
    tasks_from: space-check
  vars:
    required_space_gb: "{{ firmware_size_gb }}"

- name: Platform-specific image loading
  block:
    # Cisco NX-OS Image Loading
    - name: Load Cisco NX-OS image
      ansible.builtin.include_role:
        name: cisco-nxos-upgrade
        tasks_from: image-loading
      when:
        - ansible_network_os is defined
        - platform == 'nxos'

    # Cisco IOS-XE Image Loading
    - name: Load Cisco IOS-XE image
      ansible.builtin.include_role:
        name: cisco-iosxe-upgrade
        tasks_from: image-loading
      when:
        - ansible_network_os is defined
        - platform == 'ios'

    # Metamako MOS Image Loading
    - name: Load Metamako MOS image
      ansible.builtin.include_role:
        name: metamako-mos-upgrade
        tasks_from: image-loading
      when:
        - ansible_network_os is defined
        - platform == 'metamako_mos'

    # Opengear Image Loading
    - name: Load Opengear image
      ansible.builtin.include_role:
        name: opengear-upgrade
        tasks_from: image-loading
      when:
        - ansible_network_os is defined
        - platform == 'opengear'

    # FortiOS Image Loading
    - name: Load FortiOS image
      ansible.builtin.include_role:
        name: fortios-upgrade
        tasks_from: image-loading
      when:
        - ansible_network_os is defined
        - platform == 'fortios'
        - not ansible_check_mode

- name: Verify image integrity
  ansible.builtin.include_role:
    name: image-validation
    tasks_from: hash-verification

- name: Record image loading completion
  ansible.builtin.include_role:
    name: common
    tasks_from: metrics-export
  vars:
    metric_type: "image_loading"
    metric_data:
      device_id: "{{ inventory_hostname }}"
      firmware_version: "{{ firmware_version }}"
      platform: "{{ platform }}"
      status: "success"
      timestamp: "{{ ansible_date_time.iso8601 }}"

- name: Display loading results
  ansible.builtin.debug:
    msg:
      - "=== Image Loading Complete ==="
      - "Device: {{ inventory_hostname }}"
      - "Platform: {{ platform }}"
      - "Firmware: {{ firmware_version }}"
      - "Status: LOADED"
      - "=============================="
