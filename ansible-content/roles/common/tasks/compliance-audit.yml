---
# Compliance Audit Tasks
# Extracted from compliance-audit.yml playbook for task inclusion
# Post-upgrade compliance verification and reporting

- name: Initialize compliance audit state
  ansible.builtin.set_fact:
    compliance_results:
      device_name: "{{ inventory_hostname }}"
      platform: "{{ platform }}"
      audit_timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      firmware_version: "{{ current_firmware_version }}"
      standards_tested: []
      compliance_checks:
        passed: []
        failed: []
        skipped: []
        warnings: []

- name: Create compliance audit directory
  ansible.builtin.file:
    path: "{{ compliance_results_path }}/{{ inventory_hostname }}"
    state: directory
    mode: "0755"
  delegate_to: localhost

- name: Security Baseline Compliance Check
  when: "'security_baseline' in (compliance_standards)"
  block:
    - name: Run security baseline audit placeholder
      ansible.builtin.set_fact:
        security_baseline_results:
          passed: ["ssh_hardening", "password_policy"]
          failed: []
          skipped: []
          warnings: ["weak_encryption_detected"]

    - name: Verify security baseline audit completed successfully
      ansible.builtin.assert:
        that:
          - security_baseline_results is defined
          - security_baseline_results.passed is defined
          - security_baseline_results.failed is defined
        fail_msg:
          - "CRITICAL: Security baseline compliance audit failed"
          - "Device: {{ inventory_hostname }}"
          - "Expected security baseline results but audit did not complete properly"
          - "This indicates a critical security compliance failure"

    - name: Update compliance results - security baseline
      ansible.builtin.set_fact:
        compliance_results: >-
          {{
            compliance_results | combine({
              'standards_tested':
                compliance_results.standards_tested + ['security_baseline'],
              'compliance_checks': {
                'passed':
                  compliance_results.compliance_checks.passed +
                  security_baseline_results.passed,
                'failed':
                  compliance_results.compliance_checks.failed +
                  security_baseline_results.failed,
                'skipped':
                  compliance_results.compliance_checks.skipped +
                  security_baseline_results.skipped,
                'warnings':
                  compliance_results.compliance_checks.warnings +
                  security_baseline_results.warnings
              }
            })
          }}

- name: Network Hardening Compliance Check
  when: "'network_hardening' in (compliance_standards)"
  block:
    - name: Run network hardening audit placeholder
      ansible.builtin.set_fact:
        network_hardening_results:
          passed: ["acl_configuration", "snmp_security"]
          failed: []
          skipped: []
          warnings: []

    - name: Verify network hardening audit completed successfully
      ansible.builtin.assert:
        that:
          - network_hardening_results is defined
          - network_hardening_results.passed is defined
          - network_hardening_results.failed is defined
        fail_msg:
          - "CRITICAL: Network hardening compliance audit failed"
          - "Device: {{ inventory_hostname }}"
          - "Expected network hardening results but audit did not complete properly"
          - "This indicates a critical network hardening failure"

    - name: Update compliance results - network hardening
      ansible.builtin.set_fact:
        compliance_results: >
          {{
            compliance_results | combine({
              'standards_tested':
                compliance_results.standards_tested + ['network_hardening'],
              'compliance_checks': {
                'passed':
                  compliance_results.compliance_checks.passed +
                  network_hardening_results.passed,
                'failed':
                  compliance_results.compliance_checks.failed +
                  network_hardening_results.failed,
                'skipped':
                  compliance_results.compliance_checks.skipped +
                  network_hardening_results.skipped,
                'warnings':
                  compliance_results.compliance_checks.warnings +
                  network_hardening_results.warnings
              }
            })
          }}

- name: Platform-Specific Compliance Checks
  block:
    - name: Platform-specific compliance placeholder
      ansible.builtin.set_fact:
        platform_compliance_results:
          passed: ["platform_config_valid"]
          failed: []
          skipped: []
          warnings: []

    - name: Verify platform compliance audit completed successfully
      when: platform_compliance_results is defined
      ansible.builtin.assert:
        that:
          - platform_compliance_results is defined
          - platform_compliance_results.passed is defined
          - platform_compliance_results.failed is defined
        fail_msg:
          - "CRITICAL: Platform-specific compliance audit failed"
          - "Device: {{ inventory_hostname }}"
          - "Platform: {{ platform }}"
          - "Expected platform compliance results but audit did not complete properly"
          - "This indicates a critical platform-specific compliance failure"

    - name: Update compliance results - platform specific
      ansible.builtin.set_fact:
        compliance_results: >
          {{
            compliance_results | combine({
              'standards_tested':
                compliance_results.standards_tested + ['platform_specific'],
              'compliance_checks': {
                'passed':
                  compliance_results.compliance_checks.passed +
                  platform_compliance_results.passed,
                'failed':
                  compliance_results.compliance_checks.failed +
                  platform_compliance_results.failed,
                'skipped':
                  compliance_results.compliance_checks.skipped +
                  platform_compliance_results.skipped,
                'warnings':
                  compliance_results.compliance_checks.warnings +
                  platform_compliance_results.warnings
              }
            })
          }}
      when: platform_compliance_results is defined

- name: Calculate total checks count
  ansible.builtin.set_fact:
    total_checks: >-
      {{ (compliance_results.compliance_checks.passed |
        length + compliance_results.compliance_checks.failed | length) }}

- name: Calculate compliance percentage
  ansible.builtin.set_fact:
    compliance_percentage: >-
      {{ (compliance_results.compliance_checks.passed |
        length / total_checks * 100) | round(2) if
        total_checks | int > 0 else 0 }}

- name: Display compliance audit results
  ansible.builtin.debug:
    msg:
      - "=== Compliance Audit Results ==="
      - "Device: {{ inventory_hostname }}"
      - "Platform: {{ platform }}"
      - "Firmware Version: {{ compliance_results.firmware_version }}"
      - "Audit Timestamp: {{ compliance_results.audit_timestamp }}"
      - "Standards Tested: {{ compliance_results.standards_tested | join(', ') }}"
      - "Checks Passed: {{ compliance_results.compliance_checks.passed | length }}"
      - "Checks Failed: {{ compliance_results.compliance_checks.failed | length }}"
      - "Warnings: {{ compliance_results.compliance_checks.warnings | length }}"
      - "Compliance Score: {{ compliance_percentage }}%"
      - "Overall Status: {{ 'COMPLIANT' if compliance_percentage >= 90 else 'NON-COMPLIANT' }}"
      - "==============================="

- name: Record compliance completion
  ansible.builtin.include_role:
    name: common
    tasks_from: metrics-export
  vars:
    metric_type: "compliance_audit"
    metric_data:
      device_id: "{{ inventory_hostname }}"
      compliance_score: "{{ compliance_percentage }}"
      platform: "{{ platform }}"
      status: "success"
      timestamp: "{{ compliance_results.audit_timestamp }}"
  when:
    - export_metrics | bool
