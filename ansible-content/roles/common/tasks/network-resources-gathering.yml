---
# Comprehensive Network Resources Gathering
# Gathers all network resources needed for validation (BGP, interfaces, routing, VLANs, etc.)
# Called AFTER basic connectivity is established and image is staged
#
# Prerequisites:
# - Basic facts already gathered (ansible_net_version, ansible_net_hostname, etc.)
# - Platform variable defined
# - Device connection established
#
# Gathers:
# - Configuration facts: BGP, interfaces, VLANs, LAG, LACP, BFD, route-maps, etc.
# - Operational state: ARP, MAC, routing tables, multicast, BFD neighbors

- name: Verify platform variable is defined
  ansible.builtin.assert:
    that:
      - platform is defined
      - platform != ''
    fail_msg: "Platform variable is not defined or empty. Cannot gather network resources without platform information."

- name: Display platform being processed
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "NETWORK RESOURCES GATHERING"
      - "=========================================="
      - "Device: {{ inventory_hostname }}"
      - "Platform: {{ platform }}"
      - "Supported platforms: nxos, ios"
      - "=========================================="

- name: NX-OS comprehensive network resources gathering
  when: platform == 'nxos'
  block:
    - name: Initialize gathered data variables
      ansible.builtin.set_fact:
        gathered_arp_data: {}
        gathered_mac_data: {}
        gathered_rib_data: {}
        gathered_fib_data: {}
        gathered_bfd_data: {}
        gathered_pim_interface_data: {}
        gathered_pim_neighbor_data: {}
        gathered_pim_rp_data: {}
        gathered_anycast_rp_data: {}
        gathered_igmp_interface_data: {}
        gathered_igmp_groups_data: {}
        gathered_mroute_summary_data: {}
        gathered_mroute_data: {}

    - name: Gather comprehensive NX-OS network resources
      cisco.nxos.nxos_facts:
        gather_subset:
          - all
        gather_network_resources:
          - interfaces
          - l2_interfaces
          - l3_interfaces
          - vlans
          - lag_interfaces
          - lacp_interfaces
          - bfd_interfaces
          - bgp_global
          - bgp_address_family
          - bgp_neighbor_address_family
          - route_maps
          - prefix_lists
          - static_routes
          - lldp_global
          - lldp_interfaces
          - ntp_global
          - snmp_server
          - logging_global
          - hostname
        available_network_resources: true
      register: nxos_network_resources

    - name: Gather NX-OS operational state data (ARP and MAC required)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip arp vrf all
            output: json
          - command: show mac address-table
            output: json
      register: nxos_validation_data
      changed_when: false

    - name: Gather RIB data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip route vrf all
            output: json
      register: nxos_rib_data
      changed_when: false
      failed_when: false

    - name: Gather FIB data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show forwarding ipv4 route
            output: json
      register: nxos_fib_data
      changed_when: false
      failed_when: false

    - name: Gather BFD data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show bfd neighbors vrf all
            output: json
      register: nxos_bfd_data
      changed_when: false
      failed_when: false

    - name: Gather PIM interface data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip pim interface
            output: json
      register: nxos_pim_interface_data
      changed_when: false
      failed_when: false

    - name: Gather PIM neighbor data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip pim neighbor
            output: json
      register: nxos_pim_neighbor_data
      changed_when: false
      failed_when: false

    - name: Gather PIM RP data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip pim rp
            output: json
      register: nxos_pim_rp_data
      changed_when: false
      failed_when: false

    - name: Gather PIM Anycast RP data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip pim anycast-rp
            output: json
      register: nxos_anycast_rp_data
      changed_when: false
      failed_when: false

    - name: Gather IGMP interface data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip igmp interface
            output: json
      register: nxos_igmp_interface_data
      changed_when: false
      failed_when: false

    - name: Gather IGMP groups data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip igmp groups
            output: json
      register: nxos_igmp_groups_data
      changed_when: false
      failed_when: false

    - name: Gather mroute summary data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip mroute summary
            output: json
      register: nxos_mroute_summary_data
      changed_when: false
      failed_when: false

    - name: Gather mroute data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip mroute
            output: json
      register: nxos_mroute_data
      changed_when: false
      failed_when: false

    - name: Parse operational data (required)
      ansible.builtin.include_role:
        name: cisco-nxos-upgrade
        tasks_from: check-nxos-command-errors
      vars:
        command_result: "{{ nxos_validation_data }}"
        variable_mapping:
          gathered_arp_data: 0
          gathered_mac_data: 1
        fail_on_error: true

    - name: Parse all optional operational data
      ansible.builtin.include_role:
        name: cisco-nxos-upgrade
        tasks_from: check-nxos-command-errors
      vars:
        command_result: "{{ item.result }}"
        variable_mapping: "{{ item.mapping }}"
        fail_on_error: false
      loop:
        - result: "{{ nxos_rib_data }}"
          mapping: {gathered_rib_data: 0}
        - result: "{{ nxos_fib_data }}"
          mapping: {gathered_fib_data: 0}
        - result: "{{ nxos_bfd_data }}"
          mapping: {gathered_bfd_data: 0}
        - result: "{{ nxos_pim_interface_data }}"
          mapping: {gathered_pim_interface_data: 0}
        - result: "{{ nxos_pim_neighbor_data }}"
          mapping: {gathered_pim_neighbor_data: 0}
        - result: "{{ nxos_pim_rp_data }}"
          mapping: {gathered_pim_rp_data: 0}
        - result: "{{ nxos_anycast_rp_data }}"
          mapping: {gathered_anycast_rp_data: 0}
        - result: "{{ nxos_igmp_interface_data }}"
          mapping: {gathered_igmp_interface_data: 0}
        - result: "{{ nxos_igmp_groups_data }}"
          mapping: {gathered_igmp_groups_data: 0}
        - result: "{{ nxos_mroute_summary_data }}"
          mapping: {gathered_mroute_summary_data: 0}
        - result: "{{ nxos_mroute_data }}"
          mapping: {gathered_mroute_data: 0}
      loop_control:
        label: "{{ item.mapping.keys() | list | first }}"

    - name: Normalize baseline data by removing time-sensitive fields
      block:
        - name: Initialize normalized data variables
          ansible.builtin.set_fact:
            normalized_arp_data: {}
            normalized_mac_data: {}
            normalized_rib_data: {}
            normalized_fib_data: {}
            normalized_bfd_data: {}
            normalized_pim_interface_data: {}
            normalized_pim_neighbor_data: {}
            normalized_igmp_interface_data: {}
            normalized_igmp_groups_data: {}
            normalized_mroute_data: {}

        - name: Normalize ARP data
          ansible.builtin.include_tasks:
            file: "{{ role_path }}/../network-validation/tasks/normalize-baseline-data.yml"
          vars:
            data_to_normalize: "{{ gathered_arp_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.arp_data | default([]) }}"
            data_type: "ARP"
          register: normalized_arp_result

        - name: Store normalized ARP data
          ansible.builtin.set_fact:
            normalized_arp_data: "{{ normalized_data }}"
          when: normalized_arp_result is not skipped

        - name: Normalize MAC data
          ansible.builtin.include_tasks:
            file: "{{ role_path }}/../network-validation/tasks/normalize-baseline-data.yml"
          vars:
            data_to_normalize: "{{ gathered_mac_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.mac_data | default([]) }}"
            data_type: "MAC"
          register: normalized_mac_result

        - name: Store normalized MAC data
          ansible.builtin.set_fact:
            normalized_mac_data: "{{ normalized_data }}"
          when: normalized_mac_result is not skipped

        - name: Normalize RIB data
          ansible.builtin.include_tasks:
            file: "{{ role_path }}/../network-validation/tasks/normalize-baseline-data.yml"
          vars:
            data_to_normalize: "{{ gathered_rib_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.rib_data | default([]) }}"
            data_type: "RIB"
          register: normalized_rib_result

        - name: Store normalized RIB data
          ansible.builtin.set_fact:
            normalized_rib_data: "{{ normalized_data }}"
          when: normalized_rib_result is not skipped

        - name: Normalize FIB data
          ansible.builtin.include_tasks:
            file: "{{ role_path }}/../network-validation/tasks/normalize-baseline-data.yml"
          vars:
            data_to_normalize: "{{ gathered_fib_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.fib_data | default([]) }}"
            data_type: "FIB"
          register: normalized_fib_result

        - name: Store normalized FIB data
          ansible.builtin.set_fact:
            normalized_fib_data: "{{ normalized_data }}"
          when: normalized_fib_result is not skipped

        - name: Normalize BFD data
          ansible.builtin.include_tasks:
            file: "{{ role_path }}/../network-validation/tasks/normalize-baseline-data.yml"
          vars:
            data_to_normalize: "{{ gathered_bfd_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.bfd_data | default([]) }}"
            data_type: "BFD"
          register: normalized_bfd_result

        - name: Store normalized BFD data
          ansible.builtin.set_fact:
            normalized_bfd_data: "{{ normalized_data }}"
          when: normalized_bfd_result is not skipped

        - name: Normalize PIM interface data
          ansible.builtin.include_tasks:
            file: "{{ role_path }}/../network-validation/tasks/normalize-baseline-data.yml"
          vars:
            data_to_normalize: "{{ gathered_pim_interface_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.pim_interface_data | default([]) }}"
            data_type: "PIM Interface"
          register: normalized_pim_interface_result

        - name: Store normalized PIM interface data
          ansible.builtin.set_fact:
            normalized_pim_interface_data: "{{ normalized_data }}"
          when: normalized_pim_interface_result is not skipped

        - name: Normalize PIM neighbor data
          ansible.builtin.include_tasks:
            file: "{{ role_path }}/../network-validation/tasks/normalize-baseline-data.yml"
          vars:
            data_to_normalize: "{{ gathered_pim_neighbor_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.pim_neighbor_data | default([]) }}"
            data_type: "PIM Neighbor"
          register: normalized_pim_neighbor_result

        - name: Store normalized PIM neighbor data
          ansible.builtin.set_fact:
            normalized_pim_neighbor_data: "{{ normalized_data }}"
          when: normalized_pim_neighbor_result is not skipped

        - name: Normalize IGMP interface data
          ansible.builtin.include_tasks:
            file: "{{ role_path }}/../network-validation/tasks/normalize-baseline-data.yml"
          vars:
            data_to_normalize: "{{ gathered_igmp_interface_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.igmp_interface_data | default([]) }}"
            data_type: "IGMP Interface"
          register: normalized_igmp_interface_result

        - name: Store normalized IGMP interface data
          ansible.builtin.set_fact:
            normalized_igmp_interface_data: "{{ normalized_data }}"
          when: normalized_igmp_interface_result is not skipped

        - name: Normalize IGMP groups data
          ansible.builtin.include_tasks:
            file: "{{ role_path }}/../network-validation/tasks/normalize-baseline-data.yml"
          vars:
            data_to_normalize: "{{ gathered_igmp_groups_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.igmp_groups_data | default([]) }}"
            data_type: "IGMP Groups"
          register: normalized_igmp_groups_result

        - name: Store normalized IGMP groups data
          ansible.builtin.set_fact:
            normalized_igmp_groups_data: "{{ normalized_data }}"
          when: normalized_igmp_groups_result is not skipped

        - name: Normalize Mroute data
          ansible.builtin.include_tasks:
            file: "{{ role_path }}/../network-validation/tasks/normalize-baseline-data.yml"
          vars:
            data_to_normalize: "{{ gathered_mroute_data }}"
            fields_to_exclude: "{{ baseline_comparison_excluded_fields.mroute_data | default([]) }}"
            data_type: "Mroute"
          register: normalized_mroute_result

        - name: Store normalized Mroute data
          ansible.builtin.set_fact:
            normalized_mroute_data: "{{ normalized_data }}"
          when: normalized_mroute_result is not skipped

    - name: Store network baseline data (normalized for time-agnostic comparison)
      ansible.builtin.set_fact:
        network_baseline:
          platform: "{{ platform }}"
          device: "{{ inventory_hostname }}"
          network_resources: "{{ ansible_network_resources }}"
          arp_data: "{{ normalized_arp_data if normalized_arp_data else gathered_arp_data }}"
          mac_data: "{{ normalized_mac_data if normalized_mac_data else gathered_mac_data }}"
          rib_data: "{{ normalized_rib_data if normalized_rib_data else gathered_rib_data }}"
          fib_data: "{{ normalized_fib_data if normalized_fib_data else gathered_fib_data }}"
          bfd_data: "{{ normalized_bfd_data if normalized_bfd_data else gathered_bfd_data }}"
          pim_interface_data: "{{ normalized_pim_interface_data if normalized_pim_interface_data else gathered_pim_interface_data }}"
          pim_neighbor_data: "{{ normalized_pim_neighbor_data if normalized_pim_neighbor_data else gathered_pim_neighbor_data }}"
          pim_rp_data: "{{ gathered_pim_rp_data }}"
          igmp_interface_data: "{{ normalized_igmp_interface_data if normalized_igmp_interface_data else gathered_igmp_interface_data }}"
          igmp_groups_data: "{{ normalized_igmp_groups_data if normalized_igmp_groups_data else gathered_igmp_groups_data }}"
          mroute_summary_data: "{{ gathered_mroute_summary_data }}"
          mroute_data: "{{ normalized_mroute_data if normalized_mroute_data else gathered_mroute_data }}"
          anycast_rp_data: "{{ gathered_anycast_rp_data }}"

    - name: Display gathered network resources summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "NETWORK RESOURCES GATHERED"
          - "=========================================="
          - "Device: {{ inventory_hostname }}"
          - "Platform: {{ platform }}"
          - "Gathered Resources: {{ ansible_net_gather_network_resources | default([]) | join(', ') }}"
          - "Available Resources: {{ ansible_network_resources | default({}) | dict2items | map(attribute='key') | list | join(', ') }}"
          - "Baseline Data Stored:"
          - "  - ARP data: {{ 'Yes' if network_baseline.arp_data | length > 0 else 'No' }}"
          - "  - MAC data: {{ 'Yes' if network_baseline.mac_data | length > 0 else 'No' }}"
          - "  - RIB data: {{ 'Yes' if network_baseline.rib_data | length > 0 else 'No' }}"
          - "  - FIB data: {{ 'Yes' if network_baseline.fib_data | length > 0 else 'No' }}"
          - "  - BFD data: {{ 'Yes' if network_baseline.bfd_data | length > 0 else 'No' }}"
          - "  - PIM data: {{ 'Yes' if network_baseline.pim_interface_data | length > 0 else 'No' }}"
          - "  - IGMP data: {{ 'Yes' if network_baseline.igmp_interface_data | length > 0 else 'No' }}"
          - "  - Mroute data: {{ 'Yes' if network_baseline.mroute_data | length > 0 else 'No' }}"
          - "Status: Ready for validation and baseline comparison"
          - "=========================================="
      when:
        - show_debug | bool
        - network_baseline is defined

    - name: Create baseline directory
      ansible.builtin.file:
        path: "{{ baseline_base_path }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      when:
        - network_baseline is defined
        - validation_phase is defined
        - validation_phase == 'pre_upgrade'

    - name: Save network baseline to filesystem (pre-upgrade only)
      ansible.builtin.copy:
        content: "{{ network_baseline | to_nice_json }}"
        dest: "{{ baseline_base_path }}/{{ inventory_hostname }}_network_baseline.json"
        mode: '0644'
      delegate_to: localhost
      when:
        - network_baseline is defined
        - validation_phase is defined
        - validation_phase == 'pre_upgrade'

    - name: Save post-upgrade baseline to file (post-upgrade only)
      ansible.builtin.copy:
        content: "{{ network_baseline | to_nice_json }}"
        dest: "{{ baseline_base_path }}/{{ inventory_hostname }}_post_upgrade_baseline.json"
        mode: '0644'
      delegate_to: localhost
      changed_when: false
      when:
        - network_baseline is defined
        - validation_phase is defined
        - validation_phase == 'post_upgrade'

    - name: Load pre-upgrade baseline for comparison (post-upgrade only)
      block:
        - name: Check if baseline file exists
          ansible.builtin.stat:
            path: "{{ baseline_base_path }}/{{ inventory_hostname }}_network_baseline.json"
          register: baseline_file
          delegate_to: localhost

        - name: Load baseline data
          ansible.builtin.set_fact:
            network_baseline_pre: "{{ lookup('file', baseline_base_path + '/' + inventory_hostname + '_network_baseline.json') | from_json }}"
          when: baseline_file.stat.exists

        - name: Store current state as post-upgrade data
          ansible.builtin.set_fact:
            network_baseline_post: "{{ network_baseline }}"

      when:
        - validation_phase is defined
        - validation_phase == 'post_upgrade'

  rescue:
    - name: Network resources gathering failed
      ansible.builtin.fail:
        msg: |
          Failed to gather comprehensive network resources for {{ inventory_hostname }}.

          This is required for pre-upgrade validation.
          Please check:
          - Device is still reachable
          - Platform configuration is correct
          - Network resource modules are supported on this device

- name: IOS-XE comprehensive network resources gathering
  when: platform == 'ios'
  block:
    - name: Gather comprehensive IOS-XE facts
      cisco.ios.ios_facts:
        gather_subset:
          - all
      register: ios_network_resources

    - name: Display gathered network resources summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "NETWORK RESOURCES GATHERED"
          - "=========================================="
          - "Device: {{ inventory_hostname }}"
          - "Platform: {{ platform }}"
          - "Status: Ready for validation"
          - "=========================================="
      when: show_debug | bool

  rescue:
    - name: Network resources gathering failed
      ansible.builtin.fail:
        msg: |
          Failed to gather comprehensive network resources for {{ inventory_hostname }}.

          This is required for pre-upgrade validation.

- name: Skip network resources gathering for other platforms
  ansible.builtin.debug:
    msg: "Platform {{ platform }} does not require comprehensive network resources gathering at this stage"
  when: platform not in ['nxos', 'ios']
