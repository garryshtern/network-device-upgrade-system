---
# Comprehensive Network Resources Gathering
# Gathers all network resources needed for validation (BGP, interfaces, routing, VLANs, etc.)
# Called AFTER basic connectivity is established and image is staged
#
# Prerequisites:
# - Basic facts already gathered (ansible_net_version, ansible_net_hostname, etc.)
# - Platform variable defined
# - Device connection established
#
# Gathers:
# - Configuration facts: BGP, interfaces, VLANs, LAG, LACP, BFD, route-maps, etc.
# - Operational state: ARP, MAC, routing tables, multicast, BFD neighbors

- name: Verify platform variable is defined
  ansible.builtin.assert:
    that:
      - platform is defined
      - platform != ''
    fail_msg: "Platform variable is not defined or empty. Cannot gather network resources without platform information."

- name: Display platform being processed
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "NETWORK RESOURCES GATHERING"
      - "=========================================="
      - "Device: {{ inventory_hostname }}"
      - "Platform: {{ platform }}"
      - "Supported platforms: nxos, ios"
      - "=========================================="

- name: NX-OS comprehensive network resources gathering
  when: platform == 'nxos'
  block:
    - name: Load baseline data for post-upgrade comparison (BEFORE gathering current data)
      when:
        - validation_phase is defined
        - validation_phase == 'post_upgrade'
        - baseline_file_pre_upgrade is defined
      block:
        - name: Check if baseline file exists
          ansible.builtin.stat:
            path: "{{ baseline_file_pre_upgrade }}"
          register: baseline_file
          delegate_to: localhost

        - name: Load baseline data
          ansible.builtin.set_fact:
            network_baseline_pre: "{{ lookup('file', baseline_file_pre_upgrade) | from_json }}"
          when: baseline_file.stat.exists

    - name: Initialize gathered data variables
      ansible.builtin.set_fact:
        gathered_arp_data: {}
        gathered_mac_data: {}
        gathered_rib_data: {}
        gathered_fib_data: {}
        gathered_bfd_data: {}
        gathered_pim_interface_data: {}
        gathered_pim_neighbor_data: {}
        gathered_pim_rp_data: {}
        gathered_anycast_rp_data: {}
        gathered_igmp_interface_data: {}
        gathered_igmp_groups_data: {}
        gathered_mroute_summary_data: {}
        gathered_mroute_data: {}

    - name: Gather comprehensive NX-OS network resources
      cisco.nxos.nxos_facts:
        gather_subset:
          - all
        gather_network_resources:
          - interfaces
          - l2_interfaces
          - l3_interfaces
          - vlans
          - lag_interfaces
          - lacp_interfaces
          - bfd_interfaces
          - bgp_global
          - bgp_address_family
          - bgp_neighbor_address_family
          - route_maps
          - prefix_lists
          - static_routes
          - lldp_global
          - lldp_interfaces
          - ntp_global
          - snmp_server
          - logging_global
          - hostname
        available_network_resources: true
      register: nxos_network_resources

    - name: Gather NX-OS operational state data (ARP and MAC required)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip arp vrf all
            output: json
          - command: show mac address-table
            output: json
      register: nxos_validation_data
      changed_when: false

    - name: Gather RIB data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip route vrf all
            output: json
      register: nxos_rib_data
      changed_when: false
      failed_when: false

    - name: Gather FIB data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show forwarding ipv4 route
            output: json
      register: nxos_fib_data
      changed_when: false
      failed_when: false

    - name: Gather BFD data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show bfd neighbors vrf all
            output: json
      register: nxos_bfd_data
      changed_when: false
      failed_when: false

    - name: Gather PIM interface data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip pim interface
            output: json
      register: nxos_pim_interface_data
      changed_when: false
      failed_when: false

    - name: Gather PIM neighbor data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip pim neighbor
            output: json
      register: nxos_pim_neighbor_data
      changed_when: false
      failed_when: false

    - name: Gather PIM RP data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip pim rp
            output: json
      register: nxos_pim_rp_data
      changed_when: false
      failed_when: false

    - name: Gather PIM Anycast RP data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip pim anycast-rp
            output: json
      register: nxos_anycast_rp_data
      changed_when: false
      failed_when: false

    - name: Gather IGMP interface data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip igmp interface
            output: json
      register: nxos_igmp_interface_data
      changed_when: false
      failed_when: false

    - name: Gather IGMP groups data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip igmp groups
            output: json
      register: nxos_igmp_groups_data
      changed_when: false
      failed_when: false

    - name: Gather mroute summary data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip mroute summary
            output: json
      register: nxos_mroute_summary_data
      changed_when: false
      failed_when: false

    - name: Gather mroute data (optional)
      cisco.nxos.nxos_command:
        commands:
          - command: show ip mroute
            output: json
      register: nxos_mroute_data
      changed_when: false
      failed_when: false

    - name: Parse operational data (required)
      ansible.builtin.include_role:
        name: cisco-nxos-upgrade
        tasks_from: check-nxos-command-errors
      vars:
        command_result: "{{ nxos_validation_data }}"
        variable_mapping:
          gathered_arp_data: 0
          gathered_mac_data: 1
        fail_on_error: true

    - name: Parse all optional operational data
      ansible.builtin.include_role:
        name: cisco-nxos-upgrade
        tasks_from: check-nxos-command-errors
      vars:
        command_result: "{{ item.result }}"
        variable_mapping: "{{ item.mapping }}"
        fail_on_error: false
      loop:
        - result: "{{ nxos_rib_data }}"
          mapping: {gathered_rib_data: 0}
        - result: "{{ nxos_fib_data }}"
          mapping: {gathered_fib_data: 0}
        - result: "{{ nxos_bfd_data }}"
          mapping: {gathered_bfd_data: 0}
        - result: "{{ nxos_pim_interface_data }}"
          mapping: {gathered_pim_interface_data: 0}
        - result: "{{ nxos_pim_neighbor_data }}"
          mapping: {gathered_pim_neighbor_data: 0}
        - result: "{{ nxos_pim_rp_data }}"
          mapping: {gathered_pim_rp_data: 0}
        - result: "{{ nxos_anycast_rp_data }}"
          mapping: {gathered_anycast_rp_data: 0}
        - result: "{{ nxos_igmp_interface_data }}"
          mapping: {gathered_igmp_interface_data: 0}
        - result: "{{ nxos_igmp_groups_data }}"
          mapping: {gathered_igmp_groups_data: 0}
        - result: "{{ nxos_mroute_summary_data }}"
          mapping: {gathered_mroute_summary_data: 0}
        - result: "{{ nxos_mroute_data }}"
          mapping: {gathered_mroute_data: 0}
      loop_control:
        label: "{{ item.mapping.keys() | list | first }}"

    - name: Store network baseline data (raw, unmodified for comparison)
      ansible.builtin.set_fact:
        network_baseline:
          platform: "{{ platform }}"
          device: "{{ inventory_hostname }}"
          network_resources: "{{ ansible_network_resources }}"
          arp_data: "{{ gathered_arp_data }}"
          mac_data: "{{ gathered_mac_data }}"
          rib_data: "{{ gathered_rib_data }}"
          fib_data: "{{ gathered_fib_data }}"
          bfd_data: "{{ gathered_bfd_data }}"
          pim_interface_data: "{{ gathered_pim_interface_data }}"
          pim_neighbor_data: "{{ gathered_pim_neighbor_data }}"
          pim_rp_data: "{{ gathered_pim_rp_data }}"
          igmp_interface_data: "{{ gathered_igmp_interface_data }}"
          igmp_groups_data: "{{ gathered_igmp_groups_data }}"
          mroute_summary_data: "{{ gathered_mroute_summary_data }}"
          mroute_data: "{{ gathered_mroute_data }}"
          anycast_rp_data: "{{ gathered_anycast_rp_data }}"

    - name: Display gathered network resources summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "NETWORK RESOURCES GATHERED"
          - "=========================================="
          - "Device: {{ inventory_hostname }}"
          - "Platform: {{ platform }}"
          - "Gathered Resources: {{ ansible_net_gather_network_resources | default([]) | join(', ') }}"
          - "Available Resources: {{ ansible_network_resources | default({}) | dict2items | map(attribute='key') | list | join(', ') }}"
          - "Baseline Data Stored:"
          - "  - ARP data: {{ 'Yes' if network_baseline.arp_data | length > 0 else 'No' }}"
          - "  - MAC data: {{ 'Yes' if network_baseline.mac_data | length > 0 else 'No' }}"
          - "  - RIB data: {{ 'Yes' if network_baseline.rib_data | length > 0 else 'No' }}"
          - "  - FIB data: {{ 'Yes' if network_baseline.fib_data | length > 0 else 'No' }}"
          - "  - BFD data: {{ 'Yes' if network_baseline.bfd_data | length > 0 else 'No' }}"
          - "  - PIM data: {{ 'Yes' if network_baseline.pim_interface_data | length > 0 else 'No' }}"
          - "  - IGMP data: {{ 'Yes' if network_baseline.igmp_interface_data | length > 0 else 'No' }}"
          - "  - Mroute data: {{ 'Yes' if network_baseline.mroute_data | length > 0 else 'No' }}"
          - "Status: Ready for validation and baseline comparison"
          - "=========================================="
      when:
        - show_debug | bool
        - network_baseline is defined

    - name: Create baseline directory
      ansible.builtin.file:
        path: "{{ baseline_base_path }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      when:
        - network_baseline is defined
        - validation_phase is defined
        - validation_phase == 'pre_upgrade'

    - name: Save network baseline to filesystem (pre-upgrade only)
      ansible.builtin.copy:
        content: "{{ network_baseline | to_nice_json }}"
        dest: "{{ baseline_file_pre_upgrade }}"
        mode: '0644'
      delegate_to: localhost
      when:
        - network_baseline is defined
        - validation_phase is defined
        - validation_phase == 'pre_upgrade'
        - baseline_file_pre_upgrade is defined

    - name: Save post-upgrade baseline to file (post-upgrade only)
      ansible.builtin.copy:
        content: "{{ network_baseline | to_nice_json }}"
        dest: "{{ baseline_file_post_upgrade }}"
        mode: '0644'
      delegate_to: localhost
      changed_when: false
      when:
        - network_baseline is defined
        - validation_phase is defined
        - validation_phase == 'post_upgrade'
        - baseline_file_post_upgrade is defined

    - name: Alias post-upgrade data for validation comparison
      when:
        - validation_phase is defined
        - validation_phase == 'post_upgrade'
      ansible.builtin.set_fact:
        network_baseline_post: "{{ network_baseline }}"
      # Note: This aliases network_baseline to network_baseline_post so validation tasks
      # can reference post-upgrade data with a clear naming convention (vs network_baseline_pre)

  rescue:
    - name: Network resources gathering failed
      ansible.builtin.fail:
        msg: |
          Failed to gather comprehensive network resources for {{ inventory_hostname }}.

          This is required for pre-upgrade validation.
          Please check:
          - Device is still reachable
          - Platform configuration is correct
          - Network resource modules are supported on this device

- name: IOS-XE comprehensive network resources gathering
  when: platform == 'ios'
  block:
    - name: Gather comprehensive IOS-XE facts
      cisco.ios.ios_facts:
        gather_subset:
          - all
      register: ios_network_resources

    - name: Display gathered network resources summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "NETWORK RESOURCES GATHERED"
          - "=========================================="
          - "Device: {{ inventory_hostname }}"
          - "Platform: {{ platform }}"
          - "Status: Ready for validation"
          - "=========================================="
      when: show_debug | bool

  rescue:
    - name: Network resources gathering failed
      ansible.builtin.fail:
        msg: |
          Failed to gather comprehensive network resources for {{ inventory_hostname }}.

          This is required for pre-upgrade validation.

- name: Skip network resources gathering for other platforms
  ansible.builtin.debug:
    msg: "Platform {{ platform }} does not require comprehensive network resources gathering at this stage"
  when: platform not in ['nxos', 'ios']
