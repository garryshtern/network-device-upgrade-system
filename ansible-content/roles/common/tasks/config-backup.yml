---
# Configuration Backup Tasks
# Extracted from config-backup.yml playbook for task inclusion
# Creates comprehensive device configuration backups before upgrades

- name: Set backup variables
  ansible.builtin.set_fact:
    backup_timestamp: >-
      {{ ansible_date_time.iso8601 if ansible_date_time is defined
         else lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}
    backup_base_path: "/var/lib/network-upgrade/backups"
    backup_type: "{{ backup_type | default('pre_upgrade') }}"
    include_startup_config: "{{ include_startup_config | default(true) }}"
    include_running_config: true

- name: Create backup directory structure
  ansible.builtin.file:
    path: >-
      {{ backup_base_path }}/{{ inventory_hostname }}/
      {{ backup_timestamp | regex_replace(':', '-') }}
    state: directory
    mode: '0755'
  delegate_to: localhost

- name: Platform-specific configuration backup
  block:
    # For test purposes, we'll create a simple backup placeholder
    # In production, this would include platform-specific backup tasks
    - name: Create backup placeholder for testing
      ansible.builtin.copy:
        content: |
          # Configuration backup placeholder for {{ ansible_network_os }}
          # Device: {{ inventory_hostname }}
          # Timestamp: {{ backup_timestamp }}
          # Platform: {{ ansible_network_os }}
        dest: >-
          {{ backup_base_path }}/{{ inventory_hostname }}/
          {{ backup_timestamp | regex_replace(':', '-') }}/config_backup.txt
        mode: '0644'
      delegate_to: localhost

- name: Record backup completion
  ansible.builtin.include_tasks: ../roles/common/tasks/metrics-export.yml
  vars:
    metric_type: "config_backup"
    metric_data:
      device_id: "{{ inventory_hostname }}"
      backup_timestamp: "{{ backup_timestamp }}"
      platform: "{{ ansible_network_os }}"
      backup_type: "{{ backup_type }}"
      status: "success"

- name: Display backup results
  ansible.builtin.debug:
    msg:
      - "=== Configuration Backup Complete ==="
      - "Device: {{ inventory_hostname }}"
      - "Platform: {{ ansible_network_os }}"
      - "Backup Type: {{ backup_type }}"
      - "Timestamp: {{ backup_timestamp }}"
      - "Status: SUCCESS"
      - "===================================="