---
# Configuration Backup Tasks
# Extracted from config-backup.yml playbook for task inclusion
# Creates comprehensive device configuration backups before upgrades

- name: Set backup variables
  ansible.builtin.set_fact:
    backup_timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
    backup_type: "{{ backup_type }}"
    include_startup_config: "{{ include_startup_config  }}"
    include_running_config: true

- name: Create backup directory structure
  ansible.builtin.file:
    path: "{{ backup_base_path }}/{{ inventory_hostname }}/{{ backup_timestamp | regex_replace(':', '-') }}"
    state: directory
    mode: '0755'
  delegate_to: localhost

- name: Create backup directory for this device
  ansible.builtin.file:
    path: "{{ backup_base_path }}/{{ inventory_hostname }}/{{ backup_timestamp | regex_replace(':', '-') }}"
    state: directory
    mode: '0755'
  delegate_to: localhost

- name: Platform-specific configuration backup
  block:
    - name: Backup NX-OS running config
      cisco.nxos.nxos_command:
        commands:
          - command: show running-config
            output: text
      register: nxos_running_config
      when: platform == 'nxos'
      changed_when: false

    - name: Backup IOS-XE running config
      cisco.ios.ios_command:
        commands:
          - command: show running-config
            output: text
      register: ios_running_config
      when: platform == 'ios'
      changed_when: false

    - name: Save NX-OS config backup to file
      ansible.builtin.copy:
        content: "{{ nxos_running_config.stdout[0] if nxos_running_config is defined and nxos_running_config.stdout | length > 0 else '# No config retrieved' }}"
        dest: "{{ backup_base_path }}/{{ inventory_hostname }}/{{ backup_timestamp | regex_replace(':', '-') }}/running-config.txt"
        mode: '0644'
      delegate_to: localhost
      when: platform == 'nxos'

    - name: Save IOS-XE config backup to file
      ansible.builtin.copy:
        content: "{{ ios_running_config.stdout[0] if ios_running_config is defined and ios_running_config.stdout | length > 0 else '# No config retrieved' }}"
        dest: "{{ backup_base_path }}/{{ inventory_hostname }}/{{ backup_timestamp | regex_replace(':', '-') }}/running-config.txt"
        mode: '0644'
      delegate_to: localhost
      when: platform == 'ios'

- name: Record backup completion
  ansible.builtin.include_role:
    name: common
    tasks_from: metrics-export
  vars:
    metric_type: "config_backup"
    metric_data:
      device_id: "{{ inventory_hostname }}"
      backup_timestamp: "{{ backup_timestamp }}"
      platform: "{{ platform }}"
      backup_type: "{{ backup_type }}"
      status: "success"
  when:
    - export_metrics | bool

- name: Display backup results
  ansible.builtin.debug:
    msg:
      - "=== Configuration Backup Complete ==="
      - "Device: {{ inventory_hostname }}"
      - "Platform: {{ platform }}"
      - "Backup Type: {{ backup_type }}"
      - "Timestamp: {{ backup_timestamp }}"
      - "Status: SUCCESS"
      - "===================================="
