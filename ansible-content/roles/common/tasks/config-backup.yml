---
# Configuration Backup Tasks
# Extracted from config-backup.yml playbook for task inclusion
# Creates comprehensive device configuration backups before upgrades

- name: Set backup variables
  ansible.builtin.set_fact:
    backup_timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
    backup_type: "{{ backup_type }}"
    include_startup_config: "{{ include_startup_config }}"
    include_running_config: true

- name: Create backup directory for this device
  ansible.builtin.file:
    path: "{{ backup_base_path }}/{{ inventory_hostname }}/{{ backup_timestamp | regex_replace(':', '-') }}"
    state: directory
    mode: '0755'
  delegate_to: localhost

- name: Platform-specific configuration backup
  block:
    - name: Gather NX-OS configuration facts
      cisco.nxos.nxos_facts:
        gather_subset:
          - config
      register: nxos_config_facts
      when: platform == 'nxos'

    - name: Gather IOS-XE configuration facts
      cisco.ios.ios_facts:
        gather_subset:
          - config
      register: ios_config_facts
      when: platform == 'ios'

    - name: Save NX-OS config backup to file
      ansible.builtin.copy:
        content: "{{ ansible_net_config | default('# No config retrieved') }}"
        dest: "{{ backup_base_path }}/{{ inventory_hostname }}/{{ backup_timestamp | regex_replace(':', '-') }}/running-config.txt"
        mode: '0644'
      delegate_to: localhost
      when: platform == 'nxos'

    - name: Save IOS-XE config backup to file
      ansible.builtin.copy:
        content: "{{ ansible_net_config | default('# No config retrieved') }}"
        dest: "{{ backup_base_path }}/{{ inventory_hostname }}/{{ backup_timestamp | regex_replace(':', '-') }}/running-config.txt"
        mode: '0644'
      delegate_to: localhost
      when: platform == 'ios'

- name: Display backup results
  ansible.builtin.debug:
    msg:
      - "=== Configuration Backup Complete ==="
      - "Device: {{ inventory_hostname }}"
      - "Platform: {{ platform }}"
      - "Backup Type: {{ backup_type }}"
      - "Timestamp: {{ backup_timestamp }}"
      - "Status: SUCCESS"
      - "===================================="
