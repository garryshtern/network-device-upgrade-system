---
# Common Error Handling Tasks
# Provides standardized error handling and recovery procedures

- name: Log failure details
  ansible.builtin.debug:
    msg:
      - "=== TASK FAILURE DETECTED ==="
      - "Failed Task: {{ ansible_failed_task.name }}"
      - "Host: {{ inventory_hostname }}"
      - "Error: {{ ansible_failed_result.msg }}"
      - "Timestamp: {{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      - "=========================="

- name: Set failure state
  ansible.builtin.set_fact:
    task_failed: true
    failure_details:
      failed_task: "{{ ansible_failed_task.name }}"
      error_message: >
        "{{ ansible_failed_result.msg }}"
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      host: "{{ inventory_hostname }}"

- name: Send failure notification
  ansible.builtin.debug:
    msg: "ALERT: Task failure on {{ inventory_hostname }} - {{ ansible_failed_task.name }}"
  when:
    - task_failed is defined
    - task_failed
