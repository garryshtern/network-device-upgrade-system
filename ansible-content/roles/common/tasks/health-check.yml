---
# Device Health Check Tasks
# Pre-upgrade validation and baseline network state capture
# Supports all vendor platforms with comprehensive state validation
# Note: This is a task file, not a standalone playbook

- name: Set health check timestamp
  ansible.builtin.set_fact:
    health_check_timestamp: >
      "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
    validation_timeout: 300

- name: Ensure baseline directory exists
  ansible.builtin.file:
    path: "{{ baseline_data_path }}/{{ inventory_hostname }}"
    state: directory
    mode: "0755"
  delegate_to: localhost
  run_once: true

- name: Device reachability test
  ansible.builtin.include_role:
    name: common
    tasks_from: wait-for-device
  vars:
    wait_timeout: 60
    wait_delay: 5

- name: Device reachability verification
  ansible.builtin.ping:
  register: ping_result

- name: Capture network state baseline
  ansible.builtin.include_role:
    name: network-validation
    tasks_from: bgp-validation
  vars:
    capture_mode: "baseline"
    output_file: >-
      {{ baseline_data_path }}/{{ inventory_hostname
        }}/bgp_baseline_{{ health_check_timestamp }}.json
  when:
    - platform in ['nxos', 'ios', 'eos']
    - not ansible_check_mode

- name: Capture interface states
  ansible.builtin.include_role:
    name: network-validation
    tasks_from: interface-validation
  vars:
    capture_mode: "baseline"
    output_file: >-
      {{ baseline_data_path }}/{{ inventory_hostname
        }}/interfaces_baseline_{{ health_check_timestamp }}.json
  when:
    - platform in ['nxos', 'ios', 'eos']
    - not ansible_check_mode

- name: Capture routing information
  ansible.builtin.include_role:
    name: network-validation
    tasks_from: routing-validation
  vars:
    capture_mode: "baseline"
    output_file: >-
      {{ baseline_data_path }}/{{ inventory_hostname
        }}/routing_baseline_{{ health_check_timestamp }}.json
  when:
    - platform in ['nxos', 'ios', 'eos']
    - not ansible_check_mode

- name: Capture multicast state (if applicable)
  ansible.builtin.include_role:
    name: network-validation
    tasks_from: multicast-validation
  vars:
    capture_mode: "baseline"
    output_file: >-
      {{ baseline_data_path }}/{{ inventory_hostname
        }}/multicast_baseline_{{ health_check_timestamp }}.json
  when:
    - platform in ['nxos', 'ios']
    - multicast_enabled
    - not ansible_check_mode

- name: Capture ARP tables
  ansible.builtin.include_role:
    name: network-validation
    tasks_from: arp-validation
  vars:
    capture_mode: "baseline"
    output_file: >-
      {{ baseline_data_path }}/{{ inventory_hostname
        }}/arp_baseline_{{ health_check_timestamp }}.json
  when:
    - platform in ['nxos', 'ios', 'eos']
    - not ansible_check_mode

- name: Create health check summary
  ansible.builtin.template:
    src: health-summary.j2
    dest: "{{ baseline_data_path }}/{{ inventory_hostname }}/health_summary_{{ health_check_timestamp }}.json"
    mode: "0644"
  vars:
    check_timestamp: "{{ health_check_timestamp }}"
    device_name: "{{ inventory_hostname }}"
    platform: "{{ platform }}"
    connectivity_status: >
      "{{ 'success' if connection_wait_result is succeeded else 'failed' }}"
    baseline_files:
      - "bgp_baseline_{{ health_check_timestamp }}.json"
      - "interfaces_baseline_{{ health_check_timestamp }}.json"
      - "routing_baseline_{{ health_check_timestamp }}.json"
      - "multicast_baseline_{{ health_check_timestamp }}.json"
      - "arp_baseline_{{ health_check_timestamp }}.json"
  delegate_to: localhost

- name: Build health check metrics data
  ansible.builtin.set_fact:
    health_metric_data:
      device_id: "{{ inventory_hostname }}"
      platform: "{{ platform }}"
      check_timestamp: "{{ health_check_timestamp }}"
      status: "success"
      baseline_captured: true
  when:
    - export_metrics | bool

- name: Export health check metrics
  ansible.builtin.include_role:
    name: common
    tasks_from: metrics-export
  vars:
    metric_type: "health_check"
    metric_data: "{{ health_metric_data }}"
  when:
    - export_metrics | bool

- name: Display health check results
  ansible.builtin.debug:
    msg:
      - "=== Health Check Complete ==="
      - "Device: {{ inventory_hostname }}"
      - "Platform: {{ platform }}"
      - "Timestamp: {{ health_check_timestamp }}"
      - "Baseline Data: {{ baseline_data_path }}/{{ inventory_hostname }}/"
      - "Status: HEALTHY"
      - "============================"
