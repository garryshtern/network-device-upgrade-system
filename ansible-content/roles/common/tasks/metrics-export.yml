---
# Common Metrics Export Tasks
# Exports metrics to InfluxDB and other monitoring systems

- name: Skip metrics export if no data
  ansible.builtin.meta: end_host
  when: metric_data | length == 0

- name: InfluxDB metrics export
  when:
    - send_metrics | bool
    - influxdb_url is defined
    - influxdb_token is defined
  block:
    - name: Build InfluxDB line protocol entry
      ansible.builtin.set_fact:
        influx_line_parts:
          - "{{ metric_type }}"
          - "device_id={{ inventory_hostname }},platform={{ platform }}"

    - name: Add metric fields to line protocol
      ansible.builtin.set_fact:
        influx_fields_list: "{{ influx_fields_list | default([]) + [item.key + '=' + item.value | string] }}"
      loop: "{{ metric_data | dict2items }}"
      when: metric_data | length > 0

    - name: Export metrics to InfluxDB
      ansible.builtin.uri:
        url: "{{ influxdb_url }}/api/v2/write?bucket={{ influxdb_bucket }}&org={{ influxdb_org }}"
        method: POST
        headers:
          Authorization: "Token {{ influxdb_token }}"
          Content-Type: "text/plain; charset=utf-8"
        body: "{{ metric_type }},device_id={{ inventory_hostname }},platform={{ platform }} {{ influx_fields_list | join(',') }}"
        status_code: [204]
      register: influx_export_result
      when: influx_fields_list is defined
      failed_when: false

    - name: Log InfluxDB export status
      ansible.builtin.debug:
        msg: "Metrics exported to InfluxDB: {{ 'SUCCESS' if influx_export_result is succeeded else 'FAILED' }}"
      when: influx_export_result is defined

    - name: Set InfluxDB export result
      ansible.builtin.set_fact:
        influxdb_export_status: >-
          {{ 'success' if influx_export_result is succeeded else
            'failed' if influx_export_result is defined else 'skipped' }}

    - name: Send metrics to external webhook (if configured)
      ansible.builtin.uri:
        url: "{{ metrics_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
          Authorization: "Bearer {{ metrics_webhook_token }}"
        body_format: json
        body:
          timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
          device_id: "{{ inventory_hostname }}"
          metric_type: "{{ metric_type }}"
          platform: "{{ platform }}"
          data: "{{ metric_data }}"
      register: webhook_export_result
      when: metrics_webhook_url is defined
      failed_when: false

    - name: Set metrics export results
      ansible.builtin.set_fact:
        metrics_export_results:
          metric_type: "{{ metric_type }}"
          influxdb_export: "{{ influxdb_export_status }}"
          webhook_export: >-
            {{ 'success' if webhook_export_result is succeeded else
              'failed' if webhook_export_result is defined else 'skipped' }}
          local_log: "{{ log_metrics_locally }}"
          timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"

    - name: Display metrics export summary
      ansible.builtin.debug:
        msg:
          - "Metrics export completed:"
          - "Type: {{ metrics_export_results.metric_type }}"
          - "InfluxDB: {{ metrics_export_results.influxdb_export }}"
          - "Webhook: {{ metrics_export_results.webhook_export }}"
          - "Local log: {{ metrics_export_results.local_log }}"
      when: debug_metrics | bool

- name: Update NetBox custom fields (if applicable)
  ansible.builtin.uri:
    url: "{{ netbox_url }}/api/dcim/devices/"
    method: PATCH
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ inventory_hostname }}"
      custom_fields: "{{ netbox_custom_fields }}"
    status_code: [200, 201]
  when:
    - netbox_url is defined
    - netbox_token is defined
    - netbox_custom_fields is defined
    - update_netbox
  failed_when: false
