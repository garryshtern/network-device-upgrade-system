---
# Common Metrics Export Tasks
# Exports metrics to InfluxDB and other monitoring systems

- name: Initialize metric_data if not provided
  ansible.builtin.set_fact:
    metric_data: {}
  when: metric_data is not defined

- name: Set default metric timestamp
  ansible.builtin.set_fact:
    metric_timestamp: "{{ ansible_play_batch | to_json | hash('md5') }}000000000"

- name: Prepare InfluxDB line protocol data
  ansible.builtin.set_fact:
    influx_measurement: "{{ metric_type }}"
    influx_tags: "device_id={{ inventory_hostname }},device_type={{ platform }},site_location={{ site_name }},vendor={{ vendor }},platform={{ platform }}"

- name: Convert metric data to InfluxDB field format
  ansible.builtin.set_fact:
    influx_field_string: >-
      {% for item in metric_data | dict2items %}{{ item.key }}={{ item.value }}{% if not loop.last %},{% endif %}{% endfor %}
  when: metric_data | length > 0

- name: Build InfluxDB line protocol string
  ansible.builtin.set_fact:
    influx_line: >
      "{{ influx_measurement }},{{ influx_tags }} {{
        influx_field_string }} {{ metric_timestamp }}"
  when: influx_field_string is defined

- name: Export metrics to InfluxDB
  ansible.builtin.uri:
    url: >
      "{{ influxdb_url }}/api/v2/write?bucket={{
        influxdb_bucket }}&org={{ influxdb_org }}"
    method: POST
    headers:
      Authorization: "Token {{ influxdb_token }}"
      Content-Type: "text/plain; charset=utf-8"
    body: "{{ influx_line }}"
    status_code: [204]
  register: influx_export_result
  when:
    - influxdb_url is defined
    - influxdb_token is defined
    - influx_line is defined
    - send_metrics | bool
  failed_when: false

- name: Log InfluxDB export status
  ansible.builtin.debug:
    msg: >-
      Metrics exported to InfluxDB: {{ 'SUCCESS' if
        influx_export_result is succeeded else 'FAILED' }}
  when: influx_export_result is defined

- name: Export metrics to local file (backup/debugging)
  ansible.builtin.lineinfile:
    path: "{{ log_base_path }}/metrics.log"
    line: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }} | {{ inventory_hostname }} | {{ metric_type }} | {{ metric_data | to_json }}"
    create: true
    mode: "0644"
  delegate_to: localhost
  when: log_metrics_locally | bool
  failed_when: false

- name: Send metrics to external webhook (if configured)
  ansible.builtin.uri:
    url: "{{ metrics_webhook_url }}"
    method: POST
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ metrics_webhook_token  }}"
    body_format: json
    body:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      device_id: "{{ inventory_hostname }}"
      metric_type: "{{ metric_type }}"
      platform: "{{ platform }}"
      data: "{{ metric_data  }}"
  register: webhook_export_result
  when:
    - metrics_webhook_url is defined
    - send_metrics | bool
  failed_when: false

- name: Update NetBox custom fields (if applicable)
  ansible.builtin.uri:
    url: "{{ netbox_url }}/api/dcim/devices/"
    method: PATCH
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ inventory_hostname }}"
      custom_fields: "{{ netbox_custom_fields  }}"
    status_code: [200, 201]
  when:
    - netbox_url is defined
    - netbox_token is defined
    - netbox_custom_fields is defined
    - update_netbox
  failed_when: false

- name: Set metrics export results
  ansible.builtin.set_fact:
    metrics_export_results:
      metric_type: "{{ metric_type }}"
      influxdb_export: >-
        {{ 'success' if influx_export_result is succeeded else
          'failed' if influx_export_result is defined else 'skipped' }}
      webhook_export: >-
        {{ 'success' if webhook_export_result is succeeded else
          'failed' if webhook_export_result is defined else 'skipped' }}
      local_log: "{{ log_metrics_locally  }}"
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"

- name: Display metrics export summary
  ansible.builtin.debug:
    msg:
      - "Metrics export completed:"
      - "Type: {{ metrics_export_results.metric_type }}"
      - "InfluxDB: {{ metrics_export_results.influxdb_export }}"
      - "Webhook: {{ metrics_export_results.webhook_export }}"
      - "Local log: {{ metrics_export_results.local_log }}"
  when: debug_metrics | bool
