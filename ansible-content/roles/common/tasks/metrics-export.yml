---
# Common Metrics Export Tasks
# Exports metrics to InfluxDB and other monitoring systems

- name: Set default metric timestamp
  ansible.builtin.set_fact:
    metric_timestamp: "{{ ansible_play_batch | hash('md5') }}000000000"  # InfluxDB nanosecond format

- name: Prepare InfluxDB line protocol data
  ansible.builtin.set_fact:
    influx_measurement: "{{ metric_type | default('generic_metric') }}"
    influx_tags: >-
      device_id={{ inventory_hostname }},
      device_type={{ ansible_network_os | default('unknown') }},
      site_location={{ site_name | default('unknown') }},
      vendor={{ vendor | default('unknown') }},
      platform={{ ansible_network_os | default('unknown') }}
    influx_fields: "{{ metric_data | default({}) }}"

- name: Convert metric data to InfluxDB field format
  ansible.builtin.set_fact:
    influx_field_string: "{{ influx_fields | dict2items | map('join', '=') | join(',') }}"
  when: influx_fields | length > 0

- name: Build InfluxDB line protocol string
  ansible.builtin.set_fact:
    influx_line: "{{ influx_measurement }},{{ influx_tags }} {{ influx_field_string }} {{ metric_timestamp }}"
  when: influx_field_string is defined

- name: Export metrics to InfluxDB
  ansible.builtin.uri:
    url: "{{ influxdb_url }}/api/v2/write?bucket={{ influxdb_bucket }}&org={{ influxdb_org }}"
    method: POST
    headers:
      Authorization: "Token {{ influxdb_token }}"
      Content-Type: "text/plain; charset=utf-8"
    body: "{{ influx_line }}"
    status_code: [204]
  register: influx_export_result
  when: 
    - influxdb_url is defined
    - influxdb_token is defined
    - influx_line is defined
    - send_metrics | default(true)
  ignore_errors: true

- name: Log InfluxDB export status
  ansible.builtin.debug:
    msg: "Metrics exported to InfluxDB: {{ 'SUCCESS' if influx_export_result is succeeded else 'FAILED' }}"
  when: influx_export_result is defined

- name: Export metrics to local file (backup/debugging)
  ansible.builtin.lineinfile:
    path: "/var/log/network-upgrade/metrics.log"
    line: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }} | {{ inventory_hostname }} | {{ metric_type | default('unknown') }} | {{ metric_data | to_json }}"
    create: true
    mode: '0644'
  delegate_to: localhost
  when: log_metrics_locally | default(false)
  ignore_errors: true

- name: Send metrics to external webhook (if configured)
  ansible.builtin.uri:
    url: "{{ metrics_webhook_url }}"
    method: POST
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ metrics_webhook_token | default('') }}"
    body_format: json
    body:
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
      device_id: "{{ inventory_hostname }}"
      metric_type: "{{ metric_type | default('unknown') }}"
      platform: "{{ ansible_network_os | default('unknown') }}"
      data: "{{ metric_data | default({}) }}"
  register: webhook_export_result
  when: 
    - metrics_webhook_url is defined
    - send_metrics | default(true)
  ignore_errors: true

- name: Update NetBox custom fields (if applicable)
  ansible.builtin.uri:
    url: "{{ netbox_url }}/api/dcim/devices/"
    method: PATCH
    headers:
      Authorization: "Token {{ netbox_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ inventory_hostname }}"
      custom_fields: "{{ netbox_custom_fields | default({}) }}"
    status_code: [200, 201]
  when: 
    - netbox_url is defined
    - netbox_token is defined
    - netbox_custom_fields is defined
    - update_netbox | default(false)
  ignore_errors: true

- name: Set metrics export results
  ansible.builtin.set_fact:
    metrics_export_results:
      metric_type: "{{ metric_type | default('unknown') }}"
      influxdb_export: "{{ 'success' if influx_export_result is succeeded else 'failed' if influx_export_result is defined else 'skipped' }}"
      webhook_export: "{{ 'success' if webhook_export_result is succeeded else 'failed' if webhook_export_result is defined else 'skipped' }}"
      local_log: "{{ log_metrics_locally | default(false) }}"
      timestamp: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"

- name: Display metrics export summary
  ansible.builtin.debug:
    msg:
      - "Metrics export completed:"
      - "Type: {{ metrics_export_results.metric_type }}"
      - "InfluxDB: {{ metrics_export_results.influxdb_export }}"
      - "Webhook: {{ metrics_export_results.webhook_export }}"
      - "Local log: {{ metrics_export_results.local_log }}"
  when: debug_metrics | default(false)