---
# Hash verification tasks
# MANDATORY: SHA512 hash file must exist for all firmware images

- name: Check for SHA512 hash file
  ansible.builtin.stat:
    path: "{{ firmware_base_path }}/{{ target_firmware }}.sha512"
  register: hash_file_stat
  delegate_to: localhost

- name: Enforce mandatory SHA512 hash file requirement
  ansible.builtin.assert:
    that:
      - hash_file_stat.stat.exists
    fail_msg:
      - "MANDATORY SHA512 hash file missing!"
      - "Required file: {{ firmware_base_path }}/{{ target_firmware }}.sha512"
      - "Hash verification is REQUIRED for all firmware uploads"
      - "Create the hash file with: sha512sum {{ target_firmware }} > {{ target_firmware }}.sha512"

- name: Read SHA512 hash from file
  ansible.builtin.slurp:
    src: "{{ firmware_base_path }}/{{ target_firmware }}.sha512"
  register: expected_hash_content
  delegate_to: localhost

- name: Extract and validate SHA512 hash value
  ansible.builtin.set_fact:
    expected_hash: "{{ (expected_hash_content.content | b64decode).split()[0] | trim }}"

- name: Verify SHA512 hash format is valid
  ansible.builtin.assert:
    that:
      - expected_hash | length == 128
      - expected_hash is match('^[a-f0-9]{128}$')
    fail_msg:
      - "Invalid SHA512 hash format in {{ target_firmware }}.sha512"
      - "Hash value: {{ expected_hash }}"
      - "Expected: 128 hexadecimal characters"

- name: Calculate SHA512 hash of firmware file
  ansible.builtin.stat:
    path: "{{ firmware_base_path }}/{{ target_firmware }}"
    get_checksum: true
    checksum_algorithm: sha512
  register: firmware_file_hash
  delegate_to: localhost

- name: Verify firmware SHA512 hash matches expected value
  ansible.builtin.assert:
    that:
      - firmware_file_hash.stat.checksum == expected_hash
    fail_msg:
      - "Firmware SHA512 hash verification FAILED!"
      - "File: {{ target_firmware }}"
      - "Expected: {{ expected_hash }}"
      - "Calculated: {{ firmware_file_hash.stat.checksum }}"
      - "The firmware file may be corrupted or the hash file is incorrect"
    success_msg: "SHA512 hash verification passed for {{ target_firmware }}"

- name: Set hash verification result
  ansible.builtin.set_fact:
    hash_verification_passed: true
    calculated_hash: "{{ firmware_file_hash.stat.checksum }}"
    expected_hash_value: "{{ expected_hash }}"
