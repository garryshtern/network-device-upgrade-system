---
# Image integrity audit tasks

- name: Determine firmware filename for validation
  ansible.builtin.set_fact:
    firmware_filename_for_validation: >-
      {%- if target_firmware.endswith(('.bin', '.nxos', '.spa', '.pkg', '.out', '.mos', '.tar.gz', '.dgz')) -%}
        {{ target_firmware }}
      {%- else -%}
        {%- if ansible_network_os in ['cisco.nxos.nxos', 'nxos'] -%}
          nxos-{{ target_firmware }}.bin
        {%- elif ansible_network_os in ['cisco.ios.ios', 'ios'] -%}
          iosxe-{{ target_firmware }}.bin
        {%- elif ansible_network_os in ['fortinet.fortios.fortios', 'fortios'] -%}
          fortios-{{ target_firmware }}.out
        {%- elif ansible_network_os in ['metamako.mos', 'mos'] -%}
          mos-{{ target_firmware }}.mos
        {%- elif ansible_network_os | is_platform('opengear') -%}
          opengear-{{ target_firmware }}.dgz
        {%- else -%}
          {{ target_firmware }}
        {%- endif -%}
      {%- endif -%}

- name: Check if firmware image file exists
  ansible.builtin.stat:
    path: "{{ firmware_base_path }}/{{ firmware_filename_for_validation }}"
  register: firmware_file_stat
  delegate_to: localhost
  when: not ansible_check_mode

- name: Verify image file exists
  ansible.builtin.assert:
    that:
      - firmware_file_stat.stat.exists
      - firmware_file_stat.stat.isreg
    fail_msg: >-
      Firmware file {{ firmware_base_path }}/{{ firmware_filename_for_validation }}
      does not exist or
        is not a regular file
    success_msg: >
      "Firmware file found: {{ firmware_base_path }}/{{ firmware_filename_for_validation }}"
  when: not ansible_check_mode

- name: Check minimum file size (prevent empty/corrupt files)
  ansible.builtin.assert:
    that:
      - firmware_file_stat.stat.size > 1048576  # 1MB minimum
    fail_msg: >
      "Firmware file {{ firmware_filename_for_validation }} is too small ({{
        firmware_file_stat.stat.size }} bytes). Minimum 1MB required."
    success_msg: >-
      Firmware file size validation passed:
      {{ (firmware_file_stat.stat.size / 1024 / 1024) |
        round(2) }} MB
  when: not ansible_check_mode

- name: Check file permissions are readable
  ansible.builtin.assert:
    that:
      - firmware_file_stat.stat.readable
    fail_msg: "Firmware file {{ firmware_filename_for_validation }} is not readable"
    success_msg: "Firmware file permissions validation passed"
  when: not ansible_check_mode

- name: Validate file extension for platform
  ansible.builtin.assert:
    that:
      - >
        ((ansible_network_os | is_platform('nxos') or ansible_network_os | is_platform('nxos')) and
          firmware_filename_for_validation.endswith(('.bin', '.nxos'))) or
        ((ansible_network_os | is_platform('ios') or ansible_network_os | is_platform('ios')) and
          firmware_filename_for_validation.endswith(('.bin', '.spa', '.pkg'))) or
        ((ansible_network_os | is_platform('fortios') or ansible_network_os | is_platform('fortios')) and
          firmware_filename_for_validation.endswith('.out')) or
        ((ansible_network_os | is_platform('mos') or ansible_network_os | is_platform('mos')) and
          firmware_filename_for_validation.endswith(('.mos', '.tar.gz'))) or
        (ansible_network_os | is_platform('opengear') and
          firmware_filename_for_validation.endswith(('.dgz', '.bin')))
    fail_msg: >
      "Firmware file extension not valid for platform: >-
          {{ ansible_network_os }}: {{ firmware_filename_for_validation }}"
    success_msg: >
      "Firmware file extension validation passed for {{ ansible_network_os }}"

- name: Set integrity check result
  ansible.builtin.set_fact:
    image_integrity_passed: true
    firmware_file_info:
      path: "{{ firmware_base_path }}/{{ firmware_filename_for_validation }}"
      size_bytes: "{{ firmware_file_stat.stat.size if (firmware_file_stat is defined and firmware_file_stat.stat is defined) else 0 }}"
      size_mb: "{{ ((firmware_file_stat.stat.size / 1024 / 1024) | round(2)) if (firmware_file_stat is defined and firmware_file_stat.stat is defined) else 0 }}"
      modified_time: "{{ firmware_file_stat.stat.mtime if (firmware_file_stat is defined and firmware_file_stat.stat is defined) else 'unknown' }}"
      checksum: "{{ firmware_file_stat.stat.checksum if (firmware_file_stat is defined and firmware_file_stat.stat is defined) else 'unknown' }}"
