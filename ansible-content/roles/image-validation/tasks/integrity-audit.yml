---
# Image integrity audit tasks

- name: Determine firmware filename for validation
  ansible.builtin.set_fact:
    firmware_filename_for_validation: "{{ target_firmware }}"

- name: Check if firmware image file exists
  ansible.builtin.stat:
    path: "{{ firmware_base_path }}/{{ firmware_filename_for_validation }}"
  register: firmware_file_stat
  delegate_to: localhost
  when: not ansible_check_mode

- name: Verify image file exists
  ansible.builtin.assert:
    that:
      - firmware_file_stat.stat.exists
      - firmware_file_stat.stat.isreg
    fail_msg: "Firmware file {{ firmware_base_path }}/{{ firmware_filename_for_validation }} does not exist or is not a regular file"
    success_msg: "Firmware file found: {{ firmware_base_path }}/{{ firmware_filename_for_validation }}"
  when: not ansible_check_mode

- name: Check minimum file size (prevent empty/corrupt files)
  ansible.builtin.assert:
    that:
      - firmware_file_stat.stat.size > 1048576  # 1MB minimum
    fail_msg: "Firmware file {{ firmware_filename_for_validation }} is too small ({{ firmware_file_stat.stat.size }} bytes). Minimum 1MB required."
    success_msg: "Firmware file size validation passed: {{ (firmware_file_stat.stat.size / 1024 / 1024) | round(2) }} MB"
  when: not ansible_check_mode

- name: Check file permissions are readable
  ansible.builtin.assert:
    that:
      - firmware_file_stat.stat.readable
    fail_msg: "Firmware file {{ firmware_filename_for_validation }} is not readable"
    success_msg: "Firmware file permissions validation passed"
  when: not ansible_check_mode

- name: Validate file extension for platform
  ansible.builtin.assert:
    that:
      - >
        (platform == 'nxos' and
          (firmware_filename_for_validation.endswith('.bin') or
           firmware_filename_for_validation.endswith('.img'))) or
        (platform == 'ios' and
          (firmware_filename_for_validation.endswith('.bin') or
           firmware_filename_for_validation.endswith('.SPA.bin'))) or
        (platform == 'fortios' and
          firmware_filename_for_validation.endswith('.out')) or
        (platform ==  and
          (firmware_filename_for_validation.endswith('.iso') or
           firmware_filename_for_validation.endswith('.swix'))) or
        (platform == 'opengear' and
          (firmware_filename_for_validation.endswith('.flash') or
           firmware_filename_for_validation.endswith('.raucb')))
    fail_msg: |
      Firmware file extension not valid for platform {{ platform }}: {{ firmware_filename_for_validation }}
      See docs/firmware-naming-standards.md for MANDATORY naming requirements
    success_msg: "Firmware file extension validation passed for {{ platform }}: {{ firmware_filename_for_validation }}"

- name: Check if EPLD image file exists (if EPLD upgrade enabled)
  ansible.builtin.stat:
    path: "{{ firmware_base_path }}/{{ target_epld_firmware }}"
  register: epld_file_stat
  delegate_to: localhost
  when:
    - enable_epld_upgrade | bool
    - target_epld_firmware is defined
    - not ansible_check_mode

- name: Set integrity check result
  ansible.builtin.set_fact:
    image_integrity_passed: true
    firmware_file_info:
      path: "{{ firmware_base_path }}/{{ firmware_filename_for_validation }}"
      size_bytes: "{{ firmware_file_stat.stat.size if (firmware_file_stat is defined and firmware_file_stat.stat is defined) else 0 }}"
      size_mb: "{{ ((firmware_file_stat.stat.size / 1024 / 1024) | round(2)) if (firmware_file_stat is defined and firmware_file_stat.stat is defined) else 0 }}"
      modified_time: "{{ firmware_file_stat.stat.mtime if (firmware_file_stat is defined and firmware_file_stat.stat is defined) else 'unknown' }}"
      checksum: "{{ firmware_file_stat.stat.checksum if (firmware_file_stat is defined and firmware_file_stat.stat is defined) else 'unknown' }}"
    epld_file_info:
      path: "{{ firmware_base_path }}/{{ target_epld_firmware if (enable_epld_upgrade | bool and target_epld_firmware is defined) else '' }}"
      size_bytes: "{{ epld_file_stat.stat.size if (enable_epld_upgrade | bool and epld_file_stat is defined and epld_file_stat.stat is defined) else 0 }}"
      size_mb: "{{ ((epld_file_stat.stat.size / 1024 / 1024) | round(2)) if (enable_epld_upgrade | bool and epld_file_stat is defined and epld_file_stat.stat is defined) else 0 }}"
      modified_time: "{{ epld_file_stat.stat.mtime if (enable_epld_upgrade | bool and epld_file_stat is defined and epld_file_stat.stat is defined) else 'unknown' }}"
      checksum: "{{ epld_file_stat.stat.checksum if (enable_epld_upgrade | bool and epld_file_stat is defined and epld_file_stat.stat is defined) else 'unknown' }}"
