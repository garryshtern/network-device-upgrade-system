---
# DEPRECATED: This playbook is deprecated and will be removed in a future version.
#
# Please use main-upgrade-workflow.yml with tags instead:
#   ansible-playbook ansible-content/playbooks/main-upgrade-workflow.yml --tags step6 \
#     --extra-vars "target_hosts=mydevice target_firmware=firmware.bin maintenance_window=true max_concurrent=1"
#
# This provides the same functionality with automatic dependency resolution.
#
# Phase 2: Image Installation Playbook
# Maintenance window required - installs and activates firmware
# Includes reboot and service disruption

- name: Phase 2 - Firmware Installation
  hosts: "{{ target_hosts }}"
  gather_facts: false
  vars:
    installation_start_time: "{{ ansible_date_time.iso8601 }}"
    reboot_required: true
    # NOTE: reboot_wait_time and validation_timeout defined in group_vars/all.yml
    max_reboot_wait: "{{ reboot_wait_time }}"  # Use group_vars value
  pre_tasks:
    - name: Verify maintenance window
      ansible.builtin.assert:
        that:
          - maintenance_window | bool
        fail_msg: "Phase 2 installation requires maintenance_window=true"

    - name: Set installation tracking variables
      ansible.builtin.set_fact:
        installation_state:
          phase: "Phase 2 - Installation"
          device: "{{ inventory_hostname }}"
          start_time: "{{ installation_start_time }}"
          current_step: "initialization"
          pre_reboot_complete: false
          reboot_started: false
          post_reboot_complete: false

  tasks:
    # Step 1: Pre-installation validation
    - name: Step 1 - Pre-installation validation
      block:
        - name: Update step tracking
          ansible.builtin.set_fact:
            installation_state: >
              {{ installation_state | combine({
                'current_step': 'pre_installation_validation'
              }) }}

        - name: Verify Phase 1 completion
          ansible.builtin.include_role:
            name: common
            tasks_from: phase-validation
          vars:
            required_phase: "phase_1_complete"

        - name: Gather comprehensive network resources for validation
          ansible.builtin.include_role:
            name: common
            tasks_from: network-resources-gathering

        - name: Validate network convergence
          ansible.builtin.include_role:
            name: network-validation
          vars:
            validation_phase: "pre_installation"

        - name: Final device health check
          ansible.builtin.include_role:
            name: common
            tasks_from: health-check
          vars:
            check_type: "pre_installation"

    # Step 2: Platform-specific installation
    - name: Step 2 - Firmware installation
      block:
        - name: Update step tracking
          ansible.builtin.set_fact:
            installation_state: >
              {{ installation_state | combine({
                'current_step': 'firmware_installation'
              }) }}

        - name: Install firmware - Cisco NX-OS
          ansible.builtin.include_role:
            name: cisco-nxos-upgrade
            tasks_from: image-installation
          when: platform == 'nxos'

        - name: Install firmware - Cisco IOS-XE
          ansible.builtin.include_role:
            name: cisco-iosxe-upgrade
            tasks_from: image-installation
          when: platform == 'ios'

        - name: Install firmware - Metamako MOS
          ansible.builtin.include_role:
            name: metamako-mos-upgrade
            tasks_from: image-installation
          when: platform == 'metamako_mos'

        - name: Install firmware - Opengear
          ansible.builtin.include_role:
            name: opengear-upgrade
            tasks_from: image-installation
          when: platform == 'opengear'

        - name: Install firmware - FortiOS
          ansible.builtin.include_role:
            name: fortios-upgrade
            tasks_from: image-installation
          when: platform == 'fortios'

        - name: Mark pre-reboot tasks complete
          ansible.builtin.set_fact:
            installation_state: >
              {{ installation_state | combine({
                'pre_reboot_complete': true
              }) }}

    # Step 3: Device reboot (if required)
    - name: Step 3 - Device reboot
      block:
        - name: Update step tracking
          ansible.builtin.set_fact:
            installation_state: >
              {{ installation_state | combine({
                'current_step': 'device_reboot',
                'reboot_started': true
              }) }}

        - name: Execute platform-specific reboot
          ansible.builtin.include_role:
            name: "{{ platform }}-upgrade"
            tasks_from: reboot
          when: reboot_required | bool

        - name: Wait for device connectivity after reboot
          ansible.builtin.wait_for_connection:
            timeout: "{{ max_reboot_wait }}"
            delay: 30
          when: reboot_required | bool

        - name: Verify device responsiveness
          ansible.builtin.include_role:
            name: common
            tasks_from: connectivity-check

    # Step 4: Post-installation validation
    - name: Step 4 - Post-installation validation
      block:
        - name: Update step tracking
          ansible.builtin.set_fact:
            installation_state: >
              {{ installation_state | combine({
                'current_step': 'post_installation_validation'
              }) }}

        - name: Verify firmware version
          ansible.builtin.include_role:
            name: image-validation
            tasks_from: version-verification

        - name: Run post-installation health check
          ansible.builtin.include_role:
            name: common
            tasks_from: health-check
          vars:
            check_type: "post_installation"

        - name: Gather comprehensive network resources for validation
          ansible.builtin.include_role:
            name: common
            tasks_from: network-resources-gathering

        - name: Validate network services
          ansible.builtin.include_role:
            name: network-validation
          vars:
            validation_type: "post_installation"

        - name: Mark post-reboot validation complete
          ansible.builtin.set_fact:
            installation_state: >
              {{ installation_state | combine({
                'post_reboot_complete': true
              }) }}

    # Step 5: Installation completion
    - name: Step 5 - Installation completion
      block:
        - name: Update step tracking
          ansible.builtin.set_fact:
            installation_state: >
              {{ installation_state | combine({
                'current_step': 'completion'
              }) }}

        - name: Build installation metrics data
          ansible.builtin.set_fact:
            installation_metric_data:
              device_id: "{{ inventory_hostname }}"
              platform: "{{ platform }}"
              firmware_version: "{{ firmware_version }}"
              status: "success"
              reboot_required: "{{ reboot_required }}"
          when:
            - export_metrics | bool

        - name: Record installation metrics
          ansible.builtin.include_role:
            name: common
            tasks_from: metrics-export
          vars:
            metric_type: "installation_completion"
            metric_data: "{{ installation_metric_data }}"
          when:
            - export_metrics | bool

        - name: Update device inventory
          ansible.builtin.include_role:
            name: common
            tasks_from: inventory-update

  post_tasks:
    - name: Calculate installation duration
      ansible.builtin.set_fact:
        installation_duration: >
          {{
            (ansible_date_time.epoch | int) -
            (installation_start_time | to_datetime('%Y-%m-%dT%H:%M:%SZ') |
             strftime('%s') | int)
          }}

    - name: Display installation summary
      ansible.builtin.debug:
        msg:
          - "=== Installation Complete ==="
          - "Device: {{ inventory_hostname }}"
          - "Platform: {{ platform }}"
          - "Duration: {{ installation_duration }} seconds"
          - "Status: {{ installation_state.current_step }}"
