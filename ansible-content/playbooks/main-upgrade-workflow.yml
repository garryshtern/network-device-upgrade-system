---
# Network Device Upgrade Management System - Master Workflow
# REDESIGNED: Proper workflow sequence with fail-fast validation
#
# Workflow Steps:
# 1. Check connectivity (basic connection test only)
# 2. Version check + verify image availability (local file check)
# 3. Check space (cleanup if needed, then recheck) - AFTER knowing image size
# 4. Ensure image staged (check bootflash, upload if needed) + config backup
# 5. Comprehensive facts gathering + pre-upgrade validation (AFTER image staged)
# 6. Install images and reboot
# 7. Post-upgrade validation + compare (failure triggers optional rollback)
#
# CRITICAL: Steps 1-6 must pass or workflow STOPS
# Step 7 failure triggers optional rollback only
#
# RUNNING INDIVIDUAL STAGES WITH AUTOMATIC DEPENDENCY RESOLUTION:
# Each step automatically includes tags for its prerequisites, so dependencies
# are maintained automatically when you specify a step.
#
# Run full workflow (all steps):
#   ansible-playbook main-upgrade-workflow.yml --extra-vars="target_hosts=mydevice target_firmware=nxos.10.2.3.bin maintenance_window=true max_concurrent=1"
#
# Run individual steps (prerequisites run automatically):
#   --tags step1              # Connectivity check only
#   --tags step2              # Version check + step1 (auto)
#   --tags step3              # Space check + step1,step2 (auto)
#   --tags step4              # Image upload + step1,step2,step3 (auto)
#   --tags step5              # Pre-validation + step1,step2,step3,step4 (auto)
#   --tags step6              # Install + step1,step2,step3,step4,step5 (auto)
#   --tags step7              # Post-validation + step1 (auto, assumes step5/step6 done previously)
#
# Examples with automatic dependencies:
#   --tags step6              # Runs: step1 → step2 → step3 → step4 → step5 → step6
#   --tags step5              # Runs: step1 → step2 → step3 → step4 → step5
#   --tags step3              # Runs: step1 → step2 → step3
#   --tags step7              # Runs: step1 → step7 (requires prior step5 baseline)
#
# Function-specific tags (still include dependencies):
#   --tags connectivity       # step1 only
#   --tags version_check      # step1 + step2
#   --tags space_check        # step1 + step2 + step3
#   --tags image_upload       # step1 + step2 + step3 + step4
#   --tags config_backup      # step1 + step2 + step3 + step4
#   --tags pre_validation     # step1 + step2 + step3 + step4 + step5
#   --tags install            # step1 + step2 + step3 + step4 + step5 + step6
#   --tags reboot             # step1 + step2 + step3 + step4 + step5 + step6
#   --tags post_validation    # step1 + step7
#   --tags network_validation # step1 + step2 + step3 + step4 + step5 + step7
#
# STEP DEPENDENCIES (AUTOMATICALLY RESOLVED):
# Dependencies are maintained automatically via tag inheritance.
# When you run a step, prerequisite steps run automatically.
#
# STEP 1: No prerequisites (can run standalone)
#         Provides: Basic facts (ansible_net_version, current_firmware_image, etc.)
#         Auto-included by: All other steps
#
# STEP 2: Auto-includes: step1
#         Provides: Verification that upgrade is needed and firmware file exists
#         Auto-included by: step3, step4
#         Optional for: step5, step6, step7
#
# STEP 3: Auto-includes: step1, step2
#         Provides: Confirmation of sufficient storage space
#         Auto-included by: step4
#         Optional for: step5, step6, step7
#
# STEP 4: Auto-includes: step1, step2, step3
#         Provides: Firmware staged on device, config backup saved
#         Auto-included by: None
#         Optional for: step5, step6, step7
#
# STEP 5: Auto-includes: step1 only
#         Provides: network_baseline saved to filesystem, pre-validation results
#         Optional: Run step 4 separately before step 6 for config backup
#         Auto-included by: None
#
# STEP 6: Auto-includes: step1 only
#         Provides: Device rebooted with new firmware
#         Optional: Run step 5 before step 6 to establish baseline
#         Auto-included by: None
#
# STEP 7: Auto-includes: step1 only
#         Requires: STEP 5 baseline file from previous run (not auto-included)
#         Provides: Post-upgrade validation, comparison with baseline
#
# COMMON USE CASES:
# Full upgrade:              --tags step6 (auto-runs: step1→step2→step3→step4→step5→step6)
# Safe upgrade (recommended): --tags step5 then --tags step4 then --tags step6 then --tags step7
#   Gathers baseline, backs up config, upgrades, validates against baseline
# Pre-validation only:       --tags step5 (auto-runs: step1 only, gathers baseline)
# Post-validation:           --tags step7 (auto-runs: step1→step7, requires prior step5 baseline)
# Just upload image:         --tags step4 (auto-runs: step1→step2→step3→step4)
# Just check version:        --tags step2 (auto-runs: step1→step2)
# Emergency upgrade:         --tags step6 (auto-runs: step1 only, direct upgrade)
#
# BENEFITS OF AUTO-DEPENDENCY:
# - No need to remember prerequisite chains
# - Safe to run any step - dependencies always satisfied
# - Cleaner command line (just specify what you want)
# - Impossible to skip required prerequisites by accident

- name: Network Device Upgrade - Master Workflow
  hosts: "{{ target_hosts }}"
  gather_facts: false
  serial: "{{ max_concurrent }}"
  vars:
    # Firmware configuration (no local override - use group_vars values)
    firmware_version: "{{ target_firmware }}"
    platform_specific_firmware: "{{ platform_firmware }}"

    # Note: SSH authentication credentials are configured in group_vars/all.yml
    # based on platform-specific vault variables (vault_cisco_nxos_ssh_key, etc.)
    # DO NOT override ansible_ssh_private_key_file or ansible_password here

    # Batch tracking
    batch_id: "{{ ansible_play_batch | hash('md5') }}"
    operator_id: "{{ lookup('env', 'USER')  }}"

    # NOTE: Timeouts and retries are defined in group_vars/all.yml:
    #   connectivity_timeout, reboot_wait_time, max_retry_attempts

  pre_tasks:
    - name: Initialize ansible_date_time if facts not gathered
      ansible.builtin.set_fact:
        ansible_date_time:
          iso8601: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
          epoch: "{{ lookup('pipe', 'date +%s') }}"
      when: ansible_date_time is not defined

    - name: Override connection for Metamako in check mode
      ansible.builtin.set_fact:
        ansible_connection: local
      when:
        - ansible_check_mode is defined
        - ansible_check_mode
        - ansible_network_os | is_platform('metamako')

    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - target_firmware is defined
          - target_hosts is defined
        fail_msg: "Required variables missing. target_firmware and target_hosts must be defined."

    - name: Set firmware version for workflow
      ansible.builtin.set_fact:
        firmware_version: "{{ target_firmware }}"

    - name: Set upgrade start timestamp
      ansible.builtin.set_fact:
        upgrade_start_time: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
        upgrade_job_id: "{{ inventory_hostname }}_{{ ansible_play_batch | hash('md5') }}"

    - name: Validate maintenance window requirement
      ansible.builtin.assert:
        that:
          - maintenance_window | bool
        fail_msg: "Firmware upgrades require maintenance_window=true"
      when: not ansible_check_mode

    - name: Display upgrade parameters
      ansible.builtin.debug:
        msg:
          - "=== Network Device Upgrade Workflow ==="
          - "Target Device: {{ inventory_hostname }}"
          - "Target Firmware: {{ firmware_version }}"
          - "Maintenance Window: {{ maintenance_window }}"
          - "Batch ID: {{ batch_id }}"
          - "Job ID: {{ upgrade_job_id }}"
          - "======================================="

  tasks:
    # STEP 1: Basic Connectivity Check
    # Gather basic facts to verify connectivity and get device info
    # MUST PASS or workflow STOPS
    - name: "STEP 1: Basic Connectivity Check"
      tags:
        - step1
        - connectivity
      block:
        - name: Execute STEP 1 tasks
          ansible.builtin.include_tasks:
            file: steps/step-1-connectivity.yml

      rescue:
        - name: Connectivity check failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 1 FAILED: Cannot connect to device {{ inventory_hostname }}. Workflow stopped."

    # STEP 2: Version Check and Image Verification
    # Check if upgrade needed and verify local image file exists
    # MUST PASS or workflow STOPS
    # AUTO-DEPENDENCY: Requires step1
    - name: "STEP 2: Version Check and Image Verification"
      tags:
        - step2
        - version_check
      when:
        - not ansible_check_mode or inventory_hostname != 'localhost'
      block:
        - name: Execute STEP 2 tasks (includes STEP 1)
          ansible.builtin.include_tasks:
            file: steps/step-2-version-check.yml

      rescue:
        - name: Version check or image verification failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 2 FAILED: Version check or image verification failed. Workflow stopped."

    # STEP 3: Check Space (Cleanup if Needed)
    # Only runs cleanup if insufficient space detected
    # Runs AFTER image verification so we know the image size
    # MUST PASS or workflow STOPS
    # AUTO-DEPENDENCY: Requires step1, step2
    - name: "STEP 3: Storage Space Validation"
      tags:
        - step3
        - space_check
      block:
        - name: Execute STEP 3 tasks (includes STEP 1-2)
          ansible.builtin.include_tasks:
            file: steps/step-3-space-check.yml

      rescue:
        - name: Storage validation failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 3 FAILED: Storage space validation failed. Workflow stopped."

    # STEP 4: Upload Images and Config Backup
    # Server-initiated PUSH only (no device-initiated pulls)
    # MUST PASS or workflow STOPS
    # AUTO-DEPENDENCY: Requires step1, step2, step3
    - name: "STEP 4: Image Upload and Config Backup"
      tags:
        - step4
        - image_upload
        - config_backup
      when:
        - not ansible_check_mode or inventory_hostname != 'localhost'
      block:
        - name: Execute STEP 4 tasks (includes STEP 1-3)
          ansible.builtin.include_tasks:
            file: steps/step-4-image-upload.yml

      rescue:
        - name: Image upload failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 4 FAILED: Image upload or config backup failed. Workflow stopped."

    # STEP 5: Comprehensive Network Resources Gathering and Pre-Upgrade Validation
    # Network resources gathered AFTER image is confirmed staged (not before)
    # Comprehensive validation: BGP, interfaces, routing, etc.
    # MUST PASS or workflow STOPS
    # AUTO-DEPENDENCY: Requires step1, step4 (step2/step3 implied by step4)
    - name: "STEP 5: Network Resources Gathering and Pre-Upgrade Validation"
      tags:
        - step5
        - pre_validation
        - network_validation
      when:
        - not ansible_check_mode or inventory_hostname != 'localhost'
      block:
        - name: Execute STEP 5 tasks (includes STEP 1-4)
          ansible.builtin.include_tasks:
            file: steps/step-5-pre-validation.yml

      rescue:
        - name: Pre-upgrade validation failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 5 FAILED: Network resources gathering or pre-upgrade validation failed. Workflow stopped."

    # STEP 6: Install Images and Reboot
    # Platform-specific installation
    # MUST PASS or workflow STOPS
    # AUTO-DEPENDENCY: Requires step1, step4, step5 (step2/step3 implied by step4)
    - name: "STEP 6: Firmware Installation"
      tags:
        - step6
        - install
        - reboot
      when:
        - not ansible_check_mode or inventory_hostname != 'localhost'
      block:
        - name: Execute STEP 6 tasks (includes STEP 1-5)
          ansible.builtin.include_tasks:
            file: steps/step-6-installation.yml

      rescue:
        - name: Installation failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 6 FAILED: Installation failed. Workflow stopped."

    # STEP 7: Post-Checks and Comparison
    # Compare to pre-upgrade state
    # Failure triggers OPTIONAL rollback (does not stop workflow)
    # AUTO-DEPENDENCY: Requires step1 (step5 baseline from previous run, step6 upgrade done)
    # NOTE: step5 baseline must exist from a prior run, step6 should have been run
    - name: "STEP 7: Post-Upgrade Validation"
      tags:
        - step7
        - post_validation
      when:
        - not ansible_check_mode or inventory_hostname != 'localhost'
      block:
        - name: Execute STEP 7 tasks (includes STEP 1 only)
          ansible.builtin.include_tasks:
            file: steps/step-7-post-validation.yml

      rescue:
        - name: Post-validation failed - trigger optional rollback
          block:
            - name: Execute rollback procedure
              ansible.builtin.include_role:
                name: common
                tasks_from: emergency-rollback
              when: rollback_on_failure | bool

            - name: Log post-validation failure
              ansible.builtin.debug:
                msg:
                  - "WARNING: Post-upgrade validation failed."
                  - "Rollback {{ 'executed' if rollback_on_failure else 'skipped (disabled)' }}."

          always:
            - name: Mark upgrade with validation warnings
              ansible.builtin.set_fact:
                upgrade_completed_with_warnings: true

  post_tasks:
    - name: Set upgrade completion timestamp
      ansible.builtin.set_fact:
        upgrade_end_time: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"

    - name: Calculate upgrade duration
      ansible.builtin.set_fact:
        upgrade_duration: >
          {{
            ((upgrade_end_time | to_datetime('%Y-%m-%dT%H:%M:%SZ')) -
            (upgrade_start_time | to_datetime('%Y-%m-%dT%H:%M:%SZ'))).total_seconds()
          }}

    - name: Export final metrics
      ansible.builtin.include_role:
        name: common
        tasks_from: metrics-export
      vars:
        metric_type: "upgrade_summary"
        metric_data:
          device_id: "{{ inventory_hostname }}"
          platform: "{{ platform }}"
          duration_seconds: "{{ upgrade_duration }}"
          final_status: >
            {{
              'success' if ansible_failed_result is not defined
              else ('warning' if upgrade_completed_with_warnings is defined else 'failed')
            }}
      when:
        - export_metrics | bool

    - name: Display upgrade summary
      ansible.builtin.debug:
        msg:
          - "=== Upgrade Summary ==="
          - "Device: {{ inventory_hostname }}"
          - "Job ID: {{ upgrade_job_id }}"
          - "Duration: {{ upgrade_duration }}s"
          - >
            Status: {{
              'SUCCESS' if ansible_failed_result is not defined
              else ('WARNING' if upgrade_completed_with_warnings is defined else 'FAILED')
            }}
          - "Start: {{ upgrade_start_time }}"
          - "End: {{ upgrade_end_time }}"
          - "======================="
