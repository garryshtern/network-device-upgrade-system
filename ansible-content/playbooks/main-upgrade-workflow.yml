---
# Network Device Upgrade Management System - Master Workflow
# REDESIGNED: Proper workflow sequence with fail-fast validation
#
# Workflow Steps:
# 1. Check connectivity (basic connection test only)
# 2. Check space (cleanup if needed, then recheck)
# 3. Version check + ensure image staged (check bootflash, upload if needed) + config backup
# 4. Comprehensive facts gathering + pre-upgrade validation (AFTER image staged)
# 5. Install images and reboot
# 6. Post-upgrade validation + compare (failure triggers optional rollback)
#
# CRITICAL: Steps 1-5 must pass or workflow STOPS
# Step 6 failure triggers optional rollback only

- name: Network Device Upgrade - Master Workflow
  hosts: "{{ target_hosts }}"
  gather_facts: false
  serial: "{{ max_concurrent }}"
  vars:
    # Firmware configuration (no local override - use group_vars values)
    firmware_version: "{{ target_firmware }}"
    platform_specific_firmware: "{{ platform_firmware }}"

    # Security - SSH keys preferred over passwords
    ansible_ssh_private_key_file: "{{ ssh_key_file | default(omit) }}"
    ansible_ssh_pass: "{{ ssh_password | default(omit) }}"

    # Batch tracking
    batch_id: "{{ ansible_play_batch | hash('md5') }}"
    operator_id: "{{ lookup('env', 'USER')  }}"

    # NOTE: Timeouts and retries are defined in group_vars/all.yml:
    #   connectivity_timeout, reboot_wait_time, max_retry_attempts

  pre_tasks:
    - name: Initialize ansible_date_time if facts not gathered
      ansible.builtin.set_fact:
        ansible_date_time:
          iso8601: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
          epoch: "{{ lookup('pipe', 'date +%s') }}"
      when: ansible_date_time is not defined

    - name: Override connection for Metamako in check mode
      ansible.builtin.set_fact:
        ansible_connection: local
      when:
        - ansible_check_mode is defined
        - ansible_check_mode
        - ansible_network_os | is_platform('metamako')

    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - target_firmware is defined
          - target_hosts is defined
        fail_msg: "Required variables missing. target_firmware and target_hosts must be defined."

    - name: Set firmware version for workflow
      ansible.builtin.set_fact:
        firmware_version: "{{ target_firmware }}"
        target_firmware_version: "{{ target_firmware }}"

    - name: Set upgrade start timestamp
      ansible.builtin.set_fact:
        upgrade_start_time: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
        upgrade_job_id: "{{ inventory_hostname }}_{{ ansible_play_batch | hash('md5') }}"

    - name: Validate maintenance window requirement
      ansible.builtin.assert:
        that:
          - maintenance_window | bool
        fail_msg: "Firmware upgrades require maintenance_window=true"
      when: not ansible_check_mode

    - name: Display upgrade parameters
      ansible.builtin.debug:
        msg:
          - "=== Network Device Upgrade Workflow ==="
          - "Target Device: {{ inventory_hostname }}"
          - "Target Firmware: {{ firmware_version }}"
          - "Maintenance Window: {{ maintenance_window }}"
          - "Batch ID: {{ batch_id }}"
          - "Job ID: {{ upgrade_job_id }}"
          - "======================================="

  tasks:
    # STEP 1: Basic Connectivity Check
    # Simple connection test - comprehensive facts gathered in STEP 4 (after image staged)
    # MUST PASS or workflow STOPS
    - name: "STEP 1: Basic Connectivity Check"
      block:
        - name: Test basic device connectivity
          ansible.builtin.wait_for_connection:
            timeout: "{{ connectivity_timeout }}"

        - name: Connectivity confirmed
          ansible.builtin.debug:
            msg:
              - "=========================================="
              - "CONNECTIVITY ESTABLISHED"
              - "=========================================="
              - "Device: {{ inventory_hostname }}"
              - "Platform: {{ platform }}"
              - "Status: Connected successfully"
              - "Note: Comprehensive facts will be gathered after image staging"
              - "=========================================="

      rescue:
        - name: Connectivity check failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 1 FAILED: Cannot connect to device {{ inventory_hostname }}. Workflow stopped."

    # STEP 2: Check Space (Cleanup if Needed)
    # Only runs cleanup if insufficient space detected
    # MUST PASS or workflow STOPS
    - name: "STEP 2: Storage Space Validation"
      block:
        - name: Storage assessment with automatic cleanup if needed
          ansible.builtin.include_role:
            name: space-management
            tasks_from: storage-assessment
          vars:
            minimum_free_space_gb: "{{ required_space_gb }}"

        - name: Verify sufficient space available
          ansible.builtin.assert:
            that:
              - storage_info is defined
              - storage_info.free_space_gb >= (required_space_gb | float)
            fail_msg: >
              Insufficient storage space. Available: {{ storage_info.free_space_gb }}GB,
              Required: {{ required_space_gb }}GB
          when:
            - not ansible_check_mode or inventory_hostname != 'localhost'

      rescue:
        - name: Storage validation failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 2 FAILED: Storage space validation failed. Workflow stopped."

    # STEP 3: Upload Images
    # Server-initiated PUSH only (no device-initiated pulls)
    # MUST PASS or workflow STOPS
    - name: "STEP 3: Version Check and Image Upload"
      when:
        - not ansible_check_mode or inventory_hostname != 'localhost'
      block:
        - name: Check current running version
          ansible.builtin.include_role:
            name: image-validation
            tasks_from: version-verification

        - name: Compare current version to target version
          ansible.builtin.set_fact:
            already_running_target_version: "{{ current_firmware_version == target_firmware }}"

        - name: Report if already running target version
          ansible.builtin.debug:
            msg:
              - "=========================================="
              - "ALREADY RUNNING TARGET VERSION"
              - "=========================================="
              - "Device: {{ inventory_hostname }}"
              - "Current Version: {{ current_firmware_version }}"
              - "Target Version: {{ target_firmware }}"
              - "Status: NO UPGRADE NEEDED"
              - "Action: Skipping upgrade for this device"
              - "=========================================="
          when: already_running_target_version | bool

        - name: End upgrade for this host if already running target version
          ansible.builtin.meta: end_host
          when: already_running_target_version | bool

        - name: Report upgrade needed
          ansible.builtin.debug:
            msg:
              - "=========================================="
              - "UPGRADE REQUIRED"
              - "=========================================="
              - "Device: {{ inventory_hostname }}"
              - "Current Version: {{ current_firmware_version }}"
              - "Target Version: {{ target_firmware }}"
              - "Status: PROCEEDING WITH UPGRADE"
              - "=========================================="
          when: not already_running_target_version | bool

        - name: Verify firmware image availability (local file check)
          ansible.builtin.include_role:
            name: image-validation
            tasks_from: integrity-audit

        - name: Ensure firmware image on device (check bootflash + upload if needed)
          ansible.builtin.include_role:
            name: common
            tasks_from: image-loading

        - name: Verify uploaded image integrity
          ansible.builtin.include_role:
            name: image-validation
            tasks_from: hash-verification

        - name: Backup current configuration (after confirming image is staged)
          ansible.builtin.include_role:
            name: common
            tasks_from: config-backup

      rescue:
        - name: Image upload failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 3 FAILED: Image upload or version check failed. Workflow stopped."

    # STEP 4: Comprehensive Facts Gathering and Pre-Upgrade Validation
    # Facts gathering happens AFTER image is confirmed staged (not before)
    # Comprehensive validation: BGP, interfaces, routing, etc.
    # MUST PASS or workflow STOPS
    - name: "STEP 4: Facts Gathering and Pre-Upgrade Validation"
      when:
        - not ansible_check_mode or inventory_hostname != 'localhost'
      block:
        - name: Gather comprehensive device facts (after confirming image staged)
          ansible.builtin.include_role:
            name: common
            tasks_from: connectivity-check

        - name: Capture pre-upgrade network state
          ansible.builtin.include_role:
            name: network-validation
          vars:
            validation_phase: "pre_upgrade"
            save_baseline: true

        - name: Verify all critical services are operational
          ansible.builtin.assert:
            that:
              - network_validation_results is defined
              - network_validation_results.overall_status == "healthy"
            fail_msg: "Pre-upgrade validation failed. Network not in healthy state."

      rescue:
        - name: Pre-upgrade validation failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 4 FAILED: Facts gathering or pre-upgrade validation failed. Workflow stopped."

    # STEP 5: Install Images and Reboot
    # Platform-specific installation
    # MUST PASS or workflow STOPS
    - name: "STEP 5: Firmware Installation"
      when:
        - not ansible_check_mode or inventory_hostname != 'localhost'
      block:
        - name: Install firmware (platform-specific)
          ansible.builtin.include_role:
            name: "{{ platform_role_map[platform] }}"
            tasks_from: image-installation
          when:
            - platform is defined
            - platform in platform_role_map

        - name: Wait for device to come back online
          ansible.builtin.wait_for_connection:
            timeout: "{{ connectivity_timeout }}"
            delay: 30

      rescue:
        - name: Installation failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 5 FAILED: Installation failed. Workflow stopped."

    # STEP 6: Post-Checks and Comparison
    # Compare to pre-upgrade state
    # Failure triggers OPTIONAL rollback (does not stop workflow)
    - name: "STEP 6: Post-Upgrade Validation"
      when:
        - not ansible_check_mode or inventory_hostname != 'localhost'
      block:
        - name: Capture post-upgrade network state
          ansible.builtin.include_role:
            name: network-validation
          vars:
            validation_phase: "post_upgrade"
            compare_to_baseline: true

        - name: Compare pre/post upgrade states
          ansible.builtin.assert:
            that:
              - network_validation_results is defined
              - network_validation_results.comparison_status == "passed"
            fail_msg: "Post-upgrade validation shows degradation from baseline."

      rescue:
        - name: Post-validation failed - trigger optional rollback
          block:
            - name: Execute rollback procedure
              ansible.builtin.include_role:
                name: common
                tasks_from: emergency-rollback
              when: rollback_on_failure | bool

            - name: Log post-validation failure
              ansible.builtin.debug:
                msg: >
                  WARNING: Post-upgrade validation failed.
                  Rollback {{ 'executed' if rollback_on_failure else 'skipped (disabled)' }}.

          always:
            - name: Mark upgrade with validation warnings
              ansible.builtin.set_fact:
                upgrade_completed_with_warnings: true

  post_tasks:
    - name: Set upgrade completion timestamp
      ansible.builtin.set_fact:
        upgrade_end_time: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"

    - name: Calculate upgrade duration
      ansible.builtin.set_fact:
        upgrade_duration: >
          {{
            ((upgrade_end_time | to_datetime('%Y-%m-%dT%H:%M:%SZ')) -
            (upgrade_start_time | to_datetime('%Y-%m-%dT%H:%M:%SZ'))).total_seconds()
          }}

    - name: Export final metrics
      ansible.builtin.include_role:
        name: common
        tasks_from: metrics-export
      vars:
        metric_type: "upgrade_summary"
        duration_seconds: "{{ upgrade_duration }}"
        final_status: >
          {{
            'success' if ansible_failed_result is not defined
            else ('warning' if upgrade_completed_with_warnings is defined else 'failed')
          }}

    - name: Display upgrade summary
      ansible.builtin.debug:
        msg:
          - "=== Upgrade Summary ==="
          - "Device: {{ inventory_hostname }}"
          - "Job ID: {{ upgrade_job_id }}"
          - "Duration: {{ upgrade_duration }}s"
          - >
            Status: {{
              'SUCCESS' if ansible_failed_result is not defined
              else ('WARNING' if upgrade_completed_with_warnings is defined else 'FAILED')
            }}
          - "Start: {{ upgrade_start_time }}"
          - "End: {{ upgrade_end_time }}"
          - "======================="
