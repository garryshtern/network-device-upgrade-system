---
# Network Device Upgrade Management System - Master Workflow
#
# DOCUMENTATION: See docs/workflow-steps-guide.md for detailed step-by-step guide
#
# 8 Independent Steps (can be run individually or combined):
#   Step 1: Connectivity check
#   Step 2: Version check (verify firmware file exists)
#   Step 3: Space check (verify disk space, auto-cleanup)
#   Step 4: Upload firmware + backup config
#   Step 5: Pre-upgrade validation (creates baseline)
#   Step 6: Install firmware + reboot (requires maintenance_window=true)
#   Step 7: Post-upgrade validation (compare to step 5 baseline)
#   Step 8: Emergency rollback (restore previous firmware/config)
#
# Quick Examples:
#   ansible-playbook main-upgrade-workflow.yml --tags step1 -e target_hosts=mydevice -e max_concurrent=5
#   ansible-playbook main-upgrade-workflow.yml --tags step5 -e target_hosts=mydevice -e max_concurrent=5
#   ansible-playbook main-upgrade-workflow.yml --tags step6 -e target_hosts=mydevice -e target_firmware=fw.bin -e max_concurrent=5 -e maintenance_window=true
#   ansible-playbook main-upgrade-workflow.yml --tags step7 -e target_hosts=mydevice -e max_concurrent=5
#   ansible-playbook main-upgrade-workflow.yml --tags step8 -e target_hosts=mydevice -e max_concurrent=5
#
# Safe Workflow (Recommended):
#   1. Run step 5: Establish baseline
#   2. Run step 4: Upload firmware and backup config
#   3. Run step 6: Install firmware (during maintenance window)
#   4. Run step 7: Validate against baseline
#
# See docs/workflow-steps-guide.md for complete documentation

- name: Network Device Upgrade - Master Workflow
  hosts: "{{ target_hosts }}"
  gather_facts: false
  serial: "{{ max_concurrent }}"
  vars:
    # Firmware configuration (no local override - use group_vars values)
    firmware_version: "{{ target_firmware }}"
    platform_specific_firmware: "{{ platform_firmware }}"

    # Note: SSH authentication credentials are configured in group_vars/all.yml
    # based on platform-specific vault variables (vault_cisco_nxos_ssh_key, etc.)
    # DO NOT override ansible_ssh_private_key_file or ansible_password here

    # Batch tracking
    batch_id: "{{ ansible_play_batch | hash('md5') }}"
    operator_id: "{{ lookup('env', 'USER')  }}"

    # NOTE: Timeouts and retries are defined in group_vars/all.yml:
    #   connectivity_timeout, reboot_wait_time, max_retry_attempts

  pre_tasks:
    - name: Initialize ansible_date_time if facts not gathered
      ansible.builtin.set_fact:
        ansible_date_time:
          iso8601: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
          epoch: "{{ lookup('pipe', 'date +%s') }}"
      when: ansible_date_time is not defined

    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - target_firmware is defined
          - target_hosts is defined
        fail_msg: "Required variables missing. target_firmware and target_hosts must be defined."

    - name: Set firmware version for workflow
      ansible.builtin.set_fact:
        firmware_version: "{{ target_firmware }}"

    - name: Set upgrade start timestamp
      ansible.builtin.set_fact:
        upgrade_start_time: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"
        upgrade_job_id: "{{ inventory_hostname }}_{{ ansible_play_batch | hash('md5') }}"

    - name: Validate maintenance window requirement
      ansible.builtin.assert:
        that:
          - maintenance_window | bool
        fail_msg: "Firmware upgrades require maintenance_window=true"
      when: not ansible_check_mode

    - name: Display upgrade parameters
      ansible.builtin.debug:
        msg:
          - "=== Network Device Upgrade Workflow ==="
          - "Target Device: {{ inventory_hostname }}"
          - "Target Firmware: {{ firmware_version }}"
          - "Maintenance Window: {{ maintenance_window }}"
          - "Batch ID: {{ batch_id }}"
          - "Job ID: {{ upgrade_job_id }}"
          - "======================================="

  tasks:
    # STEP 1: Basic Connectivity Check
    # Gather basic facts to verify connectivity and get device info
    # MUST PASS or workflow STOPS
    # AUTO-DEPENDENCY: Required by all steps (step1-8)
    - name: "STEP 1: Basic Connectivity Check"
      tags:
        - step1
        - step2
        - step3
        - step4
        - step5
        - step6
        - step7
        - step8
        - connectivity
      block:
        - name: Execute STEP 1 tasks
          ansible.builtin.include_tasks:
            file: steps/step-1-connectivity.yml

      rescue:
        - name: Connectivity check failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 1 FAILED: Cannot connect to device {{ inventory_hostname }}. Workflow stopped."

    # STEP 2: Version Check and Image Verification
    # Check if upgrade needed and verify local image file exists
    # MUST PASS or workflow STOPS
    # AUTO-DEPENDENCY: Requires step1; provides calculated_hash for STEP 4
    - name: "STEP 2: Version Check and Image Verification"
      tags:
        - step2
        - step3
        - step4
        - step5
        - step6
        - step7
        - step8
        - version_check
        - image_check
      when:
        - not ansible_check_mode or inventory_hostname != 'localhost'
      block:
        - name: Execute STEP 2 tasks (includes STEP 1)
          ansible.builtin.include_tasks:
            file: steps/step-2-version-check.yml

      rescue:
        - name: Version check or image verification failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 2 FAILED: Version check or image verification failed. Workflow stopped."

    # STEP 3: Check Space (Cleanup if Needed)
    # Only runs cleanup if insufficient space detected
    # Runs AFTER image verification so we know the image size
    # MUST PASS or workflow STOPS
    # AUTO-DEPENDENCY: Requires step1, step2; provides storage_info for STEP 5
    # NOTE: STEP 4 does NOT require STEP 3 (skipped for --tags step4)
    - name: "STEP 3: Storage Space Validation"
      tags:
        - step3
        - step5
        - step6
        - step7
        - step8
        - space_check
      block:
        - name: Execute STEP 3 tasks
          ansible.builtin.include_tasks:
            file: steps/step-3-space-check.yml

      rescue:
        - name: Storage validation failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 3 FAILED: Storage space validation failed. Workflow stopped."

    # STEP 4: Upload Images and Config Backup
    # Server-initiated PUSH only (no device-initiated pulls)
    # MUST PASS or workflow STOPS
    # AUTO-DEPENDENCY: Requires step1, step2 (for calculated_hash); NOT step3
    # NOTE: Does NOT require STEP 3 (space check optional before upload)
    - name: "STEP 4: Image Upload and Config Backup"
      tags:
        - step4
        - image_upload
      when:
        - not ansible_check_mode or inventory_hostname != 'localhost'
      block:
        - name: Execute STEP 4 tasks
          ansible.builtin.include_tasks:
            file: steps/step-4-image-upload.yml

      rescue:
        - name: Image upload failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 4 FAILED: Image upload or config backup failed. Workflow stopped."

    # STEP 5: Comprehensive Network Resources Gathering and Pre-Upgrade Validation
    # Network resources gathered AFTER image is confirmed staged (not before)
    # Comprehensive validation: BGP, interfaces, routing, etc.
    # MUST PASS or workflow STOPS
    # AUTO-DEPENDENCY: Requires step1, step2, step3, step4; creates baseline file for STEP 7
    - name: "STEP 5: Network Resources Gathering and Pre-Upgrade Validation"
      tags:
        - step5
        - pre_check
        - config_backup
      when:
        - not ansible_check_mode or inventory_hostname != 'localhost'
      block:
        - name: Execute STEP 5 tasks
          ansible.builtin.include_tasks:
            file: steps/step-5-pre-validation.yml

      rescue:
        - name: Pre-upgrade validation failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 5 FAILED: Network resources gathering or pre-upgrade validation failed. Workflow stopped."

    # STEP 6: Install Images and Reboot
    # Platform-specific installation
    # MUST PASS or workflow STOPS
    # AUTO-DEPENDENCY: Requires step1, step2, step3, step4, step5
    - name: "STEP 6: Firmware Installation"
      tags:
        - step6
        - install
      when:
        - not ansible_check_mode or inventory_hostname != 'localhost'
      block:
        - name: Execute STEP 6 tasks
          ansible.builtin.include_tasks:
            file: steps/step-6-installation.yml

      rescue:
        - name: Installation failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 6 FAILED: Installation failed. Workflow stopped."

    # STEP 7: Post-Checks and Comparison
    # Compare to pre-upgrade state
    # Failure does NOT trigger automatic rollback (use STEP 8 for rollback)
    # AUTO-DEPENDENCY: Requires step1 ONLY (step5 baseline from previous run, step6 upgrade done)
    # NOTE: step5 baseline MUST exist from a prior execution; step6 MUST have completed before running step7
    # WARNING: Running step7 without prior step5 execution will FAIL with missing baseline file
    - name: "STEP 7: Post-Upgrade Validation"
      tags:
        - step7
        - post_check
      when:
        - not ansible_check_mode or inventory_hostname != 'localhost'
      block:
        - name: Execute STEP 7 tasks
          ansible.builtin.include_tasks:
            file: steps/step-7-post-validation.yml

      rescue:
        - name: Post-validation failed - rollback available via STEP 8
          block:
            - name: Log post-validation failure
              ansible.builtin.debug:
                msg:
                  - "WARNING: Post-upgrade validation failed."
                  - "To rollback, run: --tags step8 or --tags rollback"

          always:
            - name: Mark upgrade with validation warnings
              ansible.builtin.set_fact:
                upgrade_completed_with_warnings: true

    # STEP 8: Emergency Rollback
    # Restores device to previous firmware and configuration
    # Triggered only when explicitly invoked via --tags step8 or --tags rollback
    # AUTO-DEPENDENCY: Requires step1 ONLY
    # NOTE: Can be run standalone or after STEP 7 failure; backed-up config from STEP 4 used
    - name: "STEP 8: Emergency Rollback"
      tags:
        - step8
        - rollback
      when:
        - not ansible_check_mode or inventory_hostname != 'localhost'
      block:
        - name: Execute STEP 8 tasks
          ansible.builtin.include_tasks:
            file: steps/step-8-emergency-rollback.yml

      rescue:
        - name: Emergency rollback failed - STOP workflow
          ansible.builtin.fail:
            msg: "STEP 8 FAILED: Emergency rollback failed. Manual intervention required."

  post_tasks:
    - name: Set upgrade completion timestamp
      ansible.builtin.set_fact:
        upgrade_end_time: "{{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}"

    - name: Calculate upgrade duration
      ansible.builtin.set_fact:
        upgrade_duration: >
          {{
            ((upgrade_end_time | to_datetime('%Y-%m-%dT%H:%M:%SZ')) -
            (upgrade_start_time | to_datetime('%Y-%m-%dT%H:%M:%SZ'))).total_seconds()
          }}

    - name: Export final metrics
      ansible.builtin.include_role:
        name: common
        tasks_from: metrics-export
      vars:
        metric_type: "upgrade_summary"
        metric_data:
          device_id: "{{ inventory_hostname }}"
          platform: "{{ platform }}"
          duration_seconds: "{{ upgrade_duration }}"
          final_status: >
            {{
              'success' if ansible_failed_result is not defined
              else ('warning' if upgrade_completed_with_warnings is defined else 'failed')
            }}
      when:
        - export_metrics | bool

    - name: Display upgrade summary
      ansible.builtin.debug:
        msg:
          - "=== Upgrade Summary ==="
          - "Device: {{ inventory_hostname }}"
          - "Job ID: {{ upgrade_job_id }}"
          - "Duration: {{ upgrade_duration }}s"
          - >
            Status: {{
              'SUCCESS' if ansible_failed_result is not defined
              else ('WARNING' if upgrade_completed_with_warnings is defined else 'FAILED')
            }}
          - "Start: {{ upgrade_start_time }}"
          - "End: {{ upgrade_end_time }}"
          - "======================="
