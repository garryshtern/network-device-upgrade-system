---
# STEP 3: Storage Space Validation
# Only runs cleanup if insufficient space detected
# Runs AFTER image verification so we know the image size
# MUST PASS or workflow STOPS
# Dependencies: STEP 1, STEP 2 (automatically included)

- name: Include STEP 2 as prerequisite (includes STEP 1)
  ansible.builtin.include_tasks:
    file: step-2-version-check.yml

- name: Storage assessment with automatic cleanup if needed
  ansible.builtin.include_role:
    name: space-management
    tasks_from: storage-assessment
  vars:
    minimum_free_space_gb: "{{ required_space_gb }}"

- name: Verify sufficient space available
  ansible.builtin.assert:
    that:
      - storage_info is defined
      - (storage_info.free_space_gb | float) >= (required_space_gb | float)
    fail_msg:
      - "Insufficient storage space."
      - "Available: {{ storage_info.free_space_gb }}GB, Required: {{ required_space_gb }}GB"
  when:
    - not ansible_check_mode or inventory_hostname != 'localhost'
