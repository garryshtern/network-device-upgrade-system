---
# STEP 7: Post-Upgrade Validation
# Compare to pre-upgrade state
# Failure triggers OPTIONAL rollback (does not stop workflow)
# Dependencies: STEP 1 (managed by main workflow tags)
# NOTE: STEP 5 baseline must exist from prior run, STEP 6 should have been run

- name: Check if baseline file exists
  ansible.builtin.stat:
    path: "{{ baseline_base_path }}/{{ inventory_hostname }}_network_baseline.json"
  register: baseline_file
  delegate_to: localhost
  changed_when: false

- name: Fail immediately if baseline missing
  ansible.builtin.fail:
    msg:
      - "CRITICAL: Pre-upgrade baseline file missing for post-upgrade validation."
      - ""
      - "Post-upgrade validation REQUIRES a baseline from step 5 (pre-upgrade gathering)."
      - ""
      - "Baseline path: {{ baseline_base_path }}/{{ inventory_hostname }}_network_baseline.json"
      - "File found: {{ baseline_file.stat.exists }}"
      - ""
      - "You must run step 5 BEFORE step 6 and step 7."
      - ""
      - "Correct workflow sequence:"
      - "1. Run step 5: ansible-playbook main-upgrade-workflow.yml --tags step5 -e target_hosts=mydevice -e target_firmware=fw.bin -e max_concurrent=5"
      - "2. Run step 6: ansible-playbook main-upgrade-workflow.yml --tags step6 -e target_hosts=mydevice -e target_firmware=fw.bin -e max_concurrent=5 -e maintenance_window=true"
      - "3. Run step 7: ansible-playbook main-upgrade-workflow.yml --tags step7 -e target_hosts=mydevice -e max_concurrent=5"
  when: not baseline_file.stat.exists

- name: Display STEP 7 entry
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "STEP 7: POST-UPGRADE VALIDATION"
      - "=========================================="
      - "Device: {{ inventory_hostname }}"
      - "Platform: {{ platform }}"
      - "About to gather post-upgrade network resources..."
      - "=========================================="

- name: Gather comprehensive network resources for post-upgrade validation
  ansible.builtin.include_role:
    name: common
    tasks_from: network-resources-gathering
  vars:
    validation_phase: "post_upgrade"

- name: Display network resources gathering completion
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "POST-UPGRADE RESOURCES GATHERED - PROCEEDING TO VALIDATION"
      - "=========================================="

- name: Capture post-upgrade network state
  ansible.builtin.include_role:
    name: network-validation
  vars:
    validation_phase: "post_upgrade"
    compare_to_baseline: true

- name: Save collection validation results to file
  ansible.builtin.copy:
    content: "{{ validation_collection_results | to_nice_json }}"
    dest: "{{ baseline_base_path }}/{{ inventory_hostname }}_post_check_collection.json"
    mode: '0644'
  delegate_to: localhost
  changed_when: false

- name: Save comparison validation results to file
  ansible.builtin.copy:
    content: "{{ validation_comparison_results | to_nice_json }}"
    dest: "{{ baseline_base_path }}/{{ inventory_hostname }}_post_check_comparison.json"
    mode: '0644'
  delegate_to: localhost
  changed_when: false

- name: Display post-upgrade validation results and baseline comparison
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "POST-UPGRADE VALIDATION RESULTS"
      - "=========================================="
      - "Device: {{ inventory_hostname }}"
      - "Collection Status: {{ validation_collection_results.overall_status }}"
      - "Comparison Status: {{ validation_comparison_results.arp_mac_status }}, {{ validation_comparison_results.routing_status }}"
      - ""
      - "Files saved:"
      - "  - {{ baseline_base_path }}/{{ inventory_hostname }}_network_baseline.json"
      - "  - {{ baseline_base_path }}/{{ inventory_hostname }}_post_upgrade_baseline.json"
      - "  - {{ baseline_base_path }}/{{ inventory_hostname }}_post_check_collection.json"
      - "  - {{ baseline_base_path }}/{{ inventory_hostname }}_post_check_comparison.json"
      - "=========================================="

- name: Display baseline comparison changes (on failure)
  when: validation_comparison_results.arp_mac_status == "FAIL" or validation_comparison_results.routing_status == "FAIL"
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "BASELINE COMPARISON DIFFERENCES DETECTED"
      - "=========================================="
      - "ARP/MAC Status: {{ validation_comparison_results.arp_mac_status }}"
      - "Routing Status: {{ validation_comparison_results.routing_status }}"
      - ""
      - "Run with -v flag to see detailed delta entries"
      - "=========================================="

- name: Compare pre/post upgrade states
  ansible.builtin.assert:
    that:
      - validation_comparison_results is defined
      - validation_comparison_results.arp_mac_status != "FAIL"
      - validation_comparison_results.routing_status != "FAIL"
    fail_msg: "Post-upgrade validation shows degradation from baseline."
