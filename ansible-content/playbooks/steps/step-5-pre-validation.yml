---
# STEP 5: Network Resources Gathering and Pre-Upgrade Validation
# Comprehensive validation: BGP, interfaces, routing, etc.
# MUST PASS or workflow STOPS
# Dependencies: STEP 1 only (connectivity to device)
#
# NOTE: Image staging (step 4) is NOT a prerequisite for validation.
# Validation only needs network connectivity to gather current state.
# If you want a config backup, run step 4 separately before step 6.

- name: Include STEP 1 as prerequisite (connectivity to device)
  ansible.builtin.include_tasks:
    file: step-1-connectivity.yml

- name: Display STEP 5 entry
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "STEP 5: STARTING NETWORK VALIDATION"
      - "=========================================="
      - "Device: {{ inventory_hostname }}"
      - "Platform: {{ platform }}"
      - "About to gather network resources..."
      - "=========================================="

- name: Gather comprehensive network resources for validation
  ansible.builtin.include_role:
    name: common
    tasks_from: network-resources-gathering
  vars:
    validation_phase: "pre_upgrade"

- name: Display network resources gathering completion
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "NETWORK RESOURCES GATHERED - PROCEEDING TO VALIDATION"
      - "=========================================="

- name: Capture pre-upgrade network state
  ansible.builtin.include_role:
    name: network-validation
  vars:
    validation_phase: "pre_upgrade"
    save_baseline: true

- name: Verify all critical services are operational
  ansible.builtin.assert:
    that:
      - network_validation_results is defined
      - network_validation_results.overall_status == "healthy"
    fail_msg: "Pre-upgrade validation failed. Network not in healthy state."
