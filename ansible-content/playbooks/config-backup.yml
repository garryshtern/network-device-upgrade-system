---
# Configuration Backup Playbook
# Creates comprehensive device configuration backups before upgrades
# Business hours safe - read-only operations

- name: Configuration Backup
  hosts: "{{ target_hosts }}"
  gather_facts: false
  connection: network_cli
  vars:
    backup_timestamp: "{{ ansible_date_time.iso8601 }}"
    # backup_type, include_startup_config, include_running_config inherited from group_vars

  tasks:
    - name: Create backup directory structure
      ansible.builtin.file:
        path: "{{ backup_base_path }}/{{ inventory_hostname }}/{{ backup_timestamp }}"
        state: directory
        mode: "0755"
      delegate_to: localhost

    - name: Configuration backup (all platforms)
      ansible.builtin.include_role:
        name: common
        tasks_from: config-backup
      vars:
        backup_destination: >
          {{ backup_base_path }}/{{ inventory_hostname }}/{{ backup_timestamp }}

    - name: Verify backup files were created
      ansible.builtin.find:
        paths: >
          {{ backup_base_path }}/{{ inventory_hostname }}/{{ backup_timestamp }}
        file_type: file
      register: backup_files
      delegate_to: localhost

    - name: Assert backup files exist
      ansible.builtin.assert:
        that:
          - backup_files.files | length > 0
        fail_msg: "No backup files were created for {{ inventory_hostname }}"

    - name: Create backup archive
      community.general.archive:
        path: "{{ backup_base_path }}/{{ inventory_hostname }}/{{ backup_timestamp }}"
        dest: "{{ backup_base_path }}/{{ inventory_hostname }}/{{ inventory_hostname }}-backup-{{ backup_timestamp }}.tar.gz"
        format: gz
        owner: ansible
        group: network-operators
        mode: '0640'
      delegate_to: localhost

    - name: Record backup metrics
      ansible.builtin.include_role:
        name: common
        tasks_from: metrics-export
      vars:
        metric_type: "configuration_backup"
        metric_data:
          device_id: "{{ inventory_hostname }}"
          platform: "{{ platform }}"
          backup_timestamp: "{{ backup_timestamp }}"
          backup_type: "{{ backup_type }}"
          file_count: "{{ backup_files.files | length }}"
          backup_size_mb: "{{ (backup_files.files | map(attribute='size') | sum / 1024 / 1024) | round(2) }}"
      when:
        - export_metrics | bool
