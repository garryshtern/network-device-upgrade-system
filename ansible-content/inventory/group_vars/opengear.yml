---
# Opengear Specific Configuration
# For console servers and smart PDUs

# Connection settings - SSH key and API token auth preferred over passwords
ansible_network_os: opengear
ansible_connection: ssh  # Default to SSH, overridden for modern API devices

# Platform identifier (use this in playbooks, NOT ansible_network_os)
platform: opengear

ansible_host: "{{ inventory_hostname }}"

# Credentials are dynamically mapped in group_vars/all.yml based on platform
# ansible_user, ansible_password, ansible_ssh_private_key_file set in all.yml

ansible_ssh_common_args: >
  -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
  -o PubkeyAuthentication=yes -o PreferredAuthentications=publickey,password

# Opengear-specific credential variables for API access
opengear_username: "{{ vault_opengear_username }}"
opengear_password: "{{ vault_opengear_password }}"
# API token authentication (preferred for API connections)
opengear_api_token: "{{ vault_opengear_api_token | default(omit) }}"

# Platform specific settings
vendor: "opengear"
device_family: "console_server"  # or smart_pdu

# API settings
api_base_url: "https://{{ ansible_host }}/api/v1"
api_timeout: 60
api_retries: 3
validate_certs: false

# Device type detection
auto_detect_device_type: true
supported_models:
  legacy_cli:
    console_servers:
      - "CM7100"    # Legacy console server - CLI only
      - "OM7200"    # Legacy operations manager - CLI only (IM7200)
  current_cli:
    console_servers:
      - "CM8100"    # Current console server - CLI upgrades
      - "OM2100"    # Current operations manager - CLI upgrades
      - "OM2200"    # Current operations manager - CLI upgrades

# Architecture detection settings
architecture_detection:
  api_test_timeout: 10
  api_test_endpoints:
    - "/api/v1/system/info"
    - "/api/v2/system/info"
  legacy_cli_commands:
    - "show system info"
    - "show system status"

# Firmware management
firmware_upload_timeout: 3600
firmware_chunk_size: 1048576  # 1MB chunks
verify_firmware_checksum: true
local_firmware_path: "{{ firmware_base_path }}"

# Firmware filename patterns by device model
firmware_filename_patterns:
  legacy_cli:
    # Legacy devices use 5.x.x version format (e.g., 5.2.4)
    CM7100: "cm71xx-{{ target_version }}.flash"  # cm71xx-5.2.4.flash
    OM7200: "im72xx-{{ target_version }}.flash"  # im72xx-5.2.4.flash
  current_cli:
    # Modern devices use YY.MM.x format (e.g., 25.07.0)
    CM8100: "console_manager-{{ target_version }}-production-signed.raucb"
    OM2100: "operations_manager-{{ target_version }}-production-signed.raucb"
    OM2200: "operations_manager-{{ target_version }}-production-signed.raucb"

# Version format validation by device architecture
version_formats:
  legacy_cli:
    pattern: "^5\\.[0-9]+\\.[0-9]+$"
    description: "Legacy 5.x.x semantic versioning (e.g., 5.16.4)"
    example: "5.16.4"
  current_cli:
    pattern: "^[0-9]{2}\\.[0-9]{2}\\.[0-9]+$"
    description: "Modern YY.MM.x date-based versioning (e.g., 25.07.0)"
    example: "25.07.0"

# Upgrade command by device architecture
upgrade_commands:
  legacy_cli:
    command: "netflash"
    storage_paths: ["/var/mnt/storage.nvlog", "/var/mnt/storage.usb"]
  current_cli:
    command: "puginstall"
    storage_paths: ["/tmp"]
    options: "--reboot-after"

# Console server specific settings
console_server:
  max_serial_ports: 48
  notify_active_sessions: true
  maintenance_mode_message: "Console server firmware upgrade in progress"
  session_timeout_warning: 300  # 5 minutes
  graceful_session_closure: true

# Smart PDU specific settings
smart_pdu:
  max_power_outlets: 24
  power_safety_threshold: 90  # Percentage
  critical_outlet_protection: true
  environmental_monitoring: true
  power_cycle_delay: 5  # seconds

# Serial port management
serial_port_validation:
  test_connectivity: true
  test_timeout: 30
  max_test_ports: 5  # Don't test all ports to avoid disruption

# Power management validation
power_outlet_validation:
  test_non_critical_only: true
  max_test_outlets: 3
  power_cycle_test: false  # Too risky for production

# Network validation
network_connectivity_test:
  enabled: true
  test_host: "8.8.8.8"
  ping_count: 3
  timeout: 10

# Configuration management
backup_config_before_upgrade: true
config_validation_enabled: true
restore_config_on_failure: true

# Environmental monitoring (if available)
environmental_sensors:
  temperature: true
  humidity: true
  validate_thresholds: true

# Upgrade process settings
pre_upgrade_checks: true
post_upgrade_validation: true

# Architecture-specific boot times
boot_times:
  modern_api:
    reboot_wait_time: 120
    service_initialization_wait: 60
  legacy_cli:
    reboot_wait_time: 180  # Legacy devices boot slower
    service_initialization_wait: 120

# Legacy CLI specific settings
legacy_cli:
  upgrade_timeout: 1800  # 30 minutes for legacy upgrades
  progress_check_interval: 30
  max_retries: 60
  cli_timeout: 30
  session_message_delay: 60  # Time to warn users before upgrade
  cleanup_firmware_after_install: true

# Web interface settings
web_interface_timeout: 30
max_upload_retries: 3
session_keepalive: true

# Monitoring integration
export_metrics: true
metric_collection_interval: 60
alert_on_upgrade_failure: true

# Security settings
change_default_passwords: false  # Assume already done
validate_ssl_certificates: false  # Often self-signed
enable_audit_logging: true

# Rollback settings
enable_automatic_rollback: true
rollback_timeout: 600
preserve_user_data: true

# Validation settings specific to device type
console_server_validation:
  - serial_port_count
  - port_connectivity
  - session_capability
  - logging_functionality

smart_pdu_validation:
  - outlet_count
  - power_measurement
  - outlet_control
  - environmental_data
