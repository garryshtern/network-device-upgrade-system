---
# Cisco NX-OS Vendor-Specific Tests
# Tests NX-OS role functionality including ISSU, EPLD upgrades,
# and validation capabilities

- name: Cisco NX-OS Platform Tests
  hosts: localhost
  gather_facts: false
  vars:
    role_path: >-
      {{ playbook_dir }}/../../ansible-content/roles/cisco-nxos-upgrade
    test_scenarios:
      - name: "ISSU Capable with EPLD Upgrade"
        device_vars:
          device_model: "N9K-C93180YC-EX"
          firmware_version: "9.3.10"
          target_version: "10.1.2"
          issu_capable: true
          epld_upgrade_required: true
          current_epld_version: "1.2.3"
          target_epld_version: "1.3.1"
          epld_images:
            - "n9000-epld.10.1.2.img"
          nxapi_enabled: true
        expected_results:
          upgrade_method: "issu"
          epld_required: true
          nxapi_supported: true

      - name: "Non-ISSU Device without EPLD"
        device_vars:
          device_model: "N9K-C9336C-FX2"
          firmware_version: "9.2.4"
          target_version: "10.1.2"
          issu_capable: false
          epld_upgrade_required: false
          current_epld_version: "1.3.0"
          target_epld_version: "1.3.1"
          epld_images: []
          nxapi_enabled: false
        expected_results:
          upgrade_method: "standard"
          epld_required: false
          nxapi_supported: false

      - name: "ISSU with Multiple EPLD Images"
        device_vars:
          device_model: "N9K-C93240YC-FX2"
          firmware_version: "10.0.1"
          target_version: "10.2.3.M"
          issu_capable: true
          epld_upgrade_required: true
          current_epld_version: "2.1.0"
          target_epld_version: "2.2.1"
          epld_images:
            - "n9000-epld.10.2.3.M.img"
            - "n9000-module-epld.10.2.3.M.img"
          nxapi_enabled: true
        expected_results:
          upgrade_method: "issu"
          epld_required: true
          nxapi_supported: true

  tasks:
    - name: Validate NX-OS role structure
      stat:
        path: "{{ role_path }}"
      register: nxos_role_check

    - name: Assert NX-OS role exists
      assert:
        that:
          - nxos_role_check.stat.exists
          - nxos_role_check.stat.isdir
        fail_msg: "NX-OS role directory not found"
        success_msg: "✓ NX-OS role structure validated"

    - name: Validate required NX-OS role files
      stat:
        path: "{{ role_path }}/{{ item }}"
      register: nxos_file_checks
      loop:
        - "tasks/main.yml"
        - "tasks/image-loading.yml"
        - "tasks/image-installation.yml"
        - "tasks/issu-procedures.yml"
        - "defaults/main.yml"
        - "vars/main.yml"

    - name: Assert all required NX-OS files exist
      assert:
        that:
          - item.stat.exists
        fail_msg: "Required NX-OS file missing: {{ item.item }}"
        success_msg: "✓ Required NX-OS file found: {{ item.item }}"
      loop: "{{ nxos_file_checks.results }}"

    - name: Test NX-OS ISSU and EPLD scenarios
      include_tasks: validate_nxos_scenario.yml
      loop: "{{ test_scenarios }}"
      loop_control:
        loop_var: nxos_scenario
        label: "{{ nxos_scenario.name }}"

    - name: Test NX-OS validation is centralized
      block:
        - name: Verify validation removed from NX-OS role
          stat:
            path: "{{ role_path }}/tasks/validation.yml"
          register: nxos_validation_check

        - name: Assert validation is not in NX-OS role
          assert:
            that:
              - not nxos_validation_check.stat.exists
            success_msg: "✓ Validation correctly removed from NX-OS role (now centralized)"
            fail_msg: "Validation should be centralized, not in NX-OS role"

        - name: Verify centralized network validation exists
          stat:
            path: "{{ playbook_dir }}/../../ansible-content/roles/network-validation/tasks/bgp-validation.yml"
          register: centralized_validation_check

        - name: Assert centralized validation capabilities exist
          assert:
            that:
              - centralized_validation_check.stat.exists
            success_msg: "✓ Network validation is properly centralized"
            fail_msg: "Centralized network validation missing"

    - name: Test NX-OS EPLD upgrade capability
      block:
        - name: Check for EPLD handling in image-installation tasks
          slurp:
            src: "{{ role_path }}/tasks/image-installation.yml"
          register: image_installation_content
          when: nxos_role_check.stat.exists

        - name: Validate EPLD upgrade logic exists
          assert:
            that:
              - "'epld' in image_installation_content.content | b64decode"
            fail_msg: "EPLD upgrade handling missing from image-installation tasks"
            success_msg: "✓ EPLD upgrade capability confirmed"
          when: image_installation_content is defined

        - name: Check for EPLD installation task file
          stat:
            path: "{{ role_path }}/tasks/epld-installation.yml"
          register: epld_installation_check

        - name: Validate EPLD installation task file exists
          assert:
            that:
              - epld_installation_check.stat.exists
            fail_msg: "EPLD installation task file missing: epld-installation.yml"
            success_msg: "✓ EPLD installation task file found"

        - name: Check for combined EPLD installation task file
          stat:
            path: "{{ role_path }}/tasks/epld-installation-combined.yml"
          register: epld_combined_check

        - name: Validate combined EPLD installation task file exists
          assert:
            that:
              - epld_combined_check.stat.exists
            fail_msg: "Combined EPLD installation task file missing: epld-installation-combined.yml"
            success_msg: "✓ Combined EPLD installation task file found"

        - name: Check for EPLD loading task file
          stat:
            path: "{{ role_path }}/tasks/epld-loading.yml"
          register: epld_loading_check

        - name: Validate EPLD loading task file exists
          assert:
            that:
              - epld_loading_check.stat.exists
            fail_msg: "EPLD loading task file missing: epld-loading.yml"
            success_msg: "✓ EPLD loading task file found"

    - name: Test NX-OS ISSU procedures
      block:
        - name: Validate ISSU procedures file exists
          stat:
            path: "{{ role_path }}/tasks/issu-procedures.yml"
          register: issu_procedures_check

        - name: Read ISSU procedures content
          slurp:
            src: "{{ role_path }}/tasks/issu-procedures.yml"
          register: issu_content
          when: issu_procedures_check.stat.exists

        - name: Assert ISSU procedures capability
          assert:
            that:
              - issu_procedures_check.stat.exists
              - "'issu' in issu_content.content | b64decode"
            fail_msg: "ISSU procedures missing or insufficient"
            success_msg: "✓ ISSU procedures capability confirmed"

    - name: Test NX-OS enhanced BFD validation
      block:
        - name: Check for enhanced BFD validation
          assert:
            that:
              - "'bfd' in validation_content.content | b64decode"
            fail_msg: "Enhanced BFD validation missing"
            success_msg: "✓ Enhanced BFD validation confirmed"
          when: validation_content is defined

    - name: NX-OS platform test summary
      debug:
        msg:
          - "=== Cisco NX-OS Platform Test Results ==="
          - "✓ Role structure validated"
          - "✓ Required files confirmed"
          - "✓ ISSU and EPLD scenarios tested"
          - "✓ Validation capabilities confirmed (BGP, BFD, IGMP)"
          - "✓ EPLD upgrade capability confirmed"
          - "✓ ISSU procedures confirmed"
          - "✓ Enhanced BFD validation confirmed"
          - "✓ NX-OS platform testing: COMPLETE"
