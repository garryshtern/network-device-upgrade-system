---
# Cisco NX-OS Vendor-Specific Tests
# Tests NX-OS role functionality including ISSU, EPLD upgrades,
# and validation capabilities

- name: Cisco NX-OS Platform Tests
  hosts: localhost
  gather_facts: false
  vars:
    role_path: >-
      {{ playbook_dir }}/../../ansible-content/roles/cisco-nxos-upgrade
    test_scenarios:
      - name: "ISSU Capable with EPLD Upgrade"
        device_vars:
          platform_type: "cisco_nxos"
          device_model: "N9K-C93180YC-EX"
          firmware_version: "9.3.10"
          target_version: "10.1.2"
          issu_capable: true
          epld_upgrade_required: true
          current_epld_version: "1.2.3"
          target_epld_version: "1.3.1"
          epld_images:
            - "n9000-epld.10.1.2.img"
          nxapi_enabled: true
        expected_results:
          upgrade_method: "issu"
          epld_required: true
          nxapi_supported: true

      - name: "Non-ISSU Device without EPLD"
        device_vars:
          platform_type: "cisco_nxos"
          device_model: "N9K-C9336C-FX2"
          firmware_version: "9.2.4"
          target_version: "10.1.2"
          issu_capable: false
          epld_upgrade_required: false
          current_epld_version: "1.3.0"
          target_epld_version: "1.3.1"
          epld_images: []
          nxapi_enabled: false
        expected_results:
          upgrade_method: "standard"
          epld_required: false
          nxapi_supported: false

      - name: "ISSU with Multiple EPLD Images"
        device_vars:
          platform_type: "cisco_nxos"
          device_model: "N9K-C93240YC-FX2"
          firmware_version: "10.0.1"
          target_version: "10.2.3"
          issu_capable: true
          epld_upgrade_required: true
          current_epld_version: "2.1.0"
          target_epld_version: "2.2.1"
          epld_images:
            - "n9000-epld.10.2.3.img"
            - "n9000-module-epld.10.2.3.img"
          nxapi_enabled: true
        expected_results:
          upgrade_method: "issu"
          epld_required: true
          nxapi_supported: true

  tasks:
    - name: Validate NX-OS role structure
      stat:
        path: "{{ role_path }}"
      register: nxos_role_check

    - name: Assert NX-OS role exists
      assert:
        that:
          - nxos_role_check.stat.exists
          - nxos_role_check.stat.isdir
        fail_msg: "NX-OS role directory not found"
        success_msg: "✓ NX-OS role structure validated"

    - name: Validate required NX-OS role files
      stat:
        path: "{{ role_path }}/{{ item }}"
      register: nxos_file_checks
      loop:
        - "tasks/main.yml"
        - "tasks/image-loading.yml"
        - "tasks/image-installation.yml"
        - "tasks/issu-procedures.yml"
        - "tasks/validation.yml"
        - "vars/main.yml"

    - name: Assert all required NX-OS files exist
      assert:
        that:
          - item.stat.exists
        fail_msg: "Required NX-OS file missing: {{ item.item }}"
        success_msg: "✓ Required NX-OS file found: {{ item.item }}"
      loop: "{{ nxos_file_checks.results }}"

    - name: Test NX-OS ISSU and EPLD scenarios
      include_tasks: validate_nxos_scenario.yml
      loop: "{{ test_scenarios }}"
      loop_control:
        loop_var: nxos_scenario
        label: "{{ nxos_scenario.name }}"

    - name: Test NX-OS validation capabilities
      block:
        - name: Validate BGP validation exists
          stat:
            path: "{{ role_path }}/tasks/validation.yml"
          register: bgp_validation_check

        - name: Read validation task content
          slurp:
            src: "{{ role_path }}/tasks/validation.yml"
          register: validation_content
          when: bgp_validation_check.stat.exists

        - name: Assert NX-OS validation capabilities
          assert:
            that:
              - bgp_validation_check.stat.exists
              - "'bgp' in validation_content.content | b64decode"
              - "'bfd' in validation_content.content | b64decode"
              - "'igmp' in validation_content.content | b64decode"
            fail_msg: "NX-OS validation capabilities missing"
            success_msg: "✓ NX-OS validation capabilities confirmed (BGP, BFD, IGMP)"

    - name: Test NX-OS EPLD upgrade capability
      block:
        - name: Check for EPLD handling in tasks
          slurp:
            src: "{{ role_path }}/tasks/main.yml"
          register: main_tasks_content
          when: nxos_role_check.stat.exists

        - name: Validate EPLD upgrade logic exists
          assert:
            that:
              - "'epld' in main_tasks_content.content | b64decode"
            fail_msg: "EPLD upgrade handling missing from main tasks"
            success_msg: "✓ EPLD upgrade capability confirmed"
          when: main_tasks_content is defined

    - name: Test NX-OS ISSU procedures
      block:
        - name: Validate ISSU procedures file exists
          stat:
            path: "{{ role_path }}/tasks/issu-procedures.yml"
          register: issu_procedures_check

        - name: Read ISSU procedures content
          slurp:
            src: "{{ role_path }}/tasks/issu-procedures.yml"
          register: issu_content
          when: issu_procedures_check.stat.exists

        - name: Assert ISSU procedures capability
          assert:
            that:
              - issu_procedures_check.stat.exists
              - "'issu' in issu_content.content | b64decode"
            fail_msg: "ISSU procedures missing or insufficient"
            success_msg: "✓ ISSU procedures capability confirmed"

    - name: Test NX-OS enhanced BFD validation
      block:
        - name: Check for enhanced BFD validation
          assert:
            that:
              - "'bfd' in validation_content.content | b64decode"
            fail_msg: "Enhanced BFD validation missing"
            success_msg: "✓ Enhanced BFD validation confirmed"
          when: validation_content is defined

    - name: NX-OS platform test summary
      debug:
        msg:
          - "=== Cisco NX-OS Platform Test Results ==="
          - "✓ Role structure validated"
          - "✓ Required files confirmed"
          - "✓ ISSU and EPLD scenarios tested"
          - "✓ Validation capabilities confirmed (BGP, BFD, IGMP)"
          - "✓ EPLD upgrade capability confirmed"
          - "✓ ISSU procedures confirmed"
          - "✓ Enhanced BFD validation confirmed"
          - "✓ NX-OS platform testing: COMPLETE"
