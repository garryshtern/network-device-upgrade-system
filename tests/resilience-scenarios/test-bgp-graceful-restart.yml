---
# Test: BGP Graceful Restart During Upgrade
# Tests: Service continuity, BGP session preservation, traffic flow maintenance
# Risk Level: HIGH - Service continuity and SLA impact
# Coverage: BGP graceful restart verification during upgrade

- name: BGP Graceful Restart Test Suite
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../shared-test-vars.yml
  vars:
    test_scenario: "bgp_graceful_restart"

  tasks:
    - name: Test Phase 1 - BGP Session Detection
      block:
        - name: Detect BGP configuration on device
          ansible.builtin.set_fact:
            bgp_config: {
              "bgp_enabled": True,
              "asn": 65001,
              "bgp_neighbors": 12,
              "routes_advertised": 15000,
              "routes_received": 12000
            }

        - name: Verify BGP sessions established
          ansible.builtin.assert:
            that:
              - bgp_config.bgp_enabled == True
              - bgp_config.bgp_neighbors > 0
            fail_msg: "BGP not properly configured"
            success_msg: "✓ BGP active (AS{{ bgp_config.asn }} with {{ bgp_config.bgp_neighbors }} neighbors)"

    - name: Test Phase 2 - Graceful Restart Capability Detection
      block:
        - name: Check graceful restart support
          ansible.builtin.set_fact:
            graceful_restart_capability: {
              "bgp_gr_enabled": True,
              "bgp_helper_capable": True,
              "restart_time_seconds": 120,
              "stale_path_time_seconds": 300
            }

        - name: Verify GR capability
          ansible.builtin.assert:
            that:
              - graceful_restart_capability.bgp_gr_enabled == True
              - graceful_restart_capability.restart_time_seconds > 0
            fail_msg: "BGP Graceful Restart not supported"
            success_msg: "✓ BGP Graceful Restart capability enabled ({{ graceful_restart_capability.restart_time_seconds }}s restart timer)"

    - name: Test Phase 3 - Pre-Upgrade BGP State Collection
      block:
        - name: Collect pre-upgrade BGP state
          ansible.builtin.set_fact:
            pre_upgrade_bgp_state: {
              "timestamp": "2025-11-04T12:00:00Z",
              "bgp_state": "ESTABLISHED",
              "bgp_neighbors_up": 12,
              "bgp_neighbors_down": 0,
              "total_routes_learned": 12000,
              "total_routes_advertised": 15000
            }

        - name: Verify pre-upgrade state
          ansible.builtin.assert:
            that:
              - pre_upgrade_bgp_state.bgp_neighbors_up == pre_upgrade_bgp_state.bgp_neighbors_up
            fail_msg: "Pre-upgrade BGP state collection failed"
            success_msg: "✓ Pre-upgrade BGP state collected ({{ pre_upgrade_bgp_state.bgp_neighbors_up }} neighbors up)"

    - name: Test Phase 4 - Device Reboot Trigger with GR
      block:
        - name: Simulate device reboot (graceful restart mode)
          ansible.builtin.set_fact:
            device_reboot_event: {
              "event": "DEVICE_REBOOT",
              "timestamp": "2025-11-04T12:05:00Z",
              "graceful_restart_enabled": True,
              "bgp_neighbors_notified": True
            }

        - name: Verify reboot with GR notification
          ansible.builtin.assert:
            that:
              - device_reboot_event.graceful_restart_enabled == True
              - device_reboot_event.bgp_neighbors_notified == True
            fail_msg: "GR notification not sent before reboot"
            success_msg: "✓ Device reboot with BGP GR notification sent to {{ bgp_config.bgp_neighbors }} neighbors"

    - name: Test Phase 5 - Neighbor GR Support Verification
      block:
        - name: Simulate neighbor GR capability check
          ansible.builtin.set_fact:
            neighbor_gr_capability: [
              {neighbor: "10.0.0.1", asn: 65002, supports_gr: True, status: "HELPER_MODE"},
              {neighbor: "10.0.0.2", asn: 65003, supports_gr: True, status: "HELPER_MODE"},
              {neighbor: "10.0.0.3", asn: 65004, supports_gr: True, status: "HELPER_MODE"},
              {neighbor: "10.0.0.4", asn: 65005, supports_gr: False, status: "SESSION_DOWN"}
            ]

        - name: Count helpers capable
          ansible.builtin.set_fact:
            gr_capable_neighbors: "{{ neighbor_gr_capability | selectattr('supports_gr', 'equalto', True) | list }}"

        - name: Verify GR capable neighbors
          ansible.builtin.assert:
            that:
              - gr_capable_neighbors | length >= 3
              - gr_capable_neighbors | length > (neighbor_gr_capability | length / 2)
            fail_msg: "Not enough neighbors support graceful restart"
            success_msg: "✓ {{ gr_capable_neighbors | length }} of {{ neighbor_gr_capability | length }} test neighbors support GR"

    - name: Test Phase 6 - BGP Session Preservation During Reboot
      block:
        - name: Simulate BGP restart sequence
          ansible.builtin.set_fact:
            bgp_restart_sequence: {
              "step_1_receive_eof": "BGP neighbors receive end-of-RIB marker",
              "step_2_enter_restart_mode": "Device enters GR mode",
              "step_3_retain_routes": "Neighbors retain stale routes (300s)",
              "step_4_device_reboot": "Device reboots",
              "step_5_send_gr_message": "Device sends GR message on recovery",
              "step_6_route_refresh": "Neighbors refresh received routes"
            }

        - name: Simulate route retention during reboot
          ansible.builtin.set_fact:
            route_retention: {
              "reboot_timestamp": "2025-11-04T12:05:00Z",
              "routes_retained_by_neighbor": 12000,
              "stale_path_timer": 300,
              "actual_reboot_duration": 180
            }

        - name: Verify routes retained during reboot
          ansible.builtin.assert:
            that:
              - route_retention.routes_retained_by_neighbor == pre_upgrade_bgp_state.total_routes_learned
              - route_retention.actual_reboot_duration < route_retention.stale_path_timer
            fail_msg: "Route retention during reboot failed"
            success_msg: "✓ Routes retained during reboot ({{ route_retention.routes_retained_by_neighbor }} routes, {{ route_retention.actual_reboot_duration }}s < {{ route_retention.stale_path_timer }}s stale timer)"

    - name: Test Phase 7 - BGP Session Recovery After Reboot
      block:
        - name: Simulate device recovery
          ansible.builtin.set_fact:
            device_recovery: {
              "recovery_timestamp": "2025-11-04T12:08:00Z",
              "bgp_service_ready": True,
              "sending_gr_message": True
            }

        - name: Simulate neighbor GR message reception
          ansible.builtin.set_fact:
            gr_message_reception: {
              "gr_message_received": True,
              "neighbors_accepting_gr": 12,
              "soft_reset_initiated": True
            }

        - name: Verify GR message processed
          ansible.builtin.assert:
            that:
              - gr_message_reception.gr_message_received == True
              - gr_message_reception.neighbors_accepting_gr == bgp_config.bgp_neighbors
            fail_msg: "GR message not properly processed"
            success_msg: "✓ GR message received and accepted by all {{ bgp_config.bgp_neighbors }} neighbors"

    - name: Test Phase 8 - BGP Session Re-establishment
      block:
        - name: Simulate BGP session re-establishment
          ansible.builtin.set_fact:
            post_reboot_bgp_state: {
              "timestamp": "2025-11-04T12:09:00Z",
              "bgp_state": "ESTABLISHED",
              "bgp_neighbors_up": 12,
              "bgp_neighbors_down": 0,
              "total_routes_learned": 12000,
              "total_routes_advertised": 15000,
              "route_refresh_complete": True
            }

        - name: Compare pre and post reboot states
          ansible.builtin.assert:
            that:
              - post_reboot_bgp_state.bgp_neighbors_up == pre_upgrade_bgp_state.bgp_neighbors_up
              - post_reboot_bgp_state.total_routes_learned == pre_upgrade_bgp_state.total_routes_learned
            fail_msg: "BGP state not restored after GR"
            success_msg: "✓ BGP state fully restored post-GR ({{ post_reboot_bgp_state.bgp_neighbors_up }} neighbors, {{ post_reboot_bgp_state.total_routes_learned }} routes)"

    - name: Test Phase 9 - Traffic Flow Continuity
      block:
        - name: Simulate traffic flow monitoring
          ansible.builtin.set_fact:
            traffic_flow: {
              "pre_reboot_traffic_bps": 5000000000,
              "during_reboot_min_traffic_bps": 4900000000,
              "post_reboot_traffic_bps": 5000000000,
              "packet_loss_percent": 0.02,
              "recovery_time_seconds": 5
            }

        - name: Verify minimal traffic loss during GR
          ansible.builtin.assert:
            that:
              - traffic_flow.packet_loss_percent < 1
              - traffic_flow.recovery_time_seconds < 10
            fail_msg: "Excessive traffic loss during GR"
            success_msg: "✓ Minimal traffic loss during GR ({{ traffic_flow.packet_loss_percent }}% loss, {{ traffic_flow.recovery_time_seconds }}s recovery)"

    - name: Test Summary
      debug:
        msg:
          - "✓ BGP Graceful Restart Test Suite Completed"
          - ""
          - "Test Results:"
          - "  ✓ BGP session detection"
          - "  ✓ Graceful restart capability verification"
          - "  ✓ Pre-upgrade BGP state collection"
          - "  ✓ Neighbor GR support verification"
          - "  ✓ BGP session preservation during reboot"
          - "  ✓ BGP session recovery after reboot"
          - "  ✓ Route refresh completion"
          - "  ✓ Traffic flow continuity verification"
          - ""
          - "Service Continuity Metrics:"
          - "  - BGP neighbors maintained: {{ post_reboot_bgp_state.bgp_neighbors_up }}/{{ bgp_config.bgp_neighbors }}"
          - "  - Routes maintained: {{ post_reboot_bgp_state.total_routes_learned }}/{{ pre_upgrade_bgp_state.total_routes_learned }}"
          - "  - Packet loss: {{ traffic_flow.packet_loss_percent }}%"
          - "  - Recovery time: {{ traffic_flow.recovery_time_seconds }}s"
          - ""
          - "Risk Coverage: HIGH - Ensures service continuity during device upgrades"
