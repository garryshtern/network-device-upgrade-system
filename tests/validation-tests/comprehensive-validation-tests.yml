---
# Comprehensive Platform Validation Test Suite
# Tests all validation components across all platforms

- name: Comprehensive Platform Validation Test Suite
  hosts: localhost
  gather_facts: no
  vars:
    validation_test_matrix:
      cisco_nxos:
        platform: "cisco_nxos"
        expected_features:
          - "ISSU support"
          - "EPLD upgrades"
      cisco_iosxe:
        platform: "cisco_iosxe"
        expected_features:
          - "Install/Bundle mode handling"
      opengear:
        platform: "opengear"
        expected_features:
          - "Multi-architecture support"
          - "Legacy CLI automation"
          - "Modern API automation"

    # All validation tasks are now centralized in network-validation role
    network_validation_tasks:
      - "bgp-validation.yml"
      - "interface-validation.yml"
      - "routing-validation.yml"
      - "arp-validation.yml"
      - "multicast-validation.yml"

    fortios:
      platform: "fortios"
      expected_features:
        - "HA cluster coordination"
        - "VDOM handling"
    metamako:
      platform: "metamako"
      expected_features:
        - "Ultra-low latency procedures"
        - "Custom CLI handling"
        - "Timing validation"

  tasks:
    - name: Comprehensive Validation Test Suite Information
      debug:
        msg: |
          Starting Comprehensive Platform Validation Test Suite

          All network validation is now centralized in network-validation role
          Testing {{ network_validation_tasks | length }} validation tasks:
          - BGP validation
          - Interface validation
          - Routing validation
          - ARP validation
          - Multicast validation

          Platform-specific features are handled by upgrade roles:
          - Cisco NX-OS: ISSU support, EPLD upgrades
          - Cisco IOS-XE: Install/Bundle mode handling
          - Opengear: Multi-architecture support
          - FortiOS: HA cluster coordination
          - Metamako MOS: Ultra-low latency procedures

    # ==========================================
    # Network Validation Tests (Centralized)
    # ==========================================

    - name: Network Validation Tests
      block:
        - name: Check Network Validation Task Files
          ansible.builtin.stat:
            path: "{{ playbook_dir }}/../../ansible-content/roles/network-validation/tasks/{{ item }}"
          register: network_task_files
          loop: "{{ network_validation_tasks }}"

        - name: Validate Network Validation Task Files Exist
          ansible.builtin.assert:
            that:
              - item.stat.exists
            success_msg: "✓ Network validation {{ item.item }} exists"
            fail_msg: "Missing network validation task: {{ item.item }}"
          loop: "{{ network_task_files.results }}"

    # ==========================================
    # Platform Upgrade Role Tests
    # ==========================================

    - name: Cisco NX-OS Upgrade Role Tests
      block:
        - name: Check NX-OS upgrade role main tasks
          ansible.builtin.stat:
            path: "{{ playbook_dir }}/../../ansible-content/roles/cisco-nxos-upgrade/tasks/main.yml"
          register: nxos_main_tasks

        - name: Validate NX-OS main tasks exist
          ansible.builtin.assert:
            that:
              - nxos_main_tasks.stat.exists
            success_msg: "✓ NX-OS main tasks exist"
            fail_msg: "Missing NX-OS main tasks"

        - name: Check NX-OS defaults file
          ansible.builtin.stat:
            path: "{{ playbook_dir }}/../../ansible-content/roles/cisco-nxos-upgrade/defaults/main.yml"
          register: nxos_defaults

        - name: Validate NX-OS defaults exist
          ansible.builtin.assert:
            that:
              - nxos_defaults.stat.exists
            success_msg: "✓ NX-OS defaults exist"
            fail_msg: "Missing NX-OS defaults"

    - name: Cisco IOS-XE Upgrade Role Tests
      block:
        - name: Check IOS-XE upgrade role main tasks
          ansible.builtin.stat:
            path: "{{ playbook_dir }}/../../ansible-content/roles/cisco-iosxe-upgrade/tasks/main.yml"
          register: iosxe_main_tasks

        - name: Validate IOS-XE main tasks exist
          ansible.builtin.assert:
            that:
              - iosxe_main_tasks.stat.exists
            success_msg: "✓ IOS-XE main tasks exist"
            fail_msg: "Missing IOS-XE main tasks"

    - name: FortiOS Upgrade Role Tests
      block:
        - name: Check FortiOS upgrade role main tasks
          ansible.builtin.stat:
            path: "{{ playbook_dir }}/../../ansible-content/roles/fortios-upgrade/tasks/main.yml"
          register: fortios_main_tasks

        - name: Validate FortiOS main tasks exist
          ansible.builtin.assert:
            that:
              - fortios_main_tasks.stat.exists
            success_msg: "✓ FortiOS main tasks exist"
            fail_msg: "Missing FortiOS main tasks"

    - name: Metamako MOS Upgrade Role Tests
      block:
        - name: Check Metamako upgrade role main tasks
          ansible.builtin.stat:
            path: "{{ playbook_dir }}/../../ansible-content/roles/metamako-mos-upgrade/tasks/main.yml"
          register: metamako_main_tasks

        - name: Validate Metamako main tasks exist
          ansible.builtin.assert:
            that:
              - metamako_main_tasks.stat.exists
            success_msg: "✓ Metamako main tasks exist"
            fail_msg: "Missing Metamako main tasks"

    - name: Opengear Upgrade Role Tests
      block:
        - name: Check Opengear upgrade role main tasks
          ansible.builtin.stat:
            path: "{{ playbook_dir }}/../../ansible-content/roles/opengear-upgrade/tasks/main.yml"
          register: opengear_main_tasks

        - name: Validate Opengear main tasks exist
          ansible.builtin.assert:
            that:
              - opengear_main_tasks.stat.exists
            success_msg: "✓ Opengear main tasks exist"
            fail_msg: "Missing Opengear main tasks"

    # ==========================================
    # Space Management Role Tests
    # ==========================================

    - name: Space Management Role Tests
      block:
        - name: Check space management role exists
          ansible.builtin.stat:
            path: "{{ playbook_dir }}/../../ansible-content/roles/space-management/tasks/main.yml"
          register: space_mgmt_main

        - name: Validate space management main tasks exist
          ansible.builtin.assert:
            that:
              - space_mgmt_main.stat.exists
            success_msg: "✓ Space management main tasks exist"
            fail_msg: "Missing space management main tasks"

    - name: Test Summary
      debug:
        msg: |
          ✓ Validation Test Suite Completed Successfully

          Verified:
          - All network validation tasks in centralized location
          - All platform upgrade roles have main tasks
          - Space management role structure
          - No duplicate validation logic across roles
