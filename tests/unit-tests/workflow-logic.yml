---
# Workflow logic test playbook
# Tests upgrade workflow decision paths and conditional logic

- name: Workflow Logic Tests
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    test_device_registry: "{{ lookup('file', playbook_dir + '/../fixtures/test-device-registry.yml') | from_yaml }}"
    workflow_scenarios:
      - name: "NX-OS ISSU Capable Path"
        device_vars: "{{ test_device_registry.test_devices.nxos.issu_capable_with_epld | combine({'platform': 'nxos', 'issu_capable': true}) }}"
        expected_path: "issu_upgrade"

      - name: "NX-OS Non-ISSU Path"
        device_vars: "{{ test_device_registry.test_devices.nxos.non_issu_without_epld | combine({'platform': 'nxos', 'issu_capable': false}) }}"
        expected_path: "standard_upgrade"

      - name: "IOS-XE Install Mode Path"
        device_vars: "{{ test_device_registry.test_devices.iosxe.install_mode_capable | combine({'platform': 'ios', 'install_mode': true}) }}"
        expected_path: "install_mode"

      - name: "IOS-XE Bundle Mode Path"
        device_vars: "{{ test_device_registry.test_devices.iosxe.bundle_mode_device | combine({'platform': 'ios', 'install_mode': false}) }}"
        expected_path: "bundle_mode"

      - name: "FortiOS HA Primary Path"
        device_vars: "{{ test_device_registry.test_devices.fortios.ha_primary_firewall | combine({'platform': 'fortios'}) }}"
        expected_path: "ha_primary_upgrade"

      - name: "FortiOS HA Secondary Path"
        device_vars: "{{ test_device_registry.test_devices.fortios.ha_secondary_firewall | combine({'platform': 'fortios'}) }}"
        expected_path: "ha_secondary_upgrade"

      - name: "Skip Validation Path"
        device_vars: "{{ test_device_registry.test_devices.nxos.issu_capable_with_epld | combine({'platform': 'nxos', 'skip_validation': true}) }}"
        expected_path: "skip_validation"

  tasks:
    - name: Test workflow decision logic
      include_tasks: test_workflow_scenario.yml
      loop: "{{ workflow_scenarios }}"
      loop_control:
        loop_var: workflow_test
        label: "{{ workflow_test.name }}"

    - name: Workflow logic tests completed
      debug:
        msg: "All workflow logic tests completed successfully"
