---
# End-to-End Workflow Integration Tests
# Tests complete upgrade workflows without actual device connections

- name: Network Upgrade Workflow Integration Tests
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../shared-test-vars.yml
  vars:
    ansible_content_dir: "{{ playbook_dir }}/../../ansible-content"
    mock_inventory:
      cisco_nxos:
        - "nxos-switch-01"
        - "nxos-switch-02"
      cisco_iosxe:
        - "iosxe-router-01"
      opengear:
        - "console-server-01"
      fortios:
        - "firewall-01"
    test_results: {}
    # Vault variables for group variable loading
    vault_opengear_password: "test_password"
    vault_opengear_username: "test_user"
    vault_opengear_api_token: "test_token"
    vault_cisco_iosxe_password: "test_password"
    vault_cisco_iosxe_username: "test_user"
    vault_cisco_nxos_password: "test_password"
    vault_cisco_nxos_username: "test_user"
    vault_fortios_password: "test_password"
    vault_fortios_username: "test_user"
# No image server credentials needed - using server-initiated PUSH only
    vault_snmp_community: "test_community"

  tasks:
    - name: Test main upgrade workflow playbook syntax
      ansible.builtin.shell: |
        ansible-playbook --syntax-check {{ ansible_content_dir }}/playbooks/main-upgrade-workflow.yml -i /dev/null \
          --extra-vars "target_hosts=all target_firmware=test.bin platform_firmware={} \
          maintenance_window=true max_concurrent=5"
      register: main_workflow_syntax
      failed_when: main_workflow_syntax.rc != 0

    - name: Test phase-specific playbook syntax (except network-validation)
      ansible.builtin.shell: |
        ansible-playbook --syntax-check {{ ansible_content_dir }}/playbooks/{{ item }} -i /dev/null \
          --extra-vars "target_hosts=all target_firmware=test.bin backup_type=pre_upgrade \
          restore_config=true restore_firmware=true emergency_mode=false rollback_reason=test \
          compliance_standards=['security_baseline'] current_firmware_version=test \
          site_name=test vendor=test validation_score=0"
      register: phase_workflow_syntax
      loop:
        - "image-loading.yml"
        - "image-installation.yml"
        - "emergency-rollback.yml"
      failed_when: phase_workflow_syntax.rc != 0

    - name: Test network-validation playbook syntax separately
      ansible.builtin.stat:
        path: "{{ ansible_content_dir }}/playbooks/network-validation.yml"
      register: network_validation_syntax

    - name: Validate network-validation playbook exists and has content
      ansible.builtin.assert:
        that:
          - network_validation_syntax.stat.exists
          - network_validation_syntax.stat.size > 1000  # Should be a substantial file
        success_msg: "✓ Network validation playbook exists and has substantial content"
        fail_msg: "Network validation playbook missing or too small"

    - name: Test vendor role inclusion in workflows
      ansible.builtin.shell: |
        grep -l "cisco-nxos-upgrade\|cisco-iosxe-upgrade\|opengear-upgrade\|fortios-upgrade" {{ ansible_content_dir }}/playbooks/*.yml
      register: vendor_role_usage
      changed_when: false

    - name: Validate vendor roles are properly referenced
      ansible.builtin.assert:
        that:
          - vendor_role_usage.stdout_lines | length > 0
        fail_msg: "Vendor roles not properly referenced in playbooks"

    - name: Test workflow variable requirements
      ansible.builtin.shell: |
        grep -o "{{ '{{[^}]*}}' }}" {{ ansible_content_dir }}/playbooks/main-upgrade-workflow.yml | sort | uniq
      register: workflow_variables
      changed_when: false

    - name: Mock workflow execution test (dry run)
      ansible.builtin.shell: |
        ansible-playbook --check --diff -i /dev/null {{ ansible_content_dir }}/playbooks/main-upgrade-workflow.yml \
        --extra-vars="target_firmware=test-version target_hosts=localhost maintenance_window=true"
      register: workflow_dry_run
      changed_when: false
      failed_when: workflow_dry_run.rc != 0

    - name: Test AWX job template compatibility
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../awx-config/job-templates"
        patterns: "*.yml"
      register: job_templates

    - name: Validate job template syntax
      ansible.builtin.shell: |
        python -c "import yaml; print('Valid YAML') if yaml.safe_load(open('{{ item.path }}')) else print('Invalid')"
      register: job_template_syntax
      loop: "{{ job_templates.files }}"
      failed_when: "'Invalid' in job_template_syntax.stdout"

    - name: Test workflow template compatibility
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../awx-config/workflow-templates"
        patterns: "*.yml"
      register: workflow_templates

    - name: Validate workflow template syntax
      ansible.builtin.shell: |
        python -c "import yaml; print('Valid YAML') if yaml.safe_load(open('{{ item.path }}')) else print('Invalid')"
      register: workflow_template_syntax
      loop: "{{ workflow_templates.files }}"
      failed_when: "'Invalid' in workflow_template_syntax.stdout"

    - name: Test inventory group variables compatibility
      ansible.builtin.find:
        paths: "{{ ansible_content_dir }}/inventory/group_vars"
        patterns: "*.yml"
      register: group_vars_files

    - name: Load and validate group variables (YAML syntax only)
      ansible.builtin.shell: |
        python -c "import yaml; yaml.safe_load(open('{{ item.path }}'))" && echo "Valid YAML"
      register: group_vars_load
      loop: "{{ group_vars_files.files }}"
      failed_when: group_vars_load.rc != 0

    - name: Verify network validation playbook exists
      ansible.builtin.stat:
        path: "{{ ansible_content_dir }}/playbooks/network-validation.yml"
      register: network_val_playbook

    - name: Assert network validation playbook exists
      ansible.builtin.assert:
        that:
          - network_val_playbook.stat.exists
          - network_val_playbook.stat.size > 1000
        success_msg: "✓ Network validation playbook found and has content"
        fail_msg: "Network validation playbook missing or empty"

    - name: Test validation role integration
      ansible.builtin.shell: |
        find {{ ansible_content_dir }}/roles/network-validation/tasks -name "*.yml" | wc -l
      register: validation_tasks_count
      changed_when: false

    - name: Verify validation tasks exist
      ansible.builtin.assert:
        that:
          - validation_tasks_count.stdout | int >= 5
        fail_msg: "Insufficient validation tasks found"

    - name: Test validation workflow
      ansible.builtin.shell: |
        ansible-playbook --syntax-check {{ ansible_content_dir }}/playbooks/network-validation.yml -i /dev/null \
          --extra-vars "target_hosts=all validation_type=pre_upgrade multicast_enabled=true \
          bgp_enabled=true compare_with_baseline=false"
      register: validation_workflow_test
      failed_when: validation_workflow_test.rc != 0

    - name: Test rollback workflow
      ansible.builtin.shell: |
        ansible-playbook --syntax-check {{ ansible_content_dir }}/playbooks/emergency-rollback.yml -i /dev/null \
          --extra-vars "target_hosts=all restore_config=true restore_firmware=true \
          emergency_mode=false rollback_reason=test"
      register: rollback_workflow_test
      failed_when: rollback_workflow_test.rc != 0

    - name: Test batch operations workflow (if file exists)
      ansible.builtin.stat:
        path: "{{ ansible_content_dir }}/playbooks/batch-operations.yml"
      register: batch_operations_file

    - name: Validate batch operations playbook syntax
      ansible.builtin.shell: |
        ansible-playbook --syntax-check {{ ansible_content_dir }}/playbooks/batch-operations.yml -i /dev/null
      register: batch_workflow_test
      changed_when: false
      when: batch_operations_file.stat.exists
      failed_when: batch_operations_file.stat.exists and batch_workflow_test.rc != 0

    - name: Test metrics and logging integration
      ansible.builtin.shell: |
        grep -r "influxdb\|telegraf\|metrics" {{ ansible_content_dir }}/roles/common/tasks/
      register: metrics_integration
      changed_when: false
      failed_when: metrics_integration.rc not in [0, 1]  # 0 = found, 1 = not found (both acceptable)

    - name: Generate workflow integration test report
      ansible.builtin.debug:
        msg: |
          Workflow Integration Test Results:
          =================================

          Playbook Syntax Tests:
          - Main workflow: {{ 'PASS' if main_workflow_syntax.rc == 0 else 'FAIL' }}
          - Phase workflows: {{ phase_workflow_syntax.results | selectattr('rc', 'equalto', 0) | list | length }}/{{ phase_workflow_syntax.results | length }}
          - Network validation: {{ 'PASS' if validation_workflow_test.rc == 0 else 'FAIL' }}
          - Emergency rollback: {{ 'PASS' if rollback_workflow_test.rc == 0 else 'FAIL' }}

          AWX Integration:
          - Job templates: {{ job_templates.files | length }} files, {{ job_template_syntax.results | selectattr('rc', 'equalto', 0) | list | length }} valid
          - Workflow templates: {{ workflow_templates.files | length }} files, {{ workflow_template_syntax.results | selectattr('rc', 'equalto', 0) | list | length }} valid

          Role Integration:
          - Vendor roles referenced: {{ 'YES' if vendor_role_usage.stdout_lines | length > 0 else 'NO' }}
          - Validation tasks: {{ validation_tasks_count.stdout }} found

          Configuration:
          - Group variables: {{ group_vars_files.files | length }} files loaded successfully
          - Required variables: {{ workflow_variables.stdout_lines | length }} detected

          Overall Status: {{ 'PASS' if (main_workflow_syntax.rc == 0 and validation_workflow_test.rc == 0 and rollback_workflow_test.rc == 0) else 'ISSUES FOUND' }}

    - name: Fail if critical workflow tests fail
      ansible.builtin.fail:
        msg: "Critical workflow integration failures detected"
      when: >
        main_workflow_syntax.rc != 0 or
        validation_workflow_test.rc != 0 or
        rollback_workflow_test.rc != 0
