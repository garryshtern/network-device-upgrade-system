# Storage Cleanup Guide

This guide explains the automated cleanup workflows that manage repository storage by removing old container packages and workflow artifacts.

## Overview

The Network Device Upgrade System includes two automated cleanup workflows to manage storage costs and maintain repository performance:

- **Container Package Cleanup** (`cleanup-packages.yml`) - Manages Docker container images in GitHub Container Registry
- **Workflow Artifacts Cleanup** (`cleanup-artifacts.yml`) - Manages build artifacts from GitHub Actions runs

## Container Package Cleanup

### Purpose
Manages Docker container images in GitHub Container Registry (GHCR) to control storage costs and remove outdated development builds while preserving important releases.

### Automatic Schedule
- **Frequency**: Weekly on Sundays at 2:00 AM UTC
- **Trigger**: `schedule: '0 2 * * 0'`

### What Gets Deleted
- Untagged container images
- Development builds older than 7 days (configurable)
- Branch-specific builds (e.g., `main-abc123`)
- Pull request builds
- Temporary development versions

### What Gets Preserved
- ✅ **Semantic version releases** (v1.0.0, v2.1.3, etc.)
- ✅ **Latest tagged versions** (when `keep_latest=true`)
- ✅ **Main branch tagged versions** (when `keep_latest=true`)
- ✅ **Recent builds** (newer than `days_to_keep` setting)

### Configuration Options

| Parameter | Default | Description |
|-----------|---------|-------------|
| `keep_latest` | `true` | Preserve latest and main tagged versions |
| `days_to_keep` | `7` | Keep versions newer than X days (0 = ignore age) |
| `max_deletions` | `20` | Safety limit on versions deleted per run |
| `dry_run` | `false` | Preview deletions without removing packages |

### Manual Usage

```bash
# Preview what would be cleaned up
gh workflow run "Cleanup Container Packages" \
  -f confirm_deletion="DELETE" \
  -f dry_run=true

# Standard cleanup (keeps recent builds and releases)
gh workflow run "Cleanup Container Packages" \
  -f confirm_deletion="DELETE"

# Aggressive cleanup (older builds, keep only releases)
gh workflow run "Cleanup Container Packages" \
  -f confirm_deletion="DELETE" \
  -f days_to_keep="0" \
  -f keep_latest=false \
  -f max_deletions="50"
```

### Safety Features
- **Confirmation Required**: Must type "DELETE" for manual runs
- **Release Protection**: Never deletes semantic version releases
- **Deletion Limits**: Configurable maximum deletions per run
- **Dry-Run Mode**: Preview changes without making deletions
- **Age Protection**: Automatic retention of recent builds
- **Comprehensive Logging**: Detailed reports of what was deleted/kept

## Workflow Artifacts Cleanup

### Purpose
Removes build artifacts, test reports, SBOM files, and other temporary files generated by GitHub Actions workflows to free up artifact storage space.

### Automatic Schedule
- **Frequency**: Monthly on the 1st day at 3:00 AM UTC
- **Trigger**: `schedule: '0 3 1 * *'`

### What Gets Deleted
- ❌ **ALL workflow artifacts** (no selective retention)
- Build logs and test reports
- Security scan results (SBOM files)
- Performance test data
- Temporary build artifacts
- Coverage reports

### What Gets Preserved
- Nothing - this is a complete cleanup of all artifacts

### Configuration Options

| Parameter | Default | Description |
|-----------|---------|-------------|
| `max_artifacts` | `50` (scheduled) / `100` (manual) | Safety limit on artifacts deleted per run |

### Manual Usage

```bash
# Clean up all artifacts with confirmation
gh workflow run "Cleanup Artifacts" \
  -f confirm_deletion="DELETE"

# Clean up with higher limit
gh workflow run "Cleanup Artifacts" \
  -f confirm_deletion="DELETE" \
  -f max_artifacts="200"
```

### Safety Features
- **Confirmation Required**: Must type "DELETE" for manual runs
- **Deletion Limits**: Configurable maximum artifacts per run
- **Bulk Processing**: Efficient handling of large artifact lists
- **Progress Tracking**: Real-time deletion progress reporting

## Storage Management Strategy

### Automatic Maintenance Schedule

| Workflow | Frequency | Day | Time (UTC) | Purpose |
|----------|-----------|-----|------------|---------|
| Container Packages | Weekly | Sunday | 2:00 AM | Manage expensive container storage |
| Workflow Artifacts | Monthly | 1st | 3:00 AM | Clean temporary build files |

### When to Run Manual Cleanup

**Container Packages:**
- Before major releases (clean development builds)
- When container registry storage is approaching limits
- When investigating old builds or debugging
- Testing cleanup rules with dry-run mode

**Workflow Artifacts:**
- When approaching GitHub's 2GB artifact limit
- Before important builds that need storage space
- When debugging requires clean artifact space
- Quarterly maintenance cleanup

### Storage Cost Optimization

**High Priority (Run More Frequently):**
- Container Package Cleanup - Images are large and expensive

**Medium Priority (Run As Needed):**
- Workflow Artifacts Cleanup - Artifacts have built-in limits

### Monitoring and Alerts

Both workflows provide comprehensive summary reports including:
- Number of items deleted vs. kept
- Deletion criteria applied
- Safety limits enforced
- Any failures or warnings

Check workflow run summaries in GitHub Actions for cleanup reports.

## Troubleshooting

### Common Issues

**"No packages found"**
- Normal when no development builds exist
- Check if only release versions are present

**"Reached deletion limit"**
- Increase `max_deletions` parameter
- Run multiple times with conservative limits
- Use dry-run to preview larger cleanup

**"Confirmation failed"**
- Ensure you type "DELETE" exactly (case-sensitive)
- Required for all manual runs

**Artifacts still present after cleanup**
- Check artifact age (GitHub auto-deletes after 90 days)
- Verify workflow permissions
- Some artifacts may be locked by active workflows

### Best Practices

1. **Use Dry-Run First**: Always test container package cleanup with `dry_run=true`
2. **Conservative Limits**: Start with lower `max_deletions` values
3. **Monitor Storage**: Check GitHub billing for storage usage trends
4. **Preserve Releases**: Never modify settings that could delete release versions
5. **Document Changes**: Update this guide when modifying cleanup rules

## Security Considerations

- Both workflows require appropriate GitHub permissions
- Deletion actions are irreversible
- Automatic runs bypass manual confirmation for efficiency
- All actions are logged in GitHub Actions audit trail
- No sensitive data should be stored in artifacts long-term

---

For technical details about workflow implementation, see the workflow files:
- `.github/workflows/cleanup-packages.yml`
- `.github/workflows/cleanup-artifacts.yml`