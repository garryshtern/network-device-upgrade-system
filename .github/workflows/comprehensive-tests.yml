---
name: Comprehensive Test Suite

# Independent comprehensive test workflow
# Runs all 50+ test suites
# Can be triggered independently or on a schedule

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    description: 'Run comprehensive test suite manually'
  schedule:
    # Run comprehensive tests weekly on Sundays at 4:00 AM UTC
    - cron: '0 4 * * 0'

permissions:
  contents: write
  packages: write
  pull-requests: read

jobs:
  comprehensive-tests:
    name: Comprehensive Test Suite (50+ Tests)
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ansible Environment
        uses: ./.github/actions/setup-ansible
        with:
          python-version: '3.13.9'
          cache-key-suffix: 'comprehensive-tests'

      - name: Install additional test dependencies
        run: |
          pip install psutil

      - name: Create results directory
        run: mkdir -p tests/results

      - name: Run comprehensive test suite (All 50+ tests)
        run: |
          cd tests
          chmod +x run-all-tests.sh
          ./run-all-tests.sh
        timeout-minutes: 75

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: comprehensive-test-results-${{ github.run_number }}
          path: |
            tests/results/test_report_*.txt
            tests/results/*_*.log
          retention-days: 30

      - name: Parse and display test results
        if: always()
        run: |
          echo "════════════════════════════════════════════════════════"
          echo "Comprehensive Test Suite Results"
          echo "════════════════════════════════════════════════════════"

          if [ -f tests/results/test_report_*.txt ]; then
            cat tests/results/test_report_*.txt
          else
            echo "WARNING: No test report found"
          fi

      - name: Verify all tests passed
        run: |
          # Check if test report exists
          if ! ls tests/results/test_report_*.txt 1> /dev/null 2>&1; then
            echo "❌ FAILED: No test report file found"
            exit 1
          fi

          # Get the test report
          REPORT=$(cat tests/results/test_report_*.txt)

          # Check for success message
          if echo "$REPORT" | grep -q "All.*test.*passed"; then
            PASSED=$(echo "$REPORT" | grep -o "Passed: [0-9]*" | head -1 | cut -d' ' -f2)
            echo "✅ SUCCESS: All $PASSED test suites passed"
            exit 0
          fi

          # Check for failure indicators
          if echo "$REPORT" | grep -q "Failed: [1-9]"; then
            FAILED=$(echo "$REPORT" | grep -o "Failed: [1-9][0-9]*" | cut -d' ' -f2)
            PASSED=$(echo "$REPORT" | grep -o "Passed: [0-9]*" | cut -d' ' -f2)
            echo "❌ FAILED: $FAILED test suite(s) failed (Passed: $PASSED)"
            echo ""
            echo "Failed test details:"
            grep -A 5 "FAILED\|failed\|Failed" tests/results/test_report_*.txt || true
            exit 1
          fi

          echo "❌ FAILED: Could not determine test status"
          exit 1
