---
name: Comprehensive Test Suite

# Independent comprehensive test workflow
# Runs all 50+ test suites
# Can be triggered independently or on a schedule

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    description: 'Run comprehensive test suite manually'
  schedule:
    # Run comprehensive tests weekly on Sundays at 4:00 AM UTC
    - cron: '0 4 * * 0'

permissions:
  contents: write
  packages: write
  pull-requests: read

jobs:
  comprehensive-tests:
    name: Comprehensive Test Suite (50+ Tests)
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ansible Environment
        uses: ./.github/actions/setup-ansible
        with:
          python-version: '3.13.9'
          cache-key-suffix: 'comprehensive-tests'

      - name: Install additional test dependencies
        run: |
          pip install psutil

      - name: Create results directory
        run: mkdir -p tests/results

      - name: Run comprehensive test suite (All 50+ tests)
        run: |
          cd tests
          chmod +x run-all-tests.sh
          ./run-all-tests.sh
        timeout-minutes: 75

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: comprehensive-test-results-${{ github.run_number }}
          path: |
            tests/results/test_report_*.txt
            tests/results/*_*.log
          retention-days: 30

      - name: Parse and display test results
        if: always()
        run: |
          echo "════════════════════════════════════════════════════════"
          echo "Comprehensive Test Suite Results"
          echo "════════════════════════════════════════════════════════"

          if [ -f tests/results/test_report_*.txt ]; then
            cat tests/results/test_report_*.txt
          else
            echo "WARNING: No test report found"
          fi

      - name: Verify all tests passed
        run: |
          # Check if test report exists
          if ! ls tests/results/test_report_*.txt 1> /dev/null 2>&1; then
            echo "❌ FAILED: No test report file found"
            exit 1
          fi

          # Get the test report file (should be only one)
          REPORT_FILE=$(ls tests/results/test_report_*.txt | head -1)

          # Extract summary section from the top of the file (first 15 lines)
          # The summary is in the header: "- Passed: X" and "- Failed: Y"
          SUMMARY=$(head -15 "$REPORT_FILE")

          # Extract Passed and Failed from summary (without ANSI codes)
          PASSED=$(echo "$SUMMARY" | grep "^- Passed:" | awk '{print $NF}')
          FAILED=$(echo "$SUMMARY" | grep "^- Failed:" | awk '{print $NF}')

          echo "Test Results:"
          echo "  Passed: $PASSED"
          echo "  Failed: $FAILED"

          # Check if all tests passed
          if [ "$FAILED" = "0" ] && [ -n "$PASSED" ] && [ "$PASSED" -gt 0 ]; then
            echo "✅ SUCCESS: All $PASSED test suites passed"
            exit 0
          else
            echo "❌ FAILED: $FAILED test suite(s) failed (or test results could not be parsed)"
            exit 1
          fi
